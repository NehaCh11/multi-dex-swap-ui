"use strict";var t=require("@ethersproject/bignumber"),e=require("bignumber.js"),n=require("@ethersproject/address"),a=require("@ethersproject/constants"),r=require("@ethersproject/contracts");
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function o(t,e,n,a){return new(n||(n=Promise))((function(r,o){function i(t){try{u(a.next(t))}catch(t){o(t)}}function s(t){try{u(a.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,s)}u((a=a.apply(t,e||[])).next())}))}var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},s={};!function(t,e){var n=200,a="__lodash_hash_undefined__",r=9007199254740991,o="[object Arguments]",s="[object Boolean]",u="[object Date]",l="[object Function]",d="[object GeneratorFunction]",p="[object Map]",c="[object Number]",m="[object Object]",h="[object Promise]",I="[object RegExp]",f="[object Set]",T="[object String]",x="[object Symbol]",g="[object WeakMap]",w="[object ArrayBuffer]",y="[object DataView]",k="[object Float32Array]",b="[object Float64Array]",E="[object Int8Array]",S="[object Int16Array]",F="[object Int32Array]",O="[object Uint8Array]",B="[object Uint8ClampedArray]",v="[object Uint16Array]",P="[object Uint32Array]",_=/\w*$/,A=/^\[object .+?Constructor\]$/,N=/^(?:0|[1-9]\d*)$/,D={};D[o]=D["[object Array]"]=D[w]=D[y]=D[s]=D[u]=D[k]=D[b]=D[E]=D[S]=D[F]=D[p]=D[c]=D[m]=D[I]=D[f]=D[T]=D[x]=D[O]=D[B]=D[v]=D[P]=!0,D["[object Error]"]=D[l]=D[g]=!1;var W="object"==typeof i&&i&&i.Object===Object&&i,U="object"==typeof self&&self&&self.Object===Object&&self,L=W||U||Function("return this")(),M=e&&!e.nodeType&&e,R=M&&t&&!t.nodeType&&t,C=R&&R.exports===M;function G(t,e){return t.set(e[0],e[1]),t}function H(t,e){return t.add(e),t}function q(t,e,n,a){var r=-1,o=t?t.length:0;for(a&&o&&(n=t[++r]);++r<o;)n=e(n,t[r],r,t);return n}function Z(t){var e=!1;if(null!=t&&"function"!=typeof t.toString)try{e=!!(t+"")}catch(t){}return e}function X(t){var e=-1,n=Array(t.size);return t.forEach((function(t,a){n[++e]=[a,t]})),n}function $(t,e){return function(n){return t(e(n))}}function j(t){var e=-1,n=Array(t.size);return t.forEach((function(t){n[++e]=t})),n}var z,V=Array.prototype,Y=Function.prototype,K=Object.prototype,J=L["__core-js_shared__"],Q=(z=/[^.]+$/.exec(J&&J.keys&&J.keys.IE_PROTO||""))?"Symbol(src)_1."+z:"",tt=Y.toString,et=K.hasOwnProperty,nt=K.toString,at=RegExp("^"+tt.call(et).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),rt=C?L.Buffer:void 0,ot=L.Symbol,it=L.Uint8Array,st=$(Object.getPrototypeOf,Object),ut=Object.create,lt=K.propertyIsEnumerable,dt=V.splice,pt=Object.getOwnPropertySymbols,ct=rt?rt.isBuffer:void 0,mt=$(Object.keys,Object),ht=Rt(L,"DataView"),It=Rt(L,"Map"),ft=Rt(L,"Promise"),Tt=Rt(L,"Set"),xt=Rt(L,"WeakMap"),gt=Rt(Object,"create"),wt=Zt(ht),yt=Zt(It),kt=Zt(ft),bt=Zt(Tt),Et=Zt(xt),St=ot?ot.prototype:void 0,Ft=St?St.valueOf:void 0;function Ot(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var a=t[e];this.set(a[0],a[1])}}function Bt(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var a=t[e];this.set(a[0],a[1])}}function vt(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var a=t[e];this.set(a[0],a[1])}}function Pt(t){this.__data__=new Bt(t)}function _t(t,e){var n=$t(t)||function(t){return function(t){return function(t){return!!t&&"object"==typeof t}(t)&&jt(t)}(t)&&et.call(t,"callee")&&(!lt.call(t,"callee")||nt.call(t)==o)}(t)?function(t,e){for(var n=-1,a=Array(t);++n<t;)a[n]=e(n);return a}(t.length,String):[],a=n.length,r=!!a;for(var i in t)!e&&!et.call(t,i)||r&&("length"==i||Ht(i,a))||n.push(i);return n}function At(t,e,n){var a=t[e];et.call(t,e)&&Xt(a,n)&&(void 0!==n||e in t)||(t[e]=n)}function Nt(t,e){for(var n=t.length;n--;)if(Xt(t[n][0],e))return n;return-1}function Dt(t,e,n,a,r,i,h){var g;if(a&&(g=i?a(t,r,i,h):a(t)),void 0!==g)return g;if(!Yt(t))return t;var A=$t(t);if(A){if(g=function(t){var e=t.length,n=t.constructor(e);e&&"string"==typeof t[0]&&et.call(t,"index")&&(n.index=t.index,n.input=t.input);return n}(t),!e)return function(t,e){var n=-1,a=t.length;e||(e=Array(a));for(;++n<a;)e[n]=t[n];return e}(t,g)}else{var N=Gt(t),W=N==l||N==d;if(zt(t))return function(t,e){if(e)return t.slice();var n=new t.constructor(t.length);return t.copy(n),n}(t,e);if(N==m||N==o||W&&!i){if(Z(t))return i?t:{};if(g=function(t){return"function"!=typeof t.constructor||qt(t)?{}:(e=st(t),Yt(e)?ut(e):{});var e}(W?{}:t),!e)return function(t,e){return Lt(t,Ct(t),e)}(t,function(t,e){return t&&Lt(e,Kt(e),t)}(g,t))}else{if(!D[N])return i?t:{};g=function(t,e,n,a){var r=t.constructor;switch(e){case w:return Ut(t);case s:case u:return new r(+t);case y:return function(t,e){var n=e?Ut(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.byteLength)}(t,a);case k:case b:case E:case S:case F:case O:case B:case v:case P:return function(t,e){var n=e?Ut(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.length)}(t,a);case p:return function(t,e,n){var a=e?n(X(t),!0):X(t);return q(a,G,new t.constructor)}(t,a,n);case c:case T:return new r(t);case I:return function(t){var e=new t.constructor(t.source,_.exec(t));return e.lastIndex=t.lastIndex,e}(t);case f:return function(t,e,n){var a=e?n(j(t),!0):j(t);return q(a,H,new t.constructor)}(t,a,n);case x:return o=t,Ft?Object(Ft.call(o)):{}}var o}(t,N,Dt,e)}}h||(h=new Pt);var U=h.get(t);if(U)return U;if(h.set(t,g),!A)var L=n?function(t){return function(t,e,n){var a=e(t);return $t(t)?a:function(t,e){for(var n=-1,a=e.length,r=t.length;++n<a;)t[r+n]=e[n];return t}(a,n(t))}(t,Kt,Ct)}(t):Kt(t);return function(t,e){for(var n=-1,a=t?t.length:0;++n<a&&!1!==e(t[n],n,t););}(L||t,(function(r,o){L&&(r=t[o=r]),At(g,o,Dt(r,e,n,a,o,t,h))})),g}function Wt(t){return!(!Yt(t)||(e=t,Q&&Q in e))&&(Vt(t)||Z(t)?at:A).test(Zt(t));var e}function Ut(t){var e=new t.constructor(t.byteLength);return new it(e).set(new it(t)),e}function Lt(t,e,n,a){n||(n={});for(var r=-1,o=e.length;++r<o;){var i=e[r],s=a?a(n[i],t[i],i,n,t):void 0;At(n,i,void 0===s?t[i]:s)}return n}function Mt(t,e){var n,a,r=t.__data__;return("string"==(a=typeof(n=e))||"number"==a||"symbol"==a||"boolean"==a?"__proto__"!==n:null===n)?r["string"==typeof e?"string":"hash"]:r.map}function Rt(t,e){var n=function(t,e){return null==t?void 0:t[e]}(t,e);return Wt(n)?n:void 0}Ot.prototype.clear=function(){this.__data__=gt?gt(null):{}},Ot.prototype.delete=function(t){return this.has(t)&&delete this.__data__[t]},Ot.prototype.get=function(t){var e=this.__data__;if(gt){var n=e[t];return n===a?void 0:n}return et.call(e,t)?e[t]:void 0},Ot.prototype.has=function(t){var e=this.__data__;return gt?void 0!==e[t]:et.call(e,t)},Ot.prototype.set=function(t,e){return this.__data__[t]=gt&&void 0===e?a:e,this},Bt.prototype.clear=function(){this.__data__=[]},Bt.prototype.delete=function(t){var e=this.__data__,n=Nt(e,t);return!(n<0)&&(n==e.length-1?e.pop():dt.call(e,n,1),!0)},Bt.prototype.get=function(t){var e=this.__data__,n=Nt(e,t);return n<0?void 0:e[n][1]},Bt.prototype.has=function(t){return Nt(this.__data__,t)>-1},Bt.prototype.set=function(t,e){var n=this.__data__,a=Nt(n,t);return a<0?n.push([t,e]):n[a][1]=e,this},vt.prototype.clear=function(){this.__data__={hash:new Ot,map:new(It||Bt),string:new Ot}},vt.prototype.delete=function(t){return Mt(this,t).delete(t)},vt.prototype.get=function(t){return Mt(this,t).get(t)},vt.prototype.has=function(t){return Mt(this,t).has(t)},vt.prototype.set=function(t,e){return Mt(this,t).set(t,e),this},Pt.prototype.clear=function(){this.__data__=new Bt},Pt.prototype.delete=function(t){return this.__data__.delete(t)},Pt.prototype.get=function(t){return this.__data__.get(t)},Pt.prototype.has=function(t){return this.__data__.has(t)},Pt.prototype.set=function(t,e){var a=this.__data__;if(a instanceof Bt){var r=a.__data__;if(!It||r.length<n-1)return r.push([t,e]),this;a=this.__data__=new vt(r)}return a.set(t,e),this};var Ct=pt?$(pt,Object):function(){return[]},Gt=function(t){return nt.call(t)};function Ht(t,e){return!!(e=null==e?r:e)&&("number"==typeof t||N.test(t))&&t>-1&&t%1==0&&t<e}function qt(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||K)}function Zt(t){if(null!=t){try{return tt.call(t)}catch(t){}try{return t+""}catch(t){}}return""}function Xt(t,e){return t===e||t!=t&&e!=e}(ht&&Gt(new ht(new ArrayBuffer(1)))!=y||It&&Gt(new It)!=p||ft&&Gt(ft.resolve())!=h||Tt&&Gt(new Tt)!=f||xt&&Gt(new xt)!=g)&&(Gt=function(t){var e=nt.call(t),n=e==m?t.constructor:void 0,a=n?Zt(n):void 0;if(a)switch(a){case wt:return y;case yt:return p;case kt:return h;case bt:return f;case Et:return g}return e});var $t=Array.isArray;function jt(t){return null!=t&&function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=r}(t.length)&&!Vt(t)}var zt=ct||function(){return!1};function Vt(t){var e=Yt(t)?nt.call(t):"";return e==l||e==d}function Yt(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function Kt(t){return jt(t)?_t(t):function(t){if(!qt(t))return mt(t);var e=[];for(var n in Object(t))et.call(t,n)&&"constructor"!=n&&e.push(n);return e}(t)}t.exports=function(t){return Dt(t,!0,!0)}}({get exports(){return s},set exports(t){s=t}},s),e.BigNumber.config({EXPONENTIAL_AT:[-100,100],ROUNDING_MODE:1,DECIMAL_PLACES:18});const u=c(0),l=c(1),d=c("Infinity");function p(t,n){const a=new e.BigNumber(n.toString()),r=new e.BigNumber(10).pow(a);return t.times(r)}function c(t){return new e.BigNumber(t.toString())}const m=BigInt(0),h=BigInt(1),I=BigInt("1000000000000000000"),f=(t,e)=>{if(!t)throw new Error(e)};function T(t){const e=BigInt(18)-t;return I*BigInt(10)**e}class x{static add(t,e){const n=t+e;return f(e>=0&&n>=t||e<0&&n<t,"Errors.ADD_OVERFLOW"),n}static sub(t,e){f(e<=t,"Errors.SUB_OVERFLOW");return t-e}static max(t,e){return t>=e?t:e}static min(t,e){return t<e?t:e}static mul(t,e){const n=t*e;return f(t==m||n/t==e,"Errors.MUL_OVERFLOW"),n}static div(t,e,n){return n?this.divUp(t,e):this.divDown(t,e)}static divDown(t,e){return f(e!=m,"Errors.ZERO_DIVISION"),t/e}static divUp(t,e){return f(e!=m,"Errors.ZERO_DIVISION"),t==m?m:h+(t-h)/e}static mulUpFixed(t,e){const n=t*e;return f(t==m||n/t==e,"Errors.MUL_OVERFLOW"),n==m?m:(n-h)/this.ONE+h}static divDownFixed(t,e){if(f(e!=m,"Errors.ZERO_DIVISION"),t==m)return m;return t*this.ONE/e}static divUpFixed(t,e){if(f(e!=m,"Errors.ZERO_DIVISION"),t==m)return m;{const n=t*this.ONE;return f(n/t==this.ONE,"Errors.DIV_INTERNAL"),(n-h)/e+h}}static powUpFixed(t,e){const n=g.pow(t,e),a=this.add(this.mulUpFixed(n,this.MAX_POW_RELATIVE_ERROR),h);return this.add(n,a)}static powDown(t,e){const n=g.pow(t,e),a=this.add(this.mulUpFixed(n,this.MAX_POW_RELATIVE_ERROR),h);return this.sub(n,a)}static complementFixed(t){return t<this.ONE?this.ONE-t:m}static mulDownFixed(t,e){const n=t*e;return f(t==m||n/t==e,"Errors.MUL_OVERFLOW"),n/this.ONE}}x.ONE=BigInt("1000000000000000000"),x.MAX_POW_RELATIVE_ERROR=BigInt(1e4);class g{static pow(t,e){if(e===m)return this.ONE_18;if(t==m)return m;f(t<BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819968"),"Errors.X_OUT_OF_BOUNDS");const n=t;f(e<this.MILD_EXPONENT_BOUND,"Errors.Y_OUT_OF_BOUNDS");const a=e;let r;if(this.LN_36_LOWER_BOUND<n&&n<this.LN_36_UPPER_BOUND){const t=this._ln_36(n);r=t/this.ONE_18*a+t%this.ONE_18*a/this.ONE_18}else r=this._ln(n)*a;return r/=this.ONE_18,f(this.MIN_NATURAL_EXPONENT<=r&&r<=this.MAX_NATURAL_EXPONENT,"Errors.PRODUCT_OUT_OF_BOUNDS"),this.exp(r)}static exp(t){if(f(t>=this.MIN_NATURAL_EXPONENT&&t<=this.MAX_NATURAL_EXPONENT,"Errors.INVALID_EXPONENT"),t<0)return this.ONE_18*this.ONE_18/this.exp(BigInt(-1)*t);let e;t>=this.x0?(t-=this.x0,e=this.a0):t>=this.x1?(t-=this.x1,e=this.a1):e=BigInt(1),t*=BigInt(100);let n=this.ONE_20;t>=this.x2&&(t-=this.x2,n=n*this.a2/this.ONE_20),t>=this.x3&&(t-=this.x3,n=n*this.a3/this.ONE_20),t>=this.x4&&(t-=this.x4,n=n*this.a4/this.ONE_20),t>=this.x5&&(t-=this.x5,n=n*this.a5/this.ONE_20),t>=this.x6&&(t-=this.x6,n=n*this.a6/this.ONE_20),t>=this.x7&&(t-=this.x7,n=n*this.a7/this.ONE_20),t>=this.x8&&(t-=this.x8,n=n*this.a8/this.ONE_20),t>=this.x9&&(t-=this.x9,n=n*this.a9/this.ONE_20);let a,r=this.ONE_20;return a=t,r+=a,a=a*t/this.ONE_20/BigInt(2),r+=a,a=a*t/this.ONE_20/BigInt(3),r+=a,a=a*t/this.ONE_20/BigInt(4),r+=a,a=a*t/this.ONE_20/BigInt(5),r+=a,a=a*t/this.ONE_20/BigInt(6),r+=a,a=a*t/this.ONE_20/BigInt(7),r+=a,a=a*t/this.ONE_20/BigInt(8),r+=a,a=a*t/this.ONE_20/BigInt(9),r+=a,a=a*t/this.ONE_20/BigInt(10),r+=a,a=a*t/this.ONE_20/BigInt(11),r+=a,a=a*t/this.ONE_20/BigInt(12),r+=a,n*r/this.ONE_20*e/BigInt(100)}static _ln_36(t){const e=((t*=this.ONE_18)-this.ONE_36)*this.ONE_36/(t+this.ONE_36),n=e*e/this.ONE_36;let a=e,r=a;return a=a*n/this.ONE_36,r+=a/BigInt(3),a=a*n/this.ONE_36,r+=a/BigInt(5),a=a*n/this.ONE_36,r+=a/BigInt(7),a=a*n/this.ONE_36,r+=a/BigInt(9),a=a*n/this.ONE_36,r+=a/BigInt(11),a=a*n/this.ONE_36,r+=a/BigInt(13),a=a*n/this.ONE_36,r+=a/BigInt(15),r*BigInt(2)}static _ln(t){if(t<this.ONE_18)return BigInt(-1)*this._ln(this.ONE_18*this.ONE_18/t);let e=m;t>=this.a0*this.ONE_18&&(t/=this.a0,e+=this.x0),t>=this.a1*this.ONE_18&&(t/=this.a1,e+=this.x1),e*=BigInt(100),(t*=BigInt(100))>=this.a2&&(t=t*this.ONE_20/this.a2,e+=this.x2),t>=this.a3&&(t=t*this.ONE_20/this.a3,e+=this.x3),t>=this.a4&&(t=t*this.ONE_20/this.a4,e+=this.x4),t>=this.a5&&(t=t*this.ONE_20/this.a5,e+=this.x5),t>=this.a6&&(t=t*this.ONE_20/this.a6,e+=this.x6),t>=this.a7&&(t=t*this.ONE_20/this.a7,e+=this.x7),t>=this.a8&&(t=t*this.ONE_20/this.a8,e+=this.x8),t>=this.a9&&(t=t*this.ONE_20/this.a9,e+=this.x9),t>=this.a10&&(t=t*this.ONE_20/this.a10,e+=this.x10),t>=this.a11&&(t=t*this.ONE_20/this.a11,e+=this.x11);const n=(t-this.ONE_20)*this.ONE_20/(t+this.ONE_20),a=n*n/this.ONE_20;let r=n,o=r;return r=r*a/this.ONE_20,o+=r/BigInt(3),r=r*a/this.ONE_20,o+=r/BigInt(5),r=r*a/this.ONE_20,o+=r/BigInt(7),r=r*a/this.ONE_20,o+=r/BigInt(9),r=r*a/this.ONE_20,o+=r/BigInt(11),o*=BigInt(2),(e+o)/BigInt(100)}}g.ONE_18=BigInt("1000000000000000000"),g.ONE_20=BigInt("100000000000000000000"),g.ONE_36=BigInt("1000000000000000000000000000000000000"),g.MAX_NATURAL_EXPONENT=BigInt("130000000000000000000"),g.MIN_NATURAL_EXPONENT=BigInt("-41000000000000000000"),g.LN_36_LOWER_BOUND=BigInt(g.ONE_18)-BigInt("100000000000000000"),g.LN_36_UPPER_BOUND=BigInt(g.ONE_18)+BigInt("100000000000000000"),g.MILD_EXPONENT_BOUND=BigInt(2)**BigInt(254)/g.ONE_20,g.x0=BigInt("128000000000000000000"),g.a0=BigInt("38877084059945950922200000000000000000000000000000000000"),g.x1=BigInt("64000000000000000000"),g.a1=BigInt("6235149080811616882910000000"),g.x2=BigInt("3200000000000000000000"),g.a2=BigInt("7896296018268069516100000000000000"),g.x3=BigInt("1600000000000000000000"),g.a3=BigInt("888611052050787263676000000"),g.x4=BigInt("800000000000000000000"),g.a4=BigInt("298095798704172827474000"),g.x5=BigInt("400000000000000000000"),g.a5=BigInt("5459815003314423907810"),g.x6=BigInt("200000000000000000000"),g.a6=BigInt("738905609893065022723"),g.x7=BigInt("100000000000000000000"),g.a7=BigInt("271828182845904523536"),g.x8=BigInt("50000000000000000000"),g.a8=BigInt("164872127070012814685"),g.x9=BigInt("25000000000000000000"),g.a9=BigInt("128402541668774148407"),g.x10=BigInt("12500000000000000000"),g.a10=BigInt("113314845306682631683"),g.x11=BigInt("6250000000000000000"),g.a11=BigInt("106449445891785942956");const w=(t,e)=>n.getAddress(t)===n.getAddress(e);function y(e,n=0){const[a,r]=e.split(".");if(!r)return t.parseFixed(e,n);const o=a+"."+r.slice(0,n);return t.parseFixed(o,n)}const k=e=>{var n;return t.parseFixed(e.balance,18).mul(t.parseFixed(null!==(n=e.priceRate)&&void 0!==n?n:"1",18)).div(a.WeiPerEther).toBigInt()},b=(e,n)=>{var r;const o=T(BigInt(n.decimals));return t.BigNumber.from(function(t,e){return x.mulDownFixed(t,e)}(e,o).toString()).mul(t.parseFixed(null!==(r=n.priceRate)&&void 0!==r?r:"1",18)).div(a.WeiPerEther).toBigInt()},E=(e,n)=>{var a;return function(t,e){return x.divDownFixed(t,e)}(e*I/BigInt(t.parseFixed(null!==(a=n.priceRate)&&void 0!==a?a:"1",18).toString()),T(BigInt(n.decimals)))};var S,F,O;exports.SwapTypes=void 0,(S=exports.SwapTypes||(exports.SwapTypes={}))[S.SwapExactIn=0]="SwapExactIn",S[S.SwapExactOut=1]="SwapExactOut",exports.PoolTypes=void 0,(F=exports.PoolTypes||(exports.PoolTypes={}))[F.Weighted=0]="Weighted",F[F.Stable=1]="Stable",F[F.Element=2]="Element",F[F.MetaStable=3]="MetaStable",F[F.Linear=4]="Linear",F[F.Gyro2=5]="Gyro2",F[F.Gyro3=6]="Gyro3",F[F.GyroE=7]="GyroE",F[F.Fx=8]="Fx",exports.PoolFilter=void 0,(O=exports.PoolFilter||(exports.PoolFilter={})).All="All",O.Weighted="Weighted",O.Stable="Stable",O.MetaStable="MetaStable",O.LiquidityBootstrapping="LiquidityBootstrapping",O.Investment="Investment",O.Element="Element",O.StablePhantom="StablePhantom",O.ComposableStable="ComposableStable",O.Gyro2="Gyro2",O.Gyro3="Gyro3",O.GyroE="GyroE",O.AaveLinear="AaveLinear",O.Linear="Linear",O.EulerLinear="EulerLinear",O.ERC4626Linear="ERC4626Linear",O.BeefyLinear="BeefyLinear",O.GearboxLinear="GearboxLinear",O.MidasLinear="MidasLinear",O.ReaperLinear="ReaperLinear",O.SiloLinear="SiloLinear",O.TetuLinear="TetuLinear",O.YearnLinear="YearnLinear";const B=BigInt("3000000000000000000");function v(t,e,n,a,r,o){r=function(t,e){const n=x.mulUpFixed(t,e);return t-n}(r,o);const i=x.divDownFixed(e,a),s=x.add(t,r),u=x.divUpFixed(t,s),l=x.powUpFixed(u,i);return x.mulDownFixed(n,x.complementFixed(l))}function P(t,e,n,a,r,o){const i=x.divUpFixed(n,n-r),s=x.divUpFixed(a,e),u=x.powUpFixed(i,s),l=x.sub(u,x.ONE);return function(t,e){return x.divUpFixed(t,x.complementFixed(e))}(x.mulUpFixed(t,l),o)}function _(t,e,n,a,r){const o=new Array(n.length);let i=m;for(let a=0;a<t.length;a++)o[a]=x.divDownFixed(x.add(t[a],n[a]),t[a]),i=x.add(i,x.mulDownFixed(o[a],e[a]));let s=x.ONE;for(let a=0;a<t.length;a++){let u;if(o[a]>i){const e=x.mulDownFixed(t[a],x.sub(i,x.ONE)),o=x.sub(n[a],e),s=x.mulUpFixed(o,r);u=x.add(e,x.sub(o,s))}else u=n[a];const l=x.divDownFixed(x.add(t[a],u),t[a]);s=x.mulDownFixed(s,x.powDown(l,e[a]))}return s>x.ONE?x.mulDownFixed(a,x.sub(s,x.ONE)):m}function A(t,e,n){const a=x.divDownFixed(e,n),r=new Array(t.length);for(let e=0;e<t.length;e++)r[e]=x.mulDownFixed(t[e],a);return r}function N(t,e,n,a,r){const o=x.divUpFixed(x.sub(a,n),a),i=x.powUpFixed(o,x.divDownFixed(x.ONE,e)),s=x.mulDownFixed(t,x.complementFixed(i)),u=x.mulUpFixed(s,x.complementFixed(e)),l=x.sub(s,u),d=x.mulUpFixed(u,r);return x.add(l,x.sub(u,d))}function D(t,e,n,a,r){const o=new Array(n.length);let i=m;for(let a=0;a<t.length;a++)o[a]=x.divUpFixed(x.sub(t[a],n[a]),t[a]),i=x.add(i,x.mulUpFixed(o[a],e[a]));const s=function(t,e,n,a,r,o){let i=x.ONE;for(let s=0;s<t.length;s++){let u;if(r>a[s]){const e=x.mulDownFixed(t[s],x.complementFixed(r)),a=x.sub(n[s],e),i=x.divUpFixed(a,x.complementFixed(o));u=x.add(e,i)}else u=n[s];const l=x.divDownFixed(x.sub(t[s],u),t[s]);i=x.mulDownFixed(i,x.powDown(l,e[s]))}return i}(t,e,n,o,i,r);return x.mulUpFixed(a,x.complementFixed(s))}const W=(t,e,n,a,r)=>{const o=x.divUpFixed(x.add(a,n),a);if(o>B)throw new Error("MAX_OUT_BPT_FOR_TOKEN_IN");const i=x.powUpFixed(o,x.divUpFixed(x.ONE,e)),s=x.mulUpFixed(t,x.sub(i,x.ONE)),u=x.complementFixed(e),l=x.mulUpFixed(s,u),d=x.sub(s,l);return x.add(d,x.divUpFixed(l,x.complementFixed(r)))};function U(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=parseFloat(t.formatFixed(n.weightOut,18)),s=e.toNumber(),u=parseFloat(t.formatFixed(n.swapFee,18));return c(-a*i/(r*(-1+u)*(a/(s+a-s*u))**((o+i)/i)*o))}function L(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=parseFloat(t.formatFixed(n.weightOut,18));return c(-a*(r/(-e.toNumber()+r))**((o+i)/o)*i/(r*(-1+parseFloat(t.formatFixed(n.swapFee,18)))*o))}function M(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=e.toNumber(),s=parseFloat(t.formatFixed(n.swapFee,18));return c(a*((i+a+i*s*(-1+o))/a)**(1-o)/(r*(1+s*(-1+o))*o))}function R(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightOut,18));return c((1-e.toNumber()/a)**((-1+o)/o)*a*(1+parseFloat(t.formatFixed(n.swapFee))*(-1+o))*o/r)}function C(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,18)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightOut,18)),i=e.toNumber(),s=parseFloat(t.formatFixed(n.swapFee,18));return c(a*(1+s*(-1+o))*o*(1+i*(-1+s-s*o)/r)**(-1+o)/r)}function G(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,18)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=e.toNumber();return c(((i+r)/r)**(1/o)*a/((i+r)*(1+parseFloat(t.formatFixed(n.swapFee,18))*(-1+o))*o))}function H(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=parseFloat(t.formatFixed(n.weightOut,18)),s=e.toNumber();return c((o+i)/(r*(a/(s+a-s*parseFloat(t.formatFixed(n.swapFee,18))))**(o/i)*o))}function q(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=parseFloat(t.formatFixed(n.weightOut,18)),s=e.toNumber();return c(-a*(r/(-s+r))**(i/o)*i*(o+i)/((s-r)**2*(-1+parseFloat(t.formatFixed(n.swapFee,18)))*o**2))}function Z(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut,18)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=e.toNumber();return c(-(-1+o)/(r*((i+a+i*parseFloat(t.formatFixed(n.swapFee,18))*(-1+o))/a)**o*o))}function X(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,18)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightOut,18)),i=e.toNumber();return c(-(1+parseFloat(t.formatFixed(n.swapFee,18))*(-1+o))*(-1+o)/((1-i/a)**(1/o)*r))}var $,j=Object.freeze({__proto__:null,_calcBptInGivenExactTokensOut:D,_calcBptOutGivenExactTokensIn:_,_calcDueProtocolSwapFeeBptAmount:function(t,e,n,a){const r=x.divDownFixed(n,e);if(r<=x.ONE)return m;const o=x.divDownFixed(x.mulDownFixed(a,r-x.ONE),r),i=x.mulDownFixed(t,o),s=x.complementFixed(o);return s==m?m:x.divDownFixed(i,s)},_calcInGivenOut:P,_calcOutGivenIn:v,_calcTokenInGivenExactBptOut:W,_calcTokenOutGivenExactBptIn:N,_calcTokensOutGivenExactBptIn:A,_calculateInvariant:function(t,e){let n=x.ONE;for(let a=0;a<t.length;a++)n=x.mulDownFixed(n,x.powDown(e[a],t[a]));if(n<0)throw Error("Weighted Invariant < 0");return n},_derivativeSpotPriceAfterSwapBPTInForExactTokenOut:function(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,18)),r=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),o=parseFloat(t.formatFixed(n.weightOut)),i=e.toNumber(),s=parseFloat(t.formatFixed(n.swapFee));return c(-a*(1+s*(-1+o))**2*(-1+o)*o*(1+i*(-1+s-s*o)/r)**(-2+o)/r**2)},_derivativeSpotPriceAfterSwapExactBPTInForTokenOut:X,_derivativeSpotPriceAfterSwapExactTokenInForBPTOut:Z,_derivativeSpotPriceAfterSwapExactTokenInForTokenOut:H,_derivativeSpotPriceAfterSwapTokenInForExactBPTOut:function(e,n){const a=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),r=parseFloat(t.formatFixed(n.balanceOut.toNumber(),18)),o=parseFloat(t.formatFixed(n.weightIn,18)),i=e.toNumber();return c(-(((i+r)/r)**(1/o))*a*(-1+o)/((i+r)**2*(1+parseFloat(t.formatFixed(n.swapFee,18))*(-1+o))*o**2))},_derivativeSpotPriceAfterSwapTokenInForExactTokenOut:q,_spotPriceAfterSwapBPTInForExactTokenOut:C,_spotPriceAfterSwapBptOutGivenExactTokenInBigInt:function(t,e,n,a,r){const o=x.ONE-x.mulDownFixed(x.complementFixed(n),r),i=x.powDown(x.ONE+a*o/t,x.complementFixed(n));return x.divDownFixed(x.ONE,e*n*o/(t*i))},_spotPriceAfterSwapExactBPTInForTokenOut:R,_spotPriceAfterSwapExactTokenInForBPTOut:M,_spotPriceAfterSwapExactTokenInForTokenOut:U,_spotPriceAfterSwapExactTokenInForTokenOutBigInt:function(t,e,n,a,r,o){const i=x.mulUpFixed(t,a);let s=x.mulUpFixed(n,e);const u=x.complementFixed(o);s=x.mulUpFixed(s,u);const l=x.divUpFixed(t,x.add(x.mulUpFixed(r,u),t)),d=x.divUpFixed(e+a,a);return s=x.mulUpFixed(s,x.powUpFixed(l,d)),x.divUpFixed(i,s)},_spotPriceAfterSwapTokenInForExactBPTOut:G,_spotPriceAfterSwapTokenInForExactTokenOut:L,_spotPriceAfterSwapTokenInForExactTokenOutBigInt:function(t,e,n,a,r,o){let i=x.mulUpFixed(t,a);const s=x.complementFixed(o),u=x.divUpFixed(n,x.sub(n,r)),l=x.divUpFixed(e+a,e);i=x.mulUpFixed(i,x.powUpFixed(u,l));const d=x.mulUpFixed(x.mulUpFixed(n,e),s);return x.divUpFixed(i,d)}});function z(t){const e=c(1).div(t);return e.isNaN()||e.lt(u)||!e.isFinite()?u:e}!function(t){t[t.BptToToken=0]="BptToToken",t[t.TokenToBpt=1]="TokenToBpt",t[t.TokenToToken=2]="TokenToToken"}($||($={}));class V{static fromPool(t,e){if(!t.totalWeight)throw new Error("WeightedPool missing totalWeight");const n=new V(t.id,t.address,t.swapFee,t.totalWeight,t.totalShares,t.tokens,t.tokensList);return e&&(n.isLBP=!0),n}constructor(e,n,a,r,o,i,s){this.poolType=exports.PoolTypes.Weighted,this.MAX_IN_RATIO=t.parseFixed("0.3",18),this.MAX_OUT_RATIO=t.parseFixed("0.3",18),this.isLBP=!1,this.id=e,this.address=n,this.swapFee=t.parseFixed(a,18),this.totalShares=t.parseFixed(o,18),this.tokens=i,this.tokensList=s,this.totalWeight=t.parseFixed(r,18)}parsePoolPairData(e,r){const o=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(o<0)throw"Pool does not contain tokenIn";const i=this.tokens[o],s=i.balance,u=i.decimals,l=t.parseFixed(i.weight,18).mul(a.WeiPerEther).div(this.totalWeight),d=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(r)));if(d<0)throw"Pool does not contain tokenOut";const p=this.tokens[d],c=p.balance,m=p.decimals,h=t.parseFixed(p.weight,18).mul(a.WeiPerEther).div(this.totalWeight);let I;I=e==this.address?$.BptToToken:r==this.address?$.TokenToBpt:$.TokenToToken;return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:e,tokenOut:r,decimalsIn:Number(u),decimalsOut:Number(m),balanceIn:t.parseFixed(s,u),balanceOut:t.parseFixed(c,m),pairType:I,weightIn:l,weightOut:h,swapFee:this.swapFee}}getNormalizedWeights(){return this.tokens.map((e=>t.parseFixed(e.weight,18).mul(a.WeiPerEther).div(this.totalWeight).toBigInt()))}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){return n===exports.SwapTypes.SwapExactIn?c(t.formatFixed(e.balanceIn.mul(this.MAX_IN_RATIO).div(a.WeiPerEther),e.decimalsIn)):c(t.formatFixed(e.balanceOut.mul(this.MAX_OUT_RATIO).div(a.WeiPerEther),e.decimalsOut))}updateTokenBalanceForPool(e,n){w(this.address,e)&&this.updateTotalShares(n);const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){if(n.isNaN())return n;const a=t.parseFixed(n.dp(18,1).toString(),18).toBigInt(),r=e.decimalsIn,o=e.decimalsOut,i=t.parseFixed(e.balanceIn.toString(),18-r).toBigInt(),s=t.parseFixed(e.balanceOut.toString(),18-o).toBigInt(),l=e.weightIn.toBigInt(),d=e.weightOut.toBigInt(),m=e.swapFee.toBigInt();let h;try{return h=e.pairType===$.TokenToBpt?_([i,BigInt(1)],[l,x.ONE-l],[a,BigInt(0)],s,m):e.pairType===$.BptToToken?N(s,d,a,i,m):v(i,l,s,d,a,m),p(c(h.toString()),-18)}catch(t){return u}}_tokenInForExactTokenOut(e,n){if(n.isNaN())return n;const a=t.parseFixed(n.dp(18,1).toString(),18).toBigInt(),r=e.decimalsIn,o=e.decimalsOut,i=t.parseFixed(e.balanceIn.toString(),18-r).toBigInt(),s=t.parseFixed(e.balanceOut.toString(),18-o).toBigInt(),l=e.weightIn.toBigInt(),d=e.weightOut.toBigInt(),m=e.swapFee.toBigInt();let h;try{return h=e.pairType===$.TokenToBpt?W(i,l,a,s,m):e.pairType===$.BptToToken?D([s,BigInt(1)],[d,x.ONE-d],[a,BigInt(0)],i,m):P(i,l,s,d,a,m),p(c(h.toString()),-18)}catch(t){return u}}_calcTokensOutGivenExactBptIn(e){const n=this.tokens.filter((t=>!w(t.address,this.address))).map((t=>k(t)));try{const a=A(n,e.toBigInt(),this.totalShares.toBigInt());return a.map(((t,e)=>E(t,this.tokens[e]))).map((e=>t.BigNumber.from(e)))}catch(t){return new Array(n.length).fill(u)}}_calcBptOutGivenExactTokensIn(e){try{const n=new Array(e.length).fill(BigInt(0)),a=new Array(e.length).fill(BigInt(0));this.tokens.filter((t=>!w(t.address,this.address))).forEach(((t,r)=>{n[r]=b(BigInt(e[r].toString()),t),a[r]=k(t)}));const r=_(a,this.getNormalizedWeights(),n,this.totalShares.toBigInt(),this.swapFee.toBigInt());return t.BigNumber.from(r.toString())}catch(t){return a.Zero}}_spotPriceAfterSwapExactTokenInForTokenOut(t,e){return t.pairType===$.TokenToBpt?M(e,t):t.pairType===$.BptToToken?R(e,t):U(e,t)}_spotPriceAfterSwapTokenInForExactTokenOut(t,e){return t.pairType===$.TokenToBpt?G(e,t):t.pairType===$.BptToToken?C(e,t):L(e,t)}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,e){return t.pairType===$.TokenToBpt?Z(e,t):t.pairType===$.BptToToken?X(e,t):H(e,t)}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(t,e){return q(e,t)}}function Y(e,n){let a=u;const r=n.length;for(let t=0;t<r;t++)a=a.plus(n[t]);if(a.isZero())return u;let o=u,i=a;const s=c(t.formatFixed(e,3)).times(r**r);for(let t=0;t<255;t++){let t=c(r).times(n[0]);for(let e=1;e<r;e++)t=t.times(n[e]).times(r).div(i);if(o=i,i=c(r).times(i).times(i).plus(s.times(a).times(t)).div(c(r+1).times(i).plus(s.minus(1).times(t))),i.gt(o)){if(i.minus(o).lt(c(1e-18)))break}else if(o.minus(i).lt(c(1e-18)))break}return i}function K(t,e){if(t.isZero())return t;const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,d=[...r],p=d.length,m=n.div(p**(p-1));let h=t;h=h.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString());const I=Y(m,d);let f=I,T=u;const x=c(d.length);let g=l,w=u;for(let t=0;t<d.length;t++){if(g=g.times(x),t==o)w=d[t].plus(h);else{if(t==i)continue;w=d[t]}T=T.plus(w),f=f.times(I).div(w)}const y=Q(T,I,m,g,f);return d[i].minus(y)}function J(t,e){if(t.isZero())return t;const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,d=[...r],p=d.length,m=n.div(p**(p-1)),h=t,I=Y(m,d);let f=I,T=u;const x=c(d.length);let g=l,w=u;for(let t=0;t<d.length;t++){if(g=g.times(x),t==i)w=d[t].minus(h);else{if(t==o)continue;w=d[t]}T=T.plus(w),f=f.times(I).div(w)}return Q(T,I,m,g,f).minus(d[o]).multipliedBy(a.WeiPerEther.toString()).div(a.WeiPerEther.sub(s).toString())}function Q(e,n,a,r,o){const i=c(t.formatFixed(a,3));o=o.times(n).div(i.times(r).times(r));const s=e.plus(n.div(i.times(r)));return n.minus(s).plus(n.minus(s).times(n.minus(s)).plus(o.times(4)).sqrt()).div(2)}function tt(e,n,a,r,o,i){const s=n.length,l=Y(e,n);let d=u;for(let t=0;t<s;t++)t!=a&&t!=r&&(d=d.plus(n[t]));const p=n[a],m=n[r],h=c(t.formatFixed(e,3)).times(s**s),I=d.minus(l).times(h).plus(l),f=c(2).times(h).times(p).times(m),T=f.plus(h.times(m).times(m)).plus(I.times(m)),x=f.plus(h.times(p).times(p)).plus(I.times(p));let g;if(o)g=T.div(x);else{const t=c(2).times(h).times(m),e=c(2).times(h).times(p),n=t.plus(e).plus(I),a=c(2).times(T).times(x).times(n).minus(t.times(x.pow(2))).minus(e.times(T.pow(2))),r=T.pow(2).times(x);g=a.div(r),i&&(g=g.times(x).div(T))}return g}function et(t,e){const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,u=[...r],d=u.length,p=n.div(d**(d-1));u[o]=u[o].plus(t.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),u[i]=u[i].minus(K(t,e));let c=tt(p,u,o,i,!0,!1);return c=l.div(c.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),c}function nt(t,e){const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,u=[...r],d=u.length,p=n.div(d**(d-1)),c=J(t,e).times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString());u[o]=u[o].plus(c),u[i]=u[i].minus(t);let m=tt(p,u,o,i,!0,!0);return m=l.div(m.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),m}function at(t,e){const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,u=[...r],l=u.length,d=n.div(l**(l-1));return u[o]=u[o].plus(t.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),u[i]=u[i].minus(K(t,e)),tt(d,u,o,i,!1,!1)}function rt(t,e){const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,u=[...r],l=u.length,d=n.div(l**(l-1)),p=J(t,e).times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString());u[o]=u[o].plus(p),u[i]=u[i].minus(t);const c=a.WeiPerEther.div(s).toString();return tt(d,u,o,i,!1,!0).div(c)}function ot(e,n){const{amp:r,allBalances:o,balanceOut:i,tokenIndexIn:s,decimalsOut:d,swapFee:p}=n,m=[...o],h=m.length,I=r.div(h**(h-1)),f=function(t,e){if(t.isZero())return t;const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,d=[...r],p=d.length,c=n.div(p**(p-1)),m=t,h=Y(c,d),I=r[i].plus(m).div(r[i]).times(h);let f=u;for(let t=0;t<d.length;t++)f=f.plus(d[t]);const T=function(t,e,n,a){let r=n,o=u;const i=e.length;let s=l,d=u;for(let t=0;t<i;t++)s=s.times(i),t!=a&&(d=e[t],o=o.plus(d),r=r.times(n).div(d));return Q(o,n,t,s,r)}(c,d,I,o),x=T.minus(d[o]),g=d[o].div(f),w=l.minus(g);return x.div(l.minus(w.times(s.toString()).div(a.WeiPerEther.toString())))}(e,n),T=function(t,e,n){let r=u;for(let e=0;e<t.length;e++)r=r.plus(t[e]);const o=t[e].div(r),i=l.minus(o);return l.minus(i.times(n.toString()).div(a.WeiPerEther.toString()))}(m,s,p);m[s]=m[s].plus(f.times(T));let x=function(e,n,a,r,o,i,s){const d=n.length,p=Y(e,n);let m=u,h=p.div(d);for(let t=0;t<d;t++)t!=r&&(m=m.plus(n[t]),h=h.times(p).div(n[t].times(d)));const I=n[r],f=c(t.formatFixed(e,3)),T=f.times(d**d),x=T.times(m),g=l.minus(T),w=c(2).times(T).times(I).plus(x).plus(g.times(p)),y=h.times(d+1).minus(g.times(I)),k=u.minus(y);let b;if(o)b=w.div(y).times(a).div(p);else{const t=c(2).times(T),e=g,n=d*(d+1),r=u.minus(h.times(n).div(p));if(i){const n=t.times(k).div(w.pow(2)),o=c(2).times(e).div(w),i=r.div(k);if(b=n.minus(o).plus(i).times(p).div(a),s){const t=u.minus(w.div(k));b=b.div(t).times(p).div(a)}}else b=c(2).times(e).div(k).minus(r.times(w).div(k.pow(2))).minus(t.div(w)),s&&(b=b.times(w).div(y).times(a).div(p))}return b}(I,m,c(t.formatFixed(i,d)).plus(e),s,!0,!0,!0);return x=l.div(x.times(T)),x}var it=Object.freeze({__proto__:null,_derivativeSpotPriceAfterSwapExactTokenInForTokenOut:at,_derivativeSpotPriceAfterSwapTokenInForExactTokenOut:rt,_exactTokenInForTokenOut:K,_invariant:Y,_solveAnalyticalBalance:Q,_spotPriceAfterSwapExactTokenInForTokenOut:et,_spotPriceAfterSwapTokenInForExactBPTOut:ot,_spotPriceAfterSwapTokenInForExactTokenOut:nt,_tokenInForExactTokenOut:J});const st=BigInt(1e3);function ut(t,e){let n=m;const a=e.length;for(let t=0;t<a;t++)n+=e[t];if(n==m)return m;let r=m,o=n;const i=t*BigInt(a);for(let t=0;t<255;t++){let t=o;for(let n=0;n<a;n++)t=x.divDown(x.mul(t,o),x.mul(e[n],BigInt(a)));if(r=o,o=x.divDown(x.mul(x.divDown(x.mul(i,n),st)+x.mul(t,BigInt(a)),o),x.divDown(x.mul(i-st,o),st)+x.mul(BigInt(a+1),t)),o>r){if(o-r<=1)return o}else if(r-o<=1)return o}throw new Error("Errors.STABLE_INVARIANT_DIDNT_CONVERGE")}function lt(t,e,n,a,r,o){r=function(t,e){const n=x.mulUpFixed(t,e);return t-n}(r,o);const i=ut(t,e),s=e[n];e[n]=s+r;const u=ft(t,e,i,a);return e[a]-u-BigInt(1)}function dt(t,e,n,a,r,o){const i=ut(t,e);e[a]=x.sub(e[a],r);const s=ft(t,e,i,n);let u=x.add(x.sub(s,e[n]),BigInt(1));return u=function(t,e){return x.divUpFixed(t,x.complementFixed(e))}(u,o),u}function pt(t,e,n,a,r){let o=BigInt(0);for(let t=0;t<e.length;t++)o+=e[t];const i=new Array(n.length);let s=BigInt(0);for(let t=0;t<e.length;t++){const a=x.divDownFixed(e[t],o);i[t]=x.divDownFixed(e[t]+n[t],e[t]),s+=x.mulDownFixed(i[t],a)}const u=new Array(e.length);for(let t=0;t<e.length;t++){let a;if(i[t]>s){const o=x.mulDownFixed(e[t],s-x.ONE),i=n[t]-o;a=o+x.mulDownFixed(i,x.ONE-r)}else a=n[t];u[t]=e[t]+a}const l=ut(t,e),d=ut(t,u),p=x.divDownFixed(d,l);return p>x.ONE?x.mulDownFixed(a,p-x.ONE):BigInt(0)}function ct(t,e,n,a,r,o){const i=ut(t,e),s=ft(t,e,x.mulUpFixed(x.divUpFixed(x.add(r,a),r),i),n),u=x.sub(s,e[n]);let l=BigInt(0);for(let t=0;t<e.length;t++)l=x.add(l,e[t]);const d=x.divDownFixed(e[n],l),p=x.complementFixed(d),c=x.mulUpFixed(u,p),m=x.sub(u,c);return x.add(m,x.divUpFixed(c,x.sub(x.ONE,o)))}function mt(t,e,n,a,r){let o=BigInt(0);for(let t=0;t<e.length;t++)o+=e[t];const i=new Array(n.length);let s=BigInt(0);for(let t=0;t<e.length;t++){const a=x.divUpFixed(e[t],o);i[t]=x.divUpFixed(e[t]-n[t],e[t]),s+=x.mulUpFixed(i[t],a)}const u=new Array(e.length);for(let t=0;t<e.length;t++){let a;if(s>i[t]){const o=x.mulDownFixed(e[t],x.complementFixed(s)),i=n[t]-o;a=o+x.divUpFixed(i,x.ONE-r)}else a=n[t];u[t]=e[t]-a}const l=ut(t,e),d=ut(t,u),p=x.divDownFixed(d,l);return x.mulUpFixed(a,x.complementFixed(p))}function ht(t,e,n,a,r,o){const i=ut(t,e),s=ft(t,e,x.mulUpFixed(x.divUpFixed(r-a,r),i),n),u=e[n]-s;let l=BigInt(0);for(let t=0;t<e.length;t++)l+=e[t];const d=x.divDownFixed(e[n],l),p=x.complementFixed(d),c=x.mulUpFixed(u,p);return u-c+x.mulDownFixed(c,x.ONE-o)}function It(t,e,n){const a=x.divDownFixed(e,n),r=new Array(t.length);for(let e=0;e<t.length;e++)r[e]=x.mulDownFixed(t[e],a);return r}function ft(t,e,n,a){const r=t*BigInt(e.length);let o=e[0],i=e[0]*BigInt(e.length);for(let t=1;t<e.length;t++)i=x.divDown(x.mul(x.mul(i,e[t]),BigInt(e.length)),n),o+=e[t];o-=e[a];const s=x.mul(n,n),u=x.mul(x.mul(x.divUp(s,x.mul(r,i)),st),e[a]),l=o+x.mul(x.divDown(n,r),st);let d=m,p=x.divUp(s+u,n+l);for(let t=0;t<255;t++)if(d=p,p=x.divUp(x.mul(p,p)+u,x.mul(p,BigInt(2))+l-n),p>d){if(p-d<=1)return p}else if(d-p<=1)return p;throw new Error("Errors.STABLE_GET_BALANCE_DIDNT_CONVERGE")}function Tt(t,e,n,a,r,o){const i=e.length,s=ut(t,e);let u=BigInt(0);for(let t=0;t<i;t++)t!=n&&t!=a&&(u+=e[t]);const l=e[n],d=e[a],p=t*BigInt(i),c=p*(u-s)+s*st,m=BigInt(2)*p*l*d,h=m+p*d*d+c*d,I=m+p*l*l+c*l;let f;if(r)f=x.divUpFixed(h,I);else{const t=BigInt(2)*p*d,e=BigInt(2)*p*l,n=t+e+c,a=BigInt(2)*h*I*n-t*I*I+e*h*h,r=h*h*I;f=x.divUpFixed(a,r),o&&(f=x.mulUpFixed(x.mulUpFixed(f,I),h))}return f}function xt(t,e,n,a,r,o,i){const s=e.length,u=ut(t,e);let l=BigInt(0),d=u/BigInt(s);for(let t=0;t<s;t++)t!=a&&(l+=e[t],d=d*u/(BigInt(s)*e[t]));const p=e[a],c=t*BigInt(s),m=c*l,h=BigInt(st)-c,I=BigInt(2)*c*p+m+h*u,f=d*BigInt(s+1)*st-h*p;return x.divUpFixed(I*n/f,u)}var gt=Object.freeze({__proto__:null,_calcBptInGivenExactTokensOut:mt,_calcBptOutGivenExactTokensIn:pt,_calcInGivenOut:dt,_calcOutGivenIn:lt,_calcTokenInGivenExactBptOut:ct,_calcTokenOutGivenExactBptIn:ht,_calcTokensOutGivenExactBptIn:It,_poolDerivatives:Tt,_poolDerivativesBPT:xt,_spotPriceAfterSwapBPTInForExactTokenOut:function(t,e,n,a,r){e[n]=x.sub(e[n],r);const o=e.map(((t,e)=>e==n?r:BigInt(0)));return xt(t,e,a-mt(t,e,o,a,BigInt(0)),n)},_spotPriceAfterSwapExactBPTInForTokenOut:function(t,e,n,a,r){const o=ht(t,e,n,r,a,BigInt(0));return e[n]=e[n]-o,xt(t,e,x.sub(a,r),n)},_spotPriceAfterSwapExactTokenInForBPTOut:function(t,e,n,a,r){e[n]=e[n]+r;const o=e.map(((t,e)=>e==n?r:BigInt(0)));let i=xt(t,e,a+pt(t,e,o,a,BigInt(0)),n);return i=x.divUpFixed(x.ONE,i),i},_spotPriceAfterSwapExactTokenInForTokenOut:function(t,e,n,a,r,o){const i=x.complementFixed(o),s=[...e];e[n]=x.add(e[n],x.mulUpFixed(r,i)),e[a]=x.sub(e[a],lt(t,s,n,a,r,o));let u=Tt(t,e,n,a,!0,!1);return u=x.divDownFixed(x.ONE,x.mulDownFixed(u,i)),u},_spotPriceAfterSwapTokenInForExactBPTOut:function(t,e,n,a,r){const o=ct(t,[...e],n,r,a,BigInt(0));e[n]=e[n]+o;let i=xt(t,e,a+r,n);return i=x.divUpFixed(x.ONE,i),i},_spotPriceAfterSwapTokenInForExactTokenOut:function(t,e,n,a,r,o){const i=dt(t,[...e],n,a,r,o);e[n]=e[n]+i,e[a]=x.sub(e[a],r);let s=Tt(t,e,n,a,!0,!0);const u=x.complementFixed(o);return s=x.divUpFixed(x.ONE,x.mulUpFixed(s,u)),s}});class wt{static fromPool(t){if(!t.amp)throw new Error("StablePool missing amp factor");return new wt(t.id,t.address,t.amp,t.swapFee,t.totalShares,t.tokens,t.tokensList)}constructor(e,n,a,r,o,i,s){this.poolType=exports.PoolTypes.Stable,this.MAX_IN_RATIO=t.parseFixed("0.3",18),this.MAX_OUT_RATIO=t.parseFixed("0.3",18),this.id=e,this.address=n,this.amp=t.parseFixed(a,wt.AMP_DECIMALS),this.swapFee=t.parseFixed(r,18),this.totalShares=t.parseFixed(o,18),this.tokens=i,this.tokensList=s}parsePoolPairData(e,a){const r=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(r<0)throw"Pool does not contain tokenIn";const o=this.tokens[r],i=o.balance,s=o.decimals,u=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(a)));if(u<0)throw"Pool does not contain tokenOut";const l=this.tokens[u],d=l.balance,p=l.decimals,m=this.tokens.map((({balance:t})=>c(t))),h=this.tokens.map((({balance:e})=>t.parseFixed(e,18)));return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:e,tokenOut:a,balanceIn:t.parseFixed(i,s),balanceOut:t.parseFixed(d,p),swapFee:this.swapFee,allBalances:m,allBalancesScaled:h,amp:this.amp,tokenIndexIn:r,tokenIndexOut:u,decimalsIn:Number(s),decimalsOut:Number(p)}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){return n===exports.SwapTypes.SwapExactIn?c(t.formatFixed(e.balanceIn.mul(this.MAX_IN_RATIO).div(a.WeiPerEther),e.decimalsIn)):c(t.formatFixed(e.balanceOut.mul(this.MAX_OUT_RATIO).div(a.WeiPerEther),e.decimalsOut))}updateTokenBalanceForPool(e,n){if(w(this.address,e))this.updateTotalShares(n);else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){try{if(n.isZero())return u;const a=this.subtractSwapFeeAmount(t.parseFixed(n.dp(e.decimalsIn).toString(),e.decimalsIn),e.swapFee).mul(10**(18-e.decimalsIn));return p(c(lt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,a.toBigInt(),BigInt(0)).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_tokenInForExactTokenOut(e,n){try{if(n.isZero())return u;const a=t.parseFixed(n.dp(18).toString(),18);let r=dt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,a.toBigInt(),BigInt(0));const o=BigInt(10**(18-e.decimalsIn));r=(r+o-BigInt(1))/o;return c(this.addSwapFeeAmount(t.BigNumber.from(r),e.swapFee).toString()).div(10**e.decimalsIn)}catch(t){return console.error(`_evminGivenOut: ${t.message}`),u}}_calcTokensOutGivenExactBptIn(e){const n=this.tokens.filter((t=>!w(t.address,this.address))).map((t=>k(t)));try{const a=It(n,e.toBigInt(),this.totalShares.toBigInt());return a.map(((t,e)=>E(t,this.tokens[e]))).map((e=>t.BigNumber.from(e)))}catch(t){return new Array(n.length).fill(u)}}_calcBptOutGivenExactTokensIn(e){try{const n=new Array(e.length).fill(BigInt(0)),a=new Array(e.length).fill(BigInt(0));this.tokens.filter((t=>!w(t.address,this.address))).forEach(((t,r)=>{n[r]=b(BigInt(e[r].toString()),t),a[r]=k(t)}));const r=pt(this.amp.toBigInt(),a,n,this.totalShares.toBigInt(),this.swapFee.toBigInt());return t.BigNumber.from(r.toString())}catch(t){return a.Zero}}_spotPriceAfterSwapExactTokenInForTokenOut(t,e){return et(e,t)}_spotPriceAfterSwapTokenInForExactTokenOut(t,e){return nt(e,t)}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,e){return at(e,t)}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(t,e){return rt(e,t)}subtractSwapFeeAmount(t,e){const n=t.mul(e).add(a.WeiPerEther.sub(1)).div(a.WeiPerEther);return t.sub(n)}addSwapFeeAmount(t,e){const n=a.WeiPerEther.sub(e);return t.mul(a.WeiPerEther).add(n.sub(1)).div(n)}}wt.AMP_DECIMALS=3;class yt{static fromPool(t){if(!t.amp)throw new Error("MetaStablePool missing amp factor");return new yt(t.id,t.address,t.amp,t.swapFee,t.totalShares,t.tokens,t.tokensList)}constructor(e,n,a,r,o,i,s){this.poolType=exports.PoolTypes.MetaStable,this.MAX_IN_RATIO=t.parseFixed("0.3",18),this.MAX_OUT_RATIO=t.parseFixed("0.3",18),this.id=e,this.address=n,this.amp=t.parseFixed(a,yt.AMP_DECIMALS),this.swapFee=t.parseFixed(r,18),this.totalShares=t.parseFixed(o,18),this.tokens=i,this.tokensList=s}parsePoolPairData(e,r){const o=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(o<0)throw"Pool does not contain tokenIn";const i=this.tokens[o],s=i.decimals,u=t.parseFixed(i.priceRate,18),l=t.formatFixed(t.parseFixed(i.balance,s).mul(u).div(a.WeiPerEther),s),d=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(r)));if(d<0)throw"Pool does not contain tokenOut";const p=this.tokens[d],m=p.decimals,h=t.parseFixed(p.priceRate,18),I=t.formatFixed(t.parseFixed(p.balance,m).mul(h).div(a.WeiPerEther),m),f=this.tokens.map((({balance:t,priceRate:e})=>c(t).times(c(e)))),T=this.tokens.map((({balance:e,priceRate:n})=>t.parseFixed(e,18).mul(t.parseFixed(n,18)).div(a.WeiPerEther)));return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:e,tokenOut:r,balanceIn:t.parseFixed(l,s),balanceOut:t.parseFixed(I,m),swapFee:this.swapFee,allBalances:f,allBalancesScaled:T,amp:this.amp,tokenIndexIn:o,tokenIndexOut:d,decimalsIn:Number(s),decimalsOut:Number(m),tokenInPriceRate:u,tokenOutPriceRate:h}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){return n===exports.SwapTypes.SwapExactIn?c(t.formatFixed(e.balanceIn.mul(this.MAX_IN_RATIO).div(e.tokenInPriceRate),e.decimalsIn)):c(t.formatFixed(e.balanceOut.mul(this.MAX_OUT_RATIO).div(e.tokenOutPriceRate),e.decimalsOut))}updateTokenBalanceForPool(e,n){if(w(this.address,e))this.updateTotalShares(n);else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){try{if(n.isZero())return u;const r=this.subtractSwapFeeAmount(t.parseFixed(n.dp(e.decimalsIn).toString(),e.decimalsIn),e.swapFee).mul(e.tokenInPriceRate).div(a.WeiPerEther),o=lt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,r.toBigInt(),BigInt(0)),i=t.BigNumber.from(o).mul(a.WeiPerEther).div(e.tokenOutPriceRate);return c(t.formatFixed(i,18))}catch(t){return u}}_tokenInForExactTokenOut(e,n){try{if(n.isZero())return u;const a=e.decimalsIn,r=e.decimalsOut,o=e.tokenInPriceRate.toBigInt()*BigInt(10**(18-a)),i=e.tokenOutPriceRate.toBigInt()*BigInt(10**(18-r)),s=BigInt(n.times(10**r).dp(0).toString())*i/BigInt(10**18),l=dt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,s,BigInt(0))*BigInt(10**18)/o;return c(this.addSwapFeeAmount(t.BigNumber.from(l),e.swapFee).toString()).div(10**e.decimalsIn)}catch(t){return console.error(`_evminGivenOut: ${t.message}`),u}}_calcTokensOutGivenExactBptIn(e){const n=this.tokens.filter((t=>!w(t.address,this.address))).map((t=>k(t)));try{const a=It(n,e.toBigInt(),this.totalShares.toBigInt());return a.map(((e,n)=>t.BigNumber.from(E(e,this.tokens[n]).toString())))}catch(t){return new Array(n.length).fill(u)}}_calcBptOutGivenExactTokensIn(e){try{const n=new Array(e.length).fill(BigInt(0)),a=new Array(e.length).fill(BigInt(0));this.tokens.filter((t=>!w(t.address,this.address))).forEach(((t,r)=>{n[r]=b(BigInt(e[r].toString()),t),a[r]=k(t)}));const r=pt(this.amp.toBigInt(),a,n,this.totalShares.toBigInt(),this.swapFee.toBigInt());return t.BigNumber.from(r.toString())}catch(t){return a.Zero}}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){const a=c(t.formatFixed(e.tokenInPriceRate,18)),r=c(t.formatFixed(e.tokenOutPriceRate,18));return et(n.times(t.formatFixed(e.tokenInPriceRate,18)),e).div(a).times(r)}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){const a=c(t.formatFixed(e.tokenInPriceRate,18)),r=c(t.formatFixed(e.tokenOutPriceRate,18));return nt(n.times(t.formatFixed(e.tokenOutPriceRate,18)),e).div(a).times(r)}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,n){const a=c(t.formatFixed(e.tokenOutPriceRate,18));return at(n,e).times(a)}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,n){const a=c(t.formatFixed(e.tokenInPriceRate,18)),r=c(t.formatFixed(e.tokenOutPriceRate,18));return rt(n,e).div(a).times(r).times(r)}subtractSwapFeeAmount(t,e){const n=t.mul(e).add(a.WeiPerEther.sub(1)).div(a.WeiPerEther);return t.sub(n)}addSwapFeeAmount(t,e){const n=a.WeiPerEther.sub(e);return t.mul(a.WeiPerEther).add(n.sub(1)).div(n)}}function kt(t,e,n,a,r){if(a==BigInt(0))return Ut(t,r);const o=Ut(e,r),i=Ut(e+t,r)-o,s=Dt(o,n,r);return x.divDown(x.mul(a,i),s)}function bt(t,e,n,a,r){const o=Ut(e,r),i=o-Ut(e-t,r),s=Wt(o,n,r);return x.divUp(x.mul(a,i),s)}function Et(t,e,n,a,r){const o=Ut(e,r),i=Dt(o,n,r),s=Wt(o,n-t,r);return a-x.divDown(x.mul(a,s),i)}function St(t,e,n,a,r){const o=Ut(e,r),i=Ut(e+t,r)-o;return x.divDownFixed(i,r.rate)}function Ft(t,e,n,a,r){const o=Ut(e,r)-Ut(e-t,r);return x.divUpFixed(o,r.rate)}function Ot(t,e,n,a,r){if(a==BigInt(0))return Lt(t,r);const o=Ut(e,r),i=Dt(o,n,r);return Lt(o+x.divUp(x.mul(i,t),a),r)-e}function Bt(t,e,n,a,r){const o=Ut(e,r),i=Wt(o,n,r);return e-Lt(o-x.divDown(x.mul(i,t),a),r)}function vt(t,e,n,a,r){return e-Lt(Ut(e,r)-x.mulDownFixed(t,r.rate),r)}function Pt(t,e,n,a,r){return Lt(Ut(e,r)+x.mulUpFixed(t,r.rate),r)-e}function _t(t,e,n,a,r){if(a==BigInt(0))return x.mulDownFixed(t,r.rate);const o=Ut(e,r),i=Dt(o,n,r),s=Wt(o,n+t,r);return x.divDown(x.mul(a,s),i)-a}function At(t,e,n,a,r){if(a==BigInt(0))return x.divUpFixed(t,r.rate);const o=Ut(e,r),i=Dt(o,n,r),s=a+t;return x.divUpFixed(x.divUp(x.mul(s,i),a)-o,r.rate)-n}function Nt(t,e,n,a,r){const o=Ut(e,r),i=Dt(o,n,r),s=a-t;return n-x.divUpFixed(x.divUp(x.mul(s,i),a)-o,r.rate)}function Dt(t,e,n){return t+x.mulUpFixed(e,n.rate)}function Wt(t,e,n){return t+x.mulDownFixed(e,n.rate)}function Ut(t,e){if(t<e.lowerTarget){const n=x.mulDownFixed(e.lowerTarget-t,e.fee);return x.sub(t,n)}if(t<=e.upperTarget)return t;{const n=x.mulDownFixed(t-e.upperTarget,e.fee);return x.sub(t,n)}}function Lt(t,e){return t<e.lowerTarget?x.divDownFixed(t+x.mulDownFixed(e.fee,e.lowerTarget),x.ONE+e.fee):t<=e.upperTarget?t:x.divDownFixed(t-x.mulDownFixed(e.fee,e.upperTarget),x.ONE-e.fee)}function Mt(t,e){const n=x.complementFixed(e.fee),a=x.ONE+e.fee;return t<=e.lowerTarget?a:t<=e.upperTarget?x.ONE:n}function Rt(t,e){const n=x.complementFixed(e.fee),a=x.ONE+e.fee;return t<e.lowerTarget?a:t<e.upperTarget?x.ONE:n}function Ct(t,e){const n=x.complementFixed(e.fee),a=x.ONE+e.fee;return t<=e.lowerTarget?x.divUpFixed(x.ONE,a):t<=e.upperTarget?x.ONE:x.divUpFixed(x.ONE,n)}function Gt(t,e){const n=x.complementFixed(e.fee),a=x.ONE+e.fee;return t<e.lowerTarget?x.divUpFixed(x.ONE,a):t<e.upperTarget?x.ONE:x.divUpFixed(x.ONE,n)}function Ht(t,e,n,a,r){const o=t+e,i=Wt(Ut(e,r),n,r);let s=x.ONE;return a!=BigInt(0)&&(s=x.divUpFixed(i,a)),x.divUpFixed(s,Rt(o,r))}function qt(t,e,n,a,r){const o=Ut(e,r),i=Wt(o,n,r);let s=x.ONE;a!=BigInt(0)&&(s=x.divUpFixed(i,a));const u=o+x.mulUpFixed(t,s);return x.mulUpFixed(s,Gt(u,r))}function Zt(t,e,n,a,r){const o=Ut(e,r),i=Wt(o,n,r),s=x.divDownFixed(i,a),u=x.mulDownFixed(t,s),l=x.sub(o,u);return x.divUpFixed(x.ONE,x.mulUpFixed(s,Ct(l,r)))}function Xt(t,e,n,a,r){const o=x.sub(e,t),i=Wt(Ut(e,r),n,r),s=x.divUpFixed(i,a);return x.divUpFixed(Mt(o,r),s)}function $t(t,e,n,a,r){const o=Ut(e,r)+x.mulUpFixed(t,r.rate);return x.mulUpFixed(Gt(o,r),r.rate)}function jt(t,e,n,a,r){const o=e-t;return x.divUpFixed(Mt(o,r),r.rate)}function zt(t,e,n,a,r){return x.divDownFixed(r.rate,Rt(e+t,r))}function Vt(t,e,n,a,r){const o=Ut(e,r)-x.mulDownFixed(t,r.rate),i=x.mulUpFixed(Ct(o,r),r.rate);return x.divUpFixed(x.ONE,i)}function Yt(t,e,n,a,r){if(a==BigInt(0))return r.rate;const o=Dt(Ut(e,r),n,r);return x.divUpFixed(o,x.mulUpFixed(a,r.rate))}function Kt(t,e,n,a,r){const o=Dt(Ut(e,r),n,r);return x.divUp(x.mul(a,r.rate),o)}function Jt(t,e,n,a,r){if(a==BigInt(0))return x.divUpFixed(x.ONE,r.rate);const o=Dt(Ut(e,r),n,r);return x.divUpFixed(o,x.mulUpFixed(a,r.rate))}function Qt(t,e,n,a,r){const o=Dt(Ut(e,r),n,r);return x.divDown(x.mul(a,r.rate),o)}yt.AMP_DECIMALS=3;var te,ee=Object.freeze({__proto__:null,_calcBptInPerMainOut:bt,_calcBptInPerWrappedOut:Et,_calcBptOutPerMainIn:kt,_calcBptOutPerWrappedIn:_t,_calcMainInPerBptOut:Ot,_calcMainInPerWrappedOut:Pt,_calcMainOutPerBptIn:Bt,_calcMainOutPerWrappedIn:vt,_calcTokensOutGivenExactBptIn:function(t,e,n,a){const r=x.divDownFixed(e,n),o=new Array(t.length).fill(m);for(let e=0;e<t.length;e++)e!=a&&(o[e]=x.mulDownFixed(t[e],r));return o},_calcWrappedInPerBptOut:At,_calcWrappedInPerMainOut:Ft,_calcWrappedOutPerBptIn:Nt,_calcWrappedOutPerMainIn:St,_spotPriceAfterSwapBptInPerMainOut:Xt,_spotPriceAfterSwapBptInPerWrappedOut:Qt,_spotPriceAfterSwapBptOutPerMainIn:Ht,_spotPriceAfterSwapBptOutPerWrappedIn:Yt,_spotPriceAfterSwapMainInPerBptOut:qt,_spotPriceAfterSwapMainInPerWrappedOut:$t,_spotPriceAfterSwapMainOutPerBptIn:Zt,_spotPriceAfterSwapMainOutPerWrappedIn:Vt,_spotPriceAfterSwapWrappedInPerBptOut:Jt,_spotPriceAfterSwapWrappedInPerMainOut:jt,_spotPriceAfterSwapWrappedOutPerBptIn:Kt,_spotPriceAfterSwapWrappedOutPerMainIn:zt});!function(t){t[t.BptToMainToken=0]="BptToMainToken",t[t.MainTokenToBpt=1]="MainTokenToBpt",t[t.MainTokenToWrappedToken=2]="MainTokenToWrappedToken",t[t.WrappedTokenToMainToken=3]="WrappedTokenToMainToken",t[t.BptToWrappedToken=4]="BptToWrappedToken",t[t.WrappedTokenToBpt=5]="WrappedTokenToBpt"}(te||(te={}));class ne{static fromPool(t){if(void 0===t.mainIndex)throw new Error("LinearPool missing mainIndex");if(void 0===t.wrappedIndex)throw new Error("LinearPool missing wrappedIndex");if(!t.lowerTarget)throw new Error("LinearPool missing lowerTarget");if(!t.upperTarget)throw new Error("LinearPool missing upperTarget");return new ne(t.id,t.address,t.swapFee,t.totalShares,t.tokens,t.tokensList,t.mainIndex,t.wrappedIndex,t.lowerTarget,t.upperTarget)}constructor(e,n,a,r,o,i,s,u,l,d){this.poolType=exports.PoolTypes.Linear,this.MAX_RATIO=t.parseFixed("10",18),this.ALMOST_ONE=t.parseFixed("0.99",18),this.MAX_TOKEN_BALANCE=t.BigNumber.from("2").pow("112").sub("1"),this.id=e,this.address=n,this.swapFee=t.parseFixed(a,18),this.totalShares=t.parseFixed(r,18),this.tokens=o,this.tokensList=i,this.mainIndex=s,this.bptIndex=this.tokensList.indexOf(this.address),this.wrappedIndex=u,this.wrappedDecimals=this.tokens[this.wrappedIndex].decimals,this.lowerTarget=t.parseFixed(l,18),this.upperTarget=t.parseFixed(d,18)}parsePoolPairData(e,n){let a;const r=this.tokens.find((t=>w(t.address,e)));if(!r)throw Error(`Pool does not contain token in ${e}`);const o=r.decimals,i=t.parseFixed(r.balance,o),s=this.tokens.find((t=>w(t.address,n)));if(!s)throw Error(`Pool does not contain token out ${n}`);const u=s.decimals,l=t.parseFixed(s.balance,u);a=w(e,this.address)?w(n,this.tokens[this.wrappedIndex].address)?te.BptToWrappedToken:te.BptToMainToken:w(n,this.address)?w(e,this.tokens[this.wrappedIndex].address)?te.WrappedTokenToBpt:te.MainTokenToBpt:w(e,this.tokens[this.wrappedIndex].address)?te.WrappedTokenToMainToken:te.MainTokenToWrappedToken;const d=this.tokens.map((({balance:e})=>t.parseFixed(e,18))),m=d[this.bptIndex],h=this.MAX_TOKEN_BALANCE.sub(m);return{id:this.id,address:this.address,poolType:this.poolType,pairType:a,tokenIn:e,tokenOut:n,decimalsIn:Number(o),decimalsOut:Number(u),balanceIn:i,balanceOut:l,swapFee:this.swapFee,wrappedBalance:p(c(this.tokens[this.wrappedIndex].balance),this.wrappedDecimals),wrappedBalanceScaled:d[this.wrappedIndex],wrappedDecimals:this.wrappedDecimals,rate:t.parseFixed(this.tokens[this.wrappedIndex].priceRate,18),lowerTarget:this.lowerTarget,upperTarget:this.upperTarget,mainBalanceScaled:d[this.mainIndex],bptBalanceScaled:m,virtualBptSupply:h}}getNormalizedLiquidity(t){return d}getLimitAmountSwap(t,e){const n=t,r=p(c(t.balanceOut.toString()),-t.decimalsOut);if(e===exports.SwapTypes.SwapExactIn){if(n.pairType===te.MainTokenToBpt)return this._mainTokenInForExactBPTOut(t,r.times(this.ALMOST_ONE.toString()).div(a.WeiPerEther.toString()));if(n.pairType===te.WrappedTokenToBpt)return p(c(this.MAX_TOKEN_BALANCE.toString()),-18);if(n.pairType===te.BptToMainToken)return this._BPTInForExactMainTokenOut(n,r.times(this.ALMOST_ONE.toString()).div(a.WeiPerEther.toString()));if(n.pairType===te.BptToWrappedToken){return this._BPTInForExactWrappedTokenOut(t,r.times(this.ALMOST_ONE.toString()).div(a.WeiPerEther.toString()))}if(n.pairType===te.MainTokenToWrappedToken||n.pairType===te.WrappedTokenToMainToken){return p(c(t.balanceOut.mul(this.ALMOST_ONE).div(a.WeiPerEther).toString()),-t.decimalsOut)}return c(0)}if(n.pairType===te.MainTokenToBpt||n.pairType===te.WrappedTokenToBpt){return p(c(t.balanceOut.mul(this.MAX_RATIO).div(a.WeiPerEther).toString()),-t.decimalsOut)}if(n.pairType===te.BptToMainToken||n.pairType===te.BptToWrappedToken||n.pairType===te.MainTokenToWrappedToken||n.pairType===te.WrappedTokenToMainToken){return p(c(t.balanceOut.mul(this.ALMOST_ONE).div(a.WeiPerEther).toString()),-t.decimalsOut)}return c(0)}updateTokenBalanceForPool(e,n){const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");if(w(this.address,e)){const e=t.parseFixed(a.balance,a.decimals).sub(n),r=this.totalShares.add(e);this.updateTotalShares(r)}a.balance=t.formatFixed(n,a.decimals)}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(t,e){return t.pairType===te.MainTokenToBpt?this._exactMainTokenInForBPTOut(t,e):t.pairType===te.BptToMainToken?this._exactBPTInForMainTokenOut(t,e):t.pairType===te.WrappedTokenToBpt?this._exactWrappedTokenInForBPTOut(t,e):t.pairType===te.BptToWrappedToken?this._exactBPTInForWrappedTokenOut(t,e):t.pairType===te.MainTokenToWrappedToken?this._exactMainTokenInForWrappedOut(t,e):t.pairType===te.WrappedTokenToMainToken?this._exactWrappedTokenInForMainOut(t,e):c(0)}_exactWrappedTokenInForMainOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(vt(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_exactMainTokenInForWrappedOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(St(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_exactMainTokenInForBPTOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(kt(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_exactBPTInForMainTokenOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(Bt(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_exactWrappedTokenInForBPTOut(e,n){try{return p(c(_t(t.parseFixed(n.toString(),18).toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_exactBPTInForWrappedTokenOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(Nt(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_tokenInForExactTokenOut(t,e){return t.pairType===te.MainTokenToBpt?this._mainTokenInForExactBPTOut(t,e):t.pairType===te.BptToMainToken?this._BPTInForExactMainTokenOut(t,e):t.pairType===te.WrappedTokenToBpt?this._wrappedTokenInForExactBPTOut(t,e):t.pairType===te.BptToWrappedToken?this._BPTInForExactWrappedTokenOut(t,e):t.pairType===te.MainTokenToWrappedToken?this._mainTokenInForExactWrappedOut(t,e):t.pairType===te.WrappedTokenToMainToken?this._wrappedTokenInForExactMainOut(t,e):c(0)}_wrappedTokenInForExactMainOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(Ft(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_mainTokenInForExactWrappedOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(Pt(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsOut,1)}catch(t){return u}}_mainTokenInForExactBPTOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(Ot(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsIn,0)}catch(t){return u}}_BPTInForExactMainTokenOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(bt(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsIn,0)}catch(t){return u}}_wrappedTokenInForExactBPTOut(e,n){try{const a=t.parseFixed(n.toString(),18);return p(c(At(a.toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsIn,0)}catch(t){return u}}_BPTInForExactWrappedTokenOut(e,n){try{return p(c(Et(t.parseFixed(n.toString(),18).toBigInt(),e.mainBalanceScaled.toBigInt(),e.wrappedBalanceScaled.toBigInt(),e.virtualBptSupply.toBigInt(),{fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()}).toString()),-18).dp(e.decimalsIn,0)}catch(t){return u}}_calcTokensOutGivenExactBptIn(t){return new Array(this.tokens.length).fill(a.Zero)}_calcBptOutGivenExactTokensIn(t){return a.Zero}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){try{const a=t.parseFixed(n.dp(18).toString(),18).toBigInt(),r=e.mainBalanceScaled.toBigInt(),o=e.wrappedBalanceScaled.toBigInt(),i=e.virtualBptSupply.toBigInt(),s={fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()};let u;if(e.pairType===te.MainTokenToBpt)u=Ht(a,r,o,i,s);else if(e.pairType===te.BptToMainToken)u=Zt(a,r,o,i,s);else if(e.pairType===te.WrappedTokenToBpt)u=Yt(0,r,o,i,s);else if(e.pairType===te.BptToWrappedToken)u=Kt(0,r,o,i,s);else if(e.pairType===te.MainTokenToWrappedToken)u=zt(a,r,0,0,s);else{if(e.pairType!==te.WrappedTokenToMainToken)return c(0);u=Vt(a,r,0,0,s)}return p(c(u.toString()),-18).dp(e.decimalsOut,0)}catch(t){return c(0)}}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){try{const a=t.parseFixed(n.dp(18).toString(),18).toBigInt(),r=e.mainBalanceScaled.toBigInt(),o=e.wrappedBalanceScaled.toBigInt(),i=e.virtualBptSupply.toBigInt(),s={fee:e.swapFee.toBigInt(),lowerTarget:e.lowerTarget.toBigInt(),upperTarget:e.upperTarget.toBigInt(),rate:e.rate.toBigInt()};let u;if(e.pairType===te.MainTokenToBpt)u=qt(a,r,o,i,s);else if(e.pairType===te.BptToMainToken)u=Xt(a,r,o,i,s);else if(e.pairType===te.WrappedTokenToBpt)u=Jt(0,r,o,i,s);else if(e.pairType===te.BptToWrappedToken)u=Qt(0,r,o,i,s);else if(e.pairType===te.MainTokenToWrappedToken)u=$t(a,r,0,0,s);else{if(e.pairType!==te.WrappedTokenToMainToken)return c(0);u=jt(a,r,0,0,s)}return p(c(u.toString()),-18).dp(e.decimalsOut,0)}catch(t){return c(0)}}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,e){return c(0)}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(t,e){return c(0)}}function ae(t,e,n){let a=e<t?t-e:0;return a/=n,a}class re{static fromPool(t){if(!t.expiryTime)throw new Error("ElementPool missing expiryTime");if(!t.unitSeconds)throw new Error("ElementPool missing unitSeconds");if(!t.principalToken)throw new Error("ElementPool missing principalToken");if(!t.baseToken)throw new Error("ElementPool missing baseToken");return new re(t.id,t.address,t.swapFee,t.totalShares,t.tokens,t.tokensList,t.expiryTime,t.unitSeconds,t.principalToken,t.baseToken)}constructor(e,n,a,r,o,i,s,u,l,d){this.poolType=exports.PoolTypes.Element,this.id=e,this.address=n,this.swapFee=t.parseFixed(a,18),this.totalShares=t.parseFixed(r,18),this.tokens=o,this.tokensList=i,this.expiryTime=s,this.unitSeconds=u,this.principalToken=l,this.baseToken=d,this.currentBlockTimestamp=0}setCurrentBlockTimestamp(t){this.currentBlockTimestamp=t}parsePoolPairData(e,a){const r=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(r<0)throw"Pool does not contain tokenIn";const o=this.tokens[r],i=o.decimals,s=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(a)));if(s<0)throw"Pool does not contain tokenOut";const u=this.tokens[s],l=u.decimals,d=t.parseFixed(o.balance,i),p=t.parseFixed(u.balance,l);let c=d,m=p;e==this.principalToken?c=d.add(this.totalShares):a==this.principalToken&&(m=p.add(this.totalShares));return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:e,tokenOut:a,principalToken:this.principalToken,baseToken:this.baseToken,decimalsIn:Number(i),decimalsOut:Number(l),balanceIn:c,balanceOut:m,swapFee:this.swapFee,totalShares:this.totalShares,expiryTime:this.expiryTime,unitSeconds:this.unitSeconds,currentBlockTimestamp:this.currentBlockTimestamp}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){const r=t.parseFixed("0.3",18);if(n===exports.SwapTypes.SwapExactIn){const n=parseFloat(t.formatFixed(e.balanceIn,e.decimalsIn)),a=parseFloat(t.formatFixed(e.balanceOut,e.decimalsOut)),r=ae(this.expiryTime,this.currentBlockTimestamp,this.unitSeconds);return c((n**(1-r)+a**(1-r))**(1/(1-r))-n)}return c(t.formatFixed(e.balanceOut.mul(r).div(a.WeiPerEther),e.decimalsOut))}updateTokenBalanceForPool(e,n){if(w(this.address,e))this.updateTotalShares(n);else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){return e.currentBlockTimestamp=this.currentBlockTimestamp,function(e,n){if(e.isZero())return e;const a=parseFloat(t.formatFixed(n.swapFee,18)),r=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),o=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),i=ae(n.expiryTime,n.currentBlockTimestamp,n.unitSeconds),s=e.toNumber();return c(o-(r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i))-Math.abs(s-o+(r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)))*a)}(n,e)}_tokenInForExactTokenOut(e,n){return e.currentBlockTimestamp=this.currentBlockTimestamp,function(e,n){if(e.isZero())return e;const a=parseFloat(t.formatFixed(n.swapFee,18)),r=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),o=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),i=ae(n.expiryTime,n.currentBlockTimestamp,n.unitSeconds),s=e.toNumber();return c(-r+(r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i))+Math.abs(-s-r+(r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i)))*a)}(n,e)}_calcTokensOutGivenExactBptIn(t){return new Array(this.tokens.length).fill(a.Zero)}_calcBptOutGivenExactTokensIn(t){return a.Zero}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){return e.currentBlockTimestamp=this.currentBlockTimestamp,function(e,n){const a=parseFloat(t.formatFixed(n.swapFee,18)),r=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),o=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),i=ae(n.expiryTime,n.currentBlockTimestamp,n.unitSeconds),s=e.toNumber();return c(1/((r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-1)/(s+r)**i-Math.abs(1-(r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-1)/(s+r)**i)*a))}(n,e)}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){return e.currentBlockTimestamp=this.currentBlockTimestamp,function(e,n){const a=parseFloat(t.formatFixed(n.swapFee,18)),r=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),o=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),i=ae(n.expiryTime,n.currentBlockTimestamp,n.unitSeconds),s=e.toNumber();return c((r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i)-1)/(-s+o)**i+Math.abs((r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i)-1)/(-s+o)**i-1)*a)}(n,e)}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,n){return e.currentBlockTimestamp=this.currentBlockTimestamp,function(e,n){const a=parseFloat(t.formatFixed(n.swapFee,18)),r=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),o=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),i=ae(n.expiryTime,n.currentBlockTimestamp,n.unitSeconds),s=e.toNumber();return c(-(-((r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-2))*(1/(1-i)-1)*(1-i)/(s+r)**(2*i)-(s+r)**(-1-i)*(r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-1)*i-a*Math.abs((r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-2)*(1/(1-i)-1)*(1-i)/(s+r)**(2*i)+(s+r)**(-1-i)*(r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-1)*i))/((r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-1)/(s+r)**i-Math.abs(1-(r**(1-i)-(s+r)**(1-i)+o**(1-i))**(1/(1-i)-1)/(s+r)**i)*a)**2)}(n,e)}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,n){return e.currentBlockTimestamp=this.currentBlockTimestamp,function(e,n){const a=parseFloat(t.formatFixed(n.swapFee,18)),r=parseFloat(t.formatFixed(n.balanceIn,n.decimalsIn)),o=parseFloat(t.formatFixed(n.balanceOut,n.decimalsOut)),i=ae(n.expiryTime,n.currentBlockTimestamp,n.unitSeconds),s=e.toNumber();return c((r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i)-2)*(1/(1-i)-1)*(1-i)/(-s+o)**(2*i)+(-s+o)**(-1-i)*(r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i)-1)*i+a*Math.abs((r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i)-2)*(1/(1-i)-1)*(1-i)/(-s+o)**(2*i)+(-s+o)**(-1-i)*(r**(1-i)+o**(1-i)-(-s+o)**(1-i))**(1/(1-i)-1)*i))}(n,e)}}const oe=c(1e3);function ie(e,n){let a=u;const r=n.length;for(let t=0;t<r;t++)a=a.plus(n[t]);if(a.isZero())return u;let o=u,i=a;const s=c(t.formatFixed(e,3)).times(r**r);for(let t=0;t<255;t++){let t=c(r).times(n[0]);for(let e=1;e<r;e++)t=t.times(n[e]).times(r).div(i);if(o=i,i=c(r).times(i).times(i).plus(s.times(a).times(t)).div(c(r+1).times(i).plus(s.minus(1).times(t))),i.gt(o)){if(i.minus(o).lt(c(1e-18)))break}else if(o.minus(i).lt(c(1e-18)))break}return i}function se(t,e){if(t.isZero())return t;const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,d=[...r],p=d.length,m=n.div(p**(p-1));let h=t;h=h.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString());const I=ie(m,d);let f=I,T=u;const x=c(d.length);let g=l,w=u;for(let t=0;t<d.length;t++){if(g=g.times(x),t==o)w=d[t].plus(h);else{if(t==i)continue;w=d[t]}T=T.plus(w),f=f.times(I).div(w)}const y=ce(T,I,m,g,f);return d[i].minus(y)}function ue(t,e){if(t.isZero())return t;const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,d=[...r],p=d.length,m=n.div(p**(p-1)),h=t,I=ie(m,d);let f=I,T=u;const x=c(d.length);let g=l,w=u;for(let t=0;t<d.length;t++){if(g=g.times(x),t==i)w=d[t].minus(h);else{if(t==o)continue;w=d[t]}T=T.plus(w),f=f.times(I).div(w)}return ce(T,I,m,g,f).minus(d[o]).multipliedBy(a.WeiPerEther.toString()).div(a.WeiPerEther.sub(s).toString())}function le(e,n){if(e.isZero())return e;const{amp:a,allBalances:r,virtualBptSupply:o,decimalsOut:i,tokenIndexIn:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=e,h=ie(p,l),I=c(t.formatFixed(o,i)),f=I.plus(m).div(I).times(h);let T=c(0);for(let t=0;t<l.length;t++)T=T.plus(l[t]);const x=pe(p,l,f,s).minus(l[s]),g=l[s].div(T),w=c(1).minus(g),y=c(t.formatFixed(u,18));return x.div(c(1).minus(w.times(y)))}function de(e,n){if(e.isZero())return e;const{amp:a,allBalances:r,virtualBptSupply:o,decimalsIn:i,tokenIndexOut:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=e,h=ie(p,l);let I=c(0);for(let t=0;t<l.length;t++)I=I.plus(l[t]);const f=l[s].div(I),T=l[s].minus(m).div(l[s]),x=c(1).minus(c(1).minus(T).times(f)).minus(T).div(c(1).minus(T)),g=c(t.formatFixed(u,18)),w=m.div(c(1).minus(g.times(x)));l[s]=l[s].minus(w);const y=ie(p,l);return c(t.formatFixed(o,i)).times(c(1).minus(y.div(h)))}function pe(t,e,n,a){let r=n,o=u;const i=e.length;let s=l,d=u;for(let t=0;t<i;t++)s=s.times(i),t!=a&&(d=e[t],o=o.plus(d),r=r.times(n).div(d));return ce(o,n,t,s,r)}function ce(e,n,a,r,o){const i=c(t.formatFixed(a,3));o=o.times(n).div(i.times(r).times(r));const s=e.plus(n.div(i.times(r)));let u;return u=n.gte(s)?n.minus(s).plus(n.minus(s).times(n.minus(s)).plus(o.times(4)).sqrt()):s.minus(n).times(s.minus(n)).plus(o.times(4)).sqrt().minus(s.minus(n)),u.div(2)}function me(e,n){if(e.isZero())return e;const{amp:a,allBalances:r,virtualBptSupply:o,tokenIndexIn:i,swapFee:s,decimalsOut:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=e,h=ie(p,l);let I=c(0);for(let t=0;t<l.length;t++)I=I.plus(l[t]);const f=l[i].div(I),T=l[i].plus(m).div(l[i]),x=c(1).plus(T.minus(c(1)).times(f)),g=T.minus(x).div(T.minus(c(1))),w=c(t.formatFixed(s,18)),y=m.times(c(1).minus(w.times(g)));l[i]=l[i].plus(y);const k=ie(p,l);return c(t.formatFixed(o,u)).times(k.div(h).minus(c(1)))}function he(e,n){if(e.isZero())return e;const{amp:r,allBalances:o,tokenIndexOut:i,swapFee:s}=n,u=[...o],d=u.length,p=r.div(d**(d-1)),m=e,h=ie(p,u),I=c(t.formatFixed(n.virtualBptSupply,18)),f=I.minus(m).div(I).times(h);let T=c(0);for(let t=0;t<u.length;t++)T=T.plus(u[t]);const x=pe(p,u,f,i),g=u[i].minus(x),w=u[i].div(T),y=c(1).minus(w);return g.times(l.minus(y.times(s.toString()).div(a.WeiPerEther.toString())))}function Ie(e,n,a,r,o,i){const s=n.length,l=ie(e,n);let d=u;for(let t=0;t<s;t++)t!=a&&t!=r&&(d=d.plus(n[t]));const p=n[a],m=n[r],h=c(t.formatFixed(e,3)).times(s**s),I=d.minus(l).times(h).plus(l),f=c(2).times(h).times(p).times(m),T=f.plus(h.times(m).times(m)).plus(I.times(m)),x=f.plus(h.times(p).times(p)).plus(I.times(p));let g;if(o)g=T.div(x);else{const t=c(2).times(h).times(m),e=c(2).times(h).times(p),n=t.plus(e).plus(I),a=c(2).times(T).times(x).times(n).minus(t.times(x.pow(2))).minus(e.times(T.pow(2))),r=T.pow(2).times(x);g=a.div(r),i&&(g=g.times(x).div(T))}return g}function fe(t,e,n,a,r,o,i){const s=e.length,l=ie(t,e);let d=u,p=l.div(s);for(let t=0;t<s;t++)t!=a&&(d=d.plus(e[t]),p=p.times(l).div(e[t].times(s)));const m=e[a],h=c(t.toString()).times(s**s),I=h.times(d),f=oe.minus(h),T=c(2).times(h).times(m).plus(I).plus(f.times(l)),x=p.times(s+1).times(oe).minus(f.times(m)),g=u.minus(x);let w;if(r)w=T.div(x).times(n).div(l);else{const t=c(2).times(h),e=f,a=s*(s+1),r=u.minus(p.times(a).div(l));if(o){const a=t.times(g).div(T.pow(2)),o=c(2).times(e).div(T),s=r.div(g);if(w=a.minus(o).plus(s).times(l).div(n),i){const t=u.minus(T.div(g));w=w.div(t).times(l).div(n)}}else w=c(2).times(e).div(g).minus(r.times(T).div(g.pow(2))).minus(t.div(T)),i&&(w=w.times(T).div(x).times(n).div(l))}return w}function Te(t,e,n){let r=u;for(let e=0;e<t.length;e++)r=r.plus(t[e]);const o=t[e].div(r),i=l.minus(o);return l.minus(i.times(n.toString()).div(a.WeiPerEther.toString()))}var xe;!function(t){t[t.BptToToken=0]="BptToToken",t[t.TokenToBpt=1]="TokenToBpt",t[t.TokenToToken=2]="TokenToToken"}(xe||(xe={}));class ge{static fromPool(t){if(!t.amp)throw new Error("PhantomStablePool missing amp factor");return new ge(t.id,t.address,t.amp,t.swapFee,t.totalShares,t.tokens,t.tokensList)}static removeBPT(t){const e=s(t),n=t.bptIndex;return-1!=n&&(e.allBalances.splice(n,1),e.allBalancesScaled.splice(n,1),n<t.tokenIndexIn&&(e.tokenIndexIn-=1),n<t.tokenIndexOut&&(e.tokenIndexOut-=1)),e}constructor(e,n,a,r,o,i,s){this.poolType=exports.PoolTypes.MetaStable,this.ALMOST_ONE=t.parseFixed("0.99",18),this.id=e,this.address=n,this.amp=t.parseFixed(a,ge.AMP_DECIMALS),this.swapFee=t.parseFixed(r,18),this.totalShares=t.parseFixed(o,18),this.tokens=i,this.tokensList=s}parsePoolPairData(e,r){const o=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(o<0)throw"Pool does not contain tokenIn";const i=this.tokens[o],s=c(i.balance).times(c(i.priceRate)).dp(i.decimals).toString(),u=i.decimals,l=t.parseFixed(i.priceRate,18),d=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(r)));if(d<0)throw"Pool does not contain tokenOut";const p=this.tokens[d],m=c(p.balance).times(c(p.priceRate)).dp(p.decimals).toString(),h=p.decimals,I=t.parseFixed(p.priceRate,18),f=this.tokens.map((({balance:t,priceRate:e})=>c(t).times(c(e)))),T=this.tokens.map((({balance:e,priceRate:n})=>t.parseFixed(e,18).mul(t.parseFixed(n,18)).div(a.WeiPerEther)));let x;x=w(e,this.address)?xe.BptToToken:w(r,this.address)?xe.TokenToBpt:xe.TokenToToken;const g=this.tokensList.indexOf(this.address),y=this.totalShares,k={id:this.id,address:this.address,poolType:this.poolType,pairType:x,bptIndex:g,tokenIn:e,tokenOut:r,balanceIn:t.parseFixed(s,u),balanceOut:t.parseFixed(m,h),swapFee:this.swapFee,allBalances:f,allBalancesScaled:T,amp:this.amp,tokenIndexIn:o,tokenIndexOut:d,decimalsIn:Number(u),decimalsOut:Number(h),tokenInPriceRate:l,tokenOutPriceRate:I,virtualBptSupply:y};return ge.removeBPT(k)}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){return exports.SwapTypes.SwapExactIn,c(t.formatFixed(e.balanceOut.mul(this.ALMOST_ONE).div(e.tokenOutPriceRate),e.decimalsOut))}updateTokenBalanceForPool(e,n){const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");if(w(this.address,e)){const e=t.parseFixed(a.balance,a.decimals).sub(n),r=this.totalShares.add(e);this.updateTotalShares(r)}a.balance=t.formatFixed(n,a.decimals)}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){try{if(n.isZero())return u;const r=this.subtractSwapFeeAmount(t.parseFixed(n.dp(18).toString(),18),e.swapFee).mul(e.tokenInPriceRate).div(a.WeiPerEther);let o;if(e.pairType===xe.TokenToBpt){const t=Array(e.allBalancesScaled.length).fill(BigInt(0));t[e.tokenIndexIn]=r.toBigInt(),o=pt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),t,e.virtualBptSupply.toBigInt(),BigInt(0))}else o=e.pairType===xe.BptToToken?ht(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexOut,r.toBigInt(),e.virtualBptSupply.toBigInt(),BigInt(0)):lt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,r.toBigInt(),BigInt(0));const i=t.BigNumber.from(o).mul(a.WeiPerEther).div(e.tokenOutPriceRate);return c(t.formatFixed(i,18))}catch(t){return u}}_tokenInForExactTokenOut(e,n){try{if(n.isZero())return u;const r=t.parseFixed(n.dp(18).toString(),18).mul(e.tokenOutPriceRate).div(a.WeiPerEther);let o;if(e.pairType===xe.TokenToBpt)o=ct(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,r.toBigInt(),e.virtualBptSupply.toBigInt(),BigInt(0));else if(e.pairType===xe.BptToToken){const t=Array(e.allBalancesScaled.length).fill(BigInt(0));t[e.tokenIndexOut]=r.toBigInt(),o=mt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),t,e.virtualBptSupply.toBigInt(),BigInt(0))}else o=dt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,r.toBigInt(),BigInt(0));const i=t.BigNumber.from(o).mul(a.WeiPerEther).div(e.tokenInPriceRate),s=this.addSwapFeeAmount(i,e.swapFee);return c(t.formatFixed(s,18))}catch(t){return console.error(`PhantomStable _evminGivenOut: ${t.message}`),u}}_calcTokensOutGivenExactBptIn(t){throw new Error("PhantomPool does not have exit pool (_calcTokensOutGivenExactBptIn).")}_calcBptOutGivenExactTokensIn(t){throw new Error("PhantomPool does not have join pool (_calcBptOutGivenExactTokensIn).")}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){const r=c(t.formatFixed(e.tokenInPriceRate,18)),o=c(t.formatFixed(e.tokenOutPriceRate,18)),i=n.times(c(t.formatFixed(e.tokenInPriceRate,18)));let s;return s=e.pairType===xe.TokenToBpt?function(e,n){const{amp:a,allBalances:r,virtualBptSupply:o,decimalsOut:i,tokenIndexIn:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=Te(l,s,u);let h=c(t.formatFixed(o,i));l[s]=l[s].plus(e.times(m)),h=h.plus(me(e,n));let I=fe(p,l,h,s,!0,!0,!1);return I=c(1).div(I.times(m)),I}(i,e):e.pairType===xe.BptToToken?function(e,n){const{amp:a,allBalances:r,virtualBptSupply:o,tokenIndexOut:i,swapFee:s,decimalsIn:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=he(e,n),h=Te(l,i,s);let I=c(t.formatFixed(o,u));return l[i]=l[i].minus(m.div(h)),I=I.minus(e),fe(p,l,I,i,!0,!1,!1).div(h)}(i,e):function(t,e){const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,u=[...r],d=u.length,p=n.div(d**(d-1));u[o]=u[o].plus(t.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),u[i]=u[i].minus(se(t,e));let c=Ie(p,u,o,i,!0,!1);return c=l.div(c.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),c}(i,e),s.div(r).times(o)}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){const r=c(t.formatFixed(e.tokenInPriceRate,18)),o=c(t.formatFixed(e.tokenOutPriceRate,18)),i=n.times(t.formatFixed(e.tokenOutPriceRate,18));let s;return s=e.pairType===xe.TokenToBpt?function(e,n){const{amp:a,allBalances:r,virtualBptSupply:o,tokenIndexIn:i,decimalsOut:s,swapFee:u}=n,d=[...r],p=d.length,m=a.div(p**(p-1)),h=le(e,n),I=Te(d,i,u);d[i]=d[i].plus(h.times(I));let f=c(t.formatFixed(o,s));f=f.plus(e);let T=fe(m,d,f,i,!0,!0,!0);return T=l.div(T.times(I)),T}(i,e):e.pairType===xe.BptToToken?function(e,n){const{amp:a,allBalances:r,virtualBptSupply:o,decimalsIn:i,tokenIndexOut:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=Te(l,s,u);l[s]=l[s].minus(e.div(m));let h=c(t.formatFixed(o,i));return h=h.minus(de(e,n)),fe(p,l,h,s,!0,!1,!0).div(m)}(i,e):function(t,e){const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,u=[...r],d=u.length,p=n.div(d**(d-1)),c=ue(t,e).times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString());u[o]=u[o].plus(c),u[i]=u[i].minus(t);let m=Ie(p,u,o,i,!0,!0);return m=l.div(m.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),m}(i,e),s.div(r).times(o)}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,n){const r=c(t.formatFixed(e.tokenOutPriceRate,18)),o=n.times(t.formatFixed(e.tokenInPriceRate,18));let i;return i=e.pairType===xe.TokenToBpt?function(e,n){const{amp:a,allBalances:r,balanceOut:o,decimalsOut:i,tokenIndexIn:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=Te(l,s,u);l[s]=l[s].plus(e.times(m));let h=c(t.formatFixed(o,i));return h=h.plus(me(e,n)),fe(p,l,h,s,!1,!0,!1)}(o,e):e.pairType===xe.BptToToken?function(e,n){const{amp:a,allBalances:r,balanceIn:o,decimalsIn:i,tokenIndexOut:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=he(e,n),h=Te(l,s,u);l[s]=l[s].minus(m.div(h));let I=c(t.formatFixed(o,i));return I=I.minus(e),fe(p,l,I,s,!1,!1,!1).div(h)}(o,e):function(t,e){const{amp:n,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=e,u=[...r],l=u.length,d=n.div(l**(l-1));return u[o]=u[o].plus(t.times(a.WeiPerEther.sub(s).toString()).div(a.WeiPerEther.toString())),u[i]=u[i].minus(se(t,e)),Ie(d,u,o,i,!1,!1)}(o,e),i.times(r)}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,n){const a=c(t.formatFixed(e.tokenInPriceRate,18)),r=c(t.formatFixed(e.tokenOutPriceRate,18)),o=n.times(t.formatFixed(e.tokenOutPriceRate,18));let i;return i=e.pairType===xe.TokenToBpt?function(e,n){const{amp:a,allBalances:r,balanceOut:o,decimalsOut:i,tokenIndexIn:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=le(e,n),h=Te(l,s,u);l[s]=l[s].plus(m.times(h));let I=c(t.formatFixed(o,i));return I=I.plus(e),fe(p,l,I,s,!1,!0,!0).div(h)}(o,e):e.pairType===xe.BptToToken?function(e,n){const{amp:a,allBalances:r,balanceIn:o,decimalsIn:i,tokenIndexOut:s,swapFee:u}=n,l=[...r],d=l.length,p=a.div(d**(d-1)),m=de(e,n),h=Te(l,s,u);l[s]=l[s].minus(e.div(h));let I=c(t.formatFixed(o,i));return I=I.minus(m),fe(p,l,I,s,!1,!1,!0).div(h.pow(2))}(o,e):function(e,n){const{amp:a,allBalances:r,tokenIndexIn:o,tokenIndexOut:i,swapFee:s}=n,u=[...r],l=u.length,d=a.div(l**(l-1)),p=c(t.formatFixed(s,18)),m=ue(e,n).times(c(1).minus(p));u[o]=u[o].plus(m),u[i]=u[i].minus(e);const h=c(1).minus(p);return Ie(d,u,o,i,!1,!0).div(h)}(o,e),i.div(a).times(r).times(r)}subtractSwapFeeAmount(t,e){const n=t.mul(e).add(a.WeiPerEther.sub(1)).div(a.WeiPerEther);return t.sub(n)}addSwapFeeAmount(t,e){const n=a.WeiPerEther.sub(e);return t.mul(a.WeiPerEther).add(n.sub(1)).div(n)}}ge.AMP_DECIMALS=3;class we extends ge{constructor(t,e,n,a,r,o,i){super(t,e,n,a,r,o,i)}static fromPool(t){if(!t.amp)throw new Error("ComposableStablePool missing amp factor");return new we(t.id,t.address,t.amp,t.swapFee,t.totalShares,t.tokens,t.tokensList)}_exactTokenInForTokenOut(e,n){try{if(n.isZero())return u;const r=t.parseFixed(n.dp(18).toString(),18).mul(e.tokenInPriceRate).div(a.WeiPerEther);let o;if(e.pairType===xe.TokenToBpt){const t=Array(e.allBalancesScaled.length).fill(BigInt(0));t[e.tokenIndexIn]=r.toBigInt(),o=pt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),t,e.virtualBptSupply.toBigInt(),e.swapFee.toBigInt())}else o=e.pairType===xe.BptToToken?ht(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexOut,r.toBigInt(),e.virtualBptSupply.toBigInt(),e.swapFee.toBigInt()):lt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,r.toBigInt(),e.swapFee.toBigInt());const i=t.BigNumber.from(o).mul(a.WeiPerEther).div(e.tokenOutPriceRate);return c(t.formatFixed(i,18)).dp(e.decimalsOut)}catch(t){return u}}_tokenInForExactTokenOut(e,n){try{if(n.isZero())return u;const r=t.parseFixed(n.dp(18).toString(),18).mul(e.tokenOutPriceRate).div(a.WeiPerEther);let o;if(e.pairType===xe.TokenToBpt)o=ct(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,r.toBigInt(),e.virtualBptSupply.toBigInt(),e.swapFee.toBigInt());else if(e.pairType===xe.BptToToken){const t=Array(e.allBalancesScaled.length).fill(BigInt(0));t[e.tokenIndexOut]=r.toBigInt(),o=mt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),t,e.virtualBptSupply.toBigInt(),e.swapFee.toBigInt())}else o=dt(this.amp.toBigInt(),e.allBalancesScaled.map((t=>t.toBigInt())),e.tokenIndexIn,e.tokenIndexOut,r.toBigInt(),e.swapFee.toBigInt());const i=t.BigNumber.from(o).mul(a.WeiPerEther).div(e.tokenInPriceRate);return c(t.formatFixed(i,18)).dp(e.decimalsOut)}catch(t){return console.error(`PhantomStable _evminGivenOut: ${t.message}`),u}}_calcTokensOutGivenExactBptIn(e){const n=this.tokens.filter((t=>!w(t.address,this.address))),a=n.map((t=>k(t)));try{const r=It(a,e.toBigInt(),this.totalShares.toBigInt());return r.map(((t,e)=>E(t,n[e]))).map((e=>t.BigNumber.from(e)))}catch(t){return new Array(a.length).fill(u)}}_calcBptOutGivenExactTokensIn(e){try{const n=new Array(e.length).fill(BigInt(0)),a=new Array(e.length).fill(BigInt(0));this.tokens.filter((t=>!w(t.address,this.address))).forEach(((t,r)=>{n[r]=b(BigInt(e[r].toString()),t),a[r]=k(t)}));const r=pt(this.amp.toBigInt(),a,n,this.totalShares.toBigInt(),this.swapFee.toBigInt());return t.BigNumber.from(r.toString())}catch(t){return console.error(t),a.Zero}}}const ye=t.BigNumber.from("316227766016837933"),ke=t.BigNumber.from("31622776601683793"),be=t.BigNumber.from("3162277660168379"),Ee=t.BigNumber.from("316227766016837"),Se=t.BigNumber.from("31622776601683"),Fe=t.BigNumber.from("3162277660168"),Oe=t.BigNumber.from("316227766016"),Be=t.BigNumber.from("31622776601"),ve=t.BigNumber.from("3162277660"),Pe=t.BigNumber.from(10).pow(38),_e=t.BigNumber.from(10).pow(8),Ae=t.BigNumber.from("999999000000000000");function Ne(t,e){return t.mul(e).sub(1).div(a.WeiPerEther).add(1)}function De(t,e){return t.mul(a.WeiPerEther).sub(1).div(e).add(1)}function We(t,e){return t.mul(e).div(a.WeiPerEther)}function Ue(t,e){return t.mul(a.WeiPerEther).div(e)}function Le(t,e){return t.mul(e).div(Pe)}function Me(t,e){if(e.isZero())throw new Error("ZERO DIVISION");return t.mul(Pe).div(e)}function Re(t,e){return t.mul(e).div(a.WeiPerEther)}function Ce(t,e){if(e.isZero())throw new Error("ZERO DIVISION");return t.mul(a.WeiPerEther).div(e)}function Ge(e,n){const r=e.mul(n);return r.gt(0)?r.sub(1).div(a.WeiPerEther).add(1):r.lt(0)?r.add(1).div(a.WeiPerEther).sub(1):t.BigNumber.from(0)}function He(e,n){if(n.isZero())throw new Error("ZERO DIVISION");return n.lt(0)&&(n=n.mul(-1),e=e.mul(-1)),e.isZero()?t.BigNumber.from(0):e.gt(0)?e.mul(a.WeiPerEther).sub(1).div(n).add(1):e.mul(a.WeiPerEther).add(1).div(n.sub(1))}function qe(e,n){const a=t.BigNumber.from(10).pow(19),r=n.div(a),o=n.isNegative()?n.mul(-1).mod(a).mul(-1):n.mod(a),i=e.mul(r),s=e.mul(o);return i.lte(0)&&s.lte(0)?i.add(s.div(a)).div(a):i.add(s.div(a)).sub(1).div(a).add(1)}function Ze(e,n){const a=t.BigNumber.from(10).pow(19),r=n.div(a),o=n.isNegative()?n.mul(-1).mod(a).mul(-1):n.mod(a),i=e.mul(r),s=e.mul(o);return i.gte(0)&&s.gte(0)?i.add(s.div(a)).div(a):i.add(s.div(a)).add(1).div(a).sub(1)}function Xe(e,n){if(e.isZero())return t.BigNumber.from(0);let r=function(e){return e.gte(a.WeiPerEther)?t.BigNumber.from(2).pow(function(e){let n=0;for(let a=128;a>=2;a/=2){const r=t.BigNumber.from(2).pow(a);e.gte(r)&&(e=e.div(r),n+=a/2)}return n}(e.div(a.WeiPerEther))).mul(a.WeiPerEther):e.lte("10")?ve:e.lte("100")?t.BigNumber.from("10000000000"):e.lte("1000")?Be:e.lte("10000")?t.BigNumber.from("100000000000"):e.lte("100000")?Oe:e.lte("1000000")?t.BigNumber.from("1000000000000"):e.lte("10000000")?Fe:e.lte("100000000")?t.BigNumber.from("10000000000000"):e.lte("1000000000")?Se:e.lte("10000000000")?t.BigNumber.from("100000000000000"):e.lte("100000000000")?Ee:e.lte("1000000000000")?t.BigNumber.from("1000000000000000"):e.lte("10000000000000")?be:e.lte("100000000000000")?t.BigNumber.from("10000000000000000"):e.lte("1000000000000000")?ke:e.lte("10000000000000000")?t.BigNumber.from("100000000000000000"):e.lte("100000000000000000")?ye:e}(e);for(const t of new Array(7).fill(0))r=r.add(e.mul(a.WeiPerEther).div(r)).div(2);const o=r.mul(r).div(a.WeiPerEther);if(!o.lte(e.add(Ne(r,n)))||!o.gte(e.sub(Ne(r,n))))throw new Error("GyroEPool: sqrt failed");return r}function $e(t,e,n){return[Ue(t,n),We(t,e)]}function je(t,e,n){const[a,r,o,i]=ze(t,e,n);return Ve(a,r,o,i)}function ze(t,e,n){const r=a.WeiPerEther.sub(Ue(e,n)),o=Ue(t[1],n),i=We(t[0],e),s=o.add(i),u=We(t[0],t[1]);let l=We(We(We(t[0],t[0]),e),e);const d=Ue(We(We(We(t[0],t[1]),a.WeiPerEther.mul(2)),e),n),p=Ue(We(t[1],t[1]),Ne(n,n));return l=l.add(d).add(p),[r,s,l,u]}function Ve(e,n,r,o){const i=Ne(e,a.WeiPerEther.mul(2)),s=We(We(o,a.WeiPerEther.mul(4)),e),u=Xe(r.add(s),t.BigNumber.from(5));return Ue(n.add(u),i)}function Ye(t,e,n,r,o){const i=t.add(Ne(r,a.WeiPerEther.add(2))),s=e.add(We(o,a.WeiPerEther.sub(1))),u=Ue(We(s,n),i.add(n));if(u.gt(e))throw new Error("ASSET_BOUNDS_EXCEEDED");return u}function Ke(t,e,n,r,o){if(n.gt(e))throw new Error("ASSET_BOUNDS_EXCEEDED");const i=t.add(Ne(r,a.WeiPerEther.add(2))),s=e.add(We(o,a.WeiPerEther.sub(1)));return De(Ne(i,n),s.sub(n))}function Je(t,e,n,r,o,i){const s=a.WeiPerEther.sub(i);return Ue(t[0].add(r).add(We(s,e)),We(s,t[1].add(o).sub(n)))}function Qe(e,n,r){return Ue(t.BigNumber.from(2).mul(a.WeiPerEther),e[1].add(r).sub(n))}function tn(e,n,r,o,i,s){const u=t.BigNumber.from(2).mul(a.WeiPerEther),l=a.WeiPerEther.sub(s),d=e[0].add(o).add(We(l,n)),p=e[1].add(i),c=We(p.sub(r),p.sub(r));return We(Ue(u,l),Ue(d,c))}var en=Object.freeze({__proto__:null,_calcInGivenOut:Ke,_calcOutGivenIn:Ye,_calculateInvariant:je,_calculateNewSpotPrice:Je,_calculateQuadratic:Ve,_calculateQuadraticTerms:ze,_derivativeSpotPriceAfterSwapExactTokenInForTokenOut:Qe,_derivativeSpotPriceAfterSwapTokenInForExactTokenOut:tn,_findVirtualParams:$e,_getNormalizedLiquidity:function(t,e){return t[1].add(e).div(2)}});function nn(e,n){const r=n.map((e=>t.parseFixed("1",e)));return e.map(((t,e)=>t.mul(a.WeiPerEther).div(r[e])))}function an(t,e){const n=t.mul(e).div(a.WeiPerEther);return t.sub(n)}function rn(t,e){return t.mul(a.WeiPerEther).div(a.WeiPerEther.sub(e))}class on{static fromPool(t){if(!t.sqrtAlpha||!t.sqrtBeta)throw new Error("Pool missing Gyro2 sqrtAlpha and/or sqrtBeta params");return new on(t.id,t.address,t.swapFee,t.totalShares,t.tokens,t.tokensList,t.sqrtAlpha,t.sqrtBeta)}constructor(t,e,n,a,r,o,i,s){this.poolType=exports.PoolTypes.Gyro2,this.id=t,this.address=e,this.swapFee=y(n,18),this.totalShares=y(a,18),this.tokens=r,this.tokensList=o,this.sqrtAlpha=y(i,18),this.sqrtBeta=y(s,18)}parsePoolPairData(t,e){const r=this.tokens.findIndex((e=>n.getAddress(e.address)===n.getAddress(t)));if(r<0)throw"Pool does not contain tokenIn";const o=this.tokens[r],i=o.balance,s=o.decimals,u=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(u<0)throw"Pool does not contain tokenOut";const l=this.tokens[u],d=l.balance,p=l.decimals,c=0===r;return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:t,tokenOut:e,decimalsIn:Number(s),decimalsOut:Number(p),balanceIn:y(i,s),balanceOut:y(d,p),swapFee:this.swapFee,sqrtAlpha:c?this.sqrtAlpha:Ue(a.WeiPerEther,this.sqrtBeta),sqrtBeta:c?this.sqrtBeta:Ue(a.WeiPerEther,this.sqrtAlpha)}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){if(n===exports.SwapTypes.SwapExactIn){const n=nn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=We(je(n,e.sqrtAlpha,e.sqrtBeta),Ue(a.WeiPerEther,e.sqrtAlpha).sub(Ue(a.WeiPerEther,e.sqrtBeta))),o=Ue(r.sub(n[0]),a.WeiPerEther.sub(e.swapFee));return c(t.formatFixed(We(o,Ae),18))}return c(t.formatFixed(We(e.balanceOut,Ae),e.decimalsOut))}updateTokenBalanceForPool(e,n){if(w(this.address,e))this.updateTotalShares(n);else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){try{const a=nn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=je(a,e.sqrtAlpha,e.sqrtBeta),[o,i]=$e(r,e.sqrtAlpha,e.sqrtBeta),s=an(y(n.toString(),18),e.swapFee),u=Ye(a[0],a[1],s,o,i);return c(t.formatFixed(u,18))}catch(t){return c(0)}}_tokenInForExactTokenOut(e,n){try{const a=y(n.toString(),18),r=nn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),o=je(r,e.sqrtAlpha,e.sqrtBeta),[i,s]=$e(o,e.sqrtAlpha,e.sqrtBeta),u=rn(Ke(r[0],r[1],a,i,s),e.swapFee);return c(t.formatFixed(u,18))}catch(t){return c(0)}}_calcTokensOutGivenExactBptIn(t){return new Array(this.tokens.length).fill(a.Zero)}_calcBptOutGivenExactTokensIn(t){return a.Zero}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){try{const a=nn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=je(a,e.sqrtAlpha,e.sqrtBeta),[o,i]=$e(r,e.sqrtAlpha,e.sqrtBeta),s=y(n.toString(),18),u=an(s,e.swapFee),l=Je(a,s,Ye(a[0],a[1],u,o,i),o,i,e.swapFee);return c(t.formatFixed(l,18))}catch(t){return c(0)}}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){try{const a=y(n.toString(),18),r=nn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),o=je(r,e.sqrtAlpha,e.sqrtBeta),[i,s]=$e(o,e.sqrtAlpha,e.sqrtBeta),u=Ke(r[0],r[1],a,i,s),l=Je(r,rn(u,e.swapFee),a,i,s,e.swapFee);return c(t.formatFixed(l,18))}catch(t){return c(0)}}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,n){try{const a=nn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=je(a,e.sqrtAlpha,e.sqrtBeta),[o,i]=$e(r,e.sqrtAlpha,e.sqrtBeta),s=an(y(n.toString(),18),e.swapFee),u=Qe(a,Ye(a[0],a[1],s,o,i),i);return c(t.formatFixed(u,18))}catch(t){return c(0)}}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,n){try{const a=y(n.toString(),18),r=nn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),o=je(r,e.sqrtAlpha,e.sqrtBeta),[i,s]=$e(o,e.sqrtAlpha,e.sqrtBeta),u=Ke(r[0],r[1],a,i,s),l=tn(r,rn(u,e.swapFee),a,i,s,e.swapFee);return c(t.formatFixed(l,18))}catch(t){return c(0)}}}const sn=t.BigNumber.from(10).pow(29).mul(487),un=t.BigNumber.from(10).pow(9),ln=8,dn=5;function pn(t,e){const[n,a,r,o]=cn(t,e);return mn(n,a,r,o,e)}function cn(t,e){const n=We(e,e),r=We(n,e),o=a.WeiPerEther.sub(r),i=We(We(t[0].add(t[1]).add(t[2]),e),e),s=We(t[0],t[1]).add(We(t[1],t[2])).add(We(t[2],t[0]));return[o,i,We(s,e),We(We(t[0],t[1]),t[2])]}function mn(t,e,n,a,r){let o=hn(t,e,n);return o=In(t,e,n,a,r,o),o}function hn(e,n,r){const o=Ne(n,n).add(Ne(Ne(e,r),a.WeiPerEther.mul(3)));return Ne(De(n,e.mul(3)).add(De(Xe(o,t.BigNumber.from(5)),e.mul(3))),a.WeiPerEther.sub(e).gte(a.WeiPerEther.div(2))?a.WeiPerEther.mul(3).div(2):a.WeiPerEther.mul(2))}function In(e,n,a,r,o,i){let s=t.BigNumber.from(0);for(let u=0;u<255;++u){const[l,d]=fn(e,n,a,r,o,i);if(l.lte(1)||u>=dn&&d)return i;if(u>=dn&&l.gte(s.div(t.BigNumber.from(ln))))return i;s=l,i=d?i.add(l):i.sub(l)}throw new Error("Gyro3Pool: Newton Method did not converge on required invariant")}function fn(e,n,r,o,i,s){let u=t.BigNumber.from(0);u=We(s,s).mul(3),u=u.sub(We(We(We(u,i),i),i)),u=u.sub(We(s,n).mul(2)).sub(r);const l=function(e,n,r){let o=t.BigNumber.from(0);if(e.lte(sn))o=e.mul(e).div(a.WeiPerEther).mul(e).div(a.WeiPerEther),o=o.sub(o.mul(n).div(a.WeiPerEther).mul(n).div(a.WeiPerEther).mul(n).div(a.WeiPerEther)),o=o.mul(a.WeiPerEther).div(r);else{o=e.mul(e).div(a.WeiPerEther),o=o.mul(e.div(a.WeiPerEther)).add(o.mul(e.mod(a.WeiPerEther)).div(a.WeiPerEther));let t=o;for(let e=0;e<3;e++)t=t.mul(n.div(un)).div(un).add(t.mul(n.mod(un)));o=o.sub(t),o=o.mul(un).div(r.div(un))}return o}(s,i,u);let d=We(We(s,s),n);d=Ue(d.add(We(s,r)),u),d=d.add(Ue(o,u));const p=d.gte(l);return[p?d.sub(l):l.sub(d),p]}function Tn(t,e,n,r){const o=t.add(Ne(r,a.WeiPerEther.add(2))),i=e.add(We(r,a.WeiPerEther.sub(1))).mul(n).div(o.add(n));if(i.gt(e))throw new Error("ASSET_BOUNDS_EXCEEDED");return i}function xn(t,e,n,r){if(n.gt(e))throw new Error("ASSET_BOUNDS_EXCEEDED");const o=t.add(Ne(r,a.WeiPerEther.add(2))),i=e.add(We(r,a.WeiPerEther.sub(1)));return De(Ne(o,n),i.sub(n))}function gn(t,e,n,r,o){const i=a.WeiPerEther.sub(o);return Ue(t[0].add(r).add(We(i,e)),We(i,t[1].add(r).sub(n)))}function wn(e,n,r){return Ue(t.BigNumber.from(2).mul(a.WeiPerEther),e[1].add(r).sub(n))}function yn(e,n,r,o,i){const s=t.BigNumber.from(2).mul(a.WeiPerEther),u=a.WeiPerEther.sub(i),l=e[0].add(o).add(We(u,n)),d=e[1].add(o),p=We(d.sub(r),d.sub(r));return We(Ue(s,u),Ue(l,p))}var kn=Object.freeze({__proto__:null,_calcInGivenOut:xn,_calcNewtonDelta:fn,_calcOutGivenIn:Tn,_calculateCubic:mn,_calculateCubicStartingPoint:hn,_calculateCubicTerms:cn,_calculateInvariant:pn,_calculateNewSpotPrice:gn,_derivativeSpotPriceAfterSwapExactTokenInForTokenOut:wn,_derivativeSpotPriceAfterSwapTokenInForExactTokenOut:yn,_getNormalizedLiquidity:function(t,e){return t[1].add(e).div(2)},_runNewtonIteration:In});class bn{static findToken(t,e,a){const r=t.find((t=>n.getAddress(t.address)===n.getAddress(e)));if(!r)throw new Error(a);return r}static fromPool(t){if(!t.root3Alpha)throw new Error("Pool missing root3Alpha");if(y(t.root3Alpha,18).lte(0)||y(t.root3Alpha,18).gte(a.WeiPerEther))throw new Error("Invalid root3Alpha parameter");if(3!==t.tokens.length)throw new Error("Gyro3Pool must contain three tokens only");return new bn(t.id,t.address,t.swapFee,t.totalShares,t.tokens,t.tokensList,t.root3Alpha)}constructor(t,e,n,a,r,o,i){this.poolType=exports.PoolTypes.Gyro3,this.id=t,this.address=e,this.swapFee=y(n,18),this.totalShares=y(a,18),this.tokens=r,this.tokensList=o,this.root3Alpha=y(i,18)}parsePoolPairData(t,e){const a=bn.findToken(this.tokens,t,"Pool does not contain tokenIn"),r=a.balance,o=a.decimals,i=bn.findToken(this.tokens,e,"Pool does not contain tokenOut"),s=i.balance,u=i.decimals,l=this.tokens.find((a=>n.getAddress(a.address)!==n.getAddress(e)&&n.getAddress(a.address)!==n.getAddress(t)));if(!l)throw new Error("Pool does not contain a valid third token");const d=l.balance,p=l.decimals;return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:t,tokenOut:e,decimalsIn:Number(o),decimalsOut:Number(u),decimalsTertiary:Number(p),balanceIn:y(r,o),balanceOut:y(s,u),balanceTertiary:y(d,p),swapFee:this.swapFee}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){if(n===exports.SwapTypes.SwapExactIn){const n=nn([e.balanceIn,e.balanceOut,e.balanceTertiary],[e.decimalsIn,e.decimalsOut,e.decimalsTertiary]),r=We(pn(n,this.root3Alpha),this.root3Alpha),o=Ue(We(n[0].add(r),n[1].add(r)),r).sub(r),i=Ue(o.sub(n[0]),a.WeiPerEther.sub(e.swapFee));return c(t.formatFixed(We(i,Ae),18))}return c(t.formatFixed(We(e.balanceOut,Ae),e.decimalsOut))}updateTokenBalanceForPool(e,n){if(w(this.address,e))this.updateTotalShares(n);else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){try{const a=[e.balanceIn,e.balanceOut,e.balanceTertiary],r=nn(a,[e.decimalsIn,e.decimalsOut,e.decimalsTertiary]),o=We(pn(r,this.root3Alpha),this.root3Alpha),i=an(y(n.toString(),18),e.swapFee),s=Tn(r[0],r[1],i,o);return c(t.formatFixed(s,18))}catch(t){return c(0)}}_tokenInForExactTokenOut(e,n){try{const a=y(n.toString(),18),r=[e.balanceIn,e.balanceOut,e.balanceTertiary],o=nn(r,[e.decimalsIn,e.decimalsOut,e.decimalsTertiary]),i=We(pn(o,this.root3Alpha),this.root3Alpha),s=rn(xn(o[0],o[1],a,i),e.swapFee);return c(t.formatFixed(s,18))}catch(t){return c(0)}}_calcTokensOutGivenExactBptIn(t){return new Array(this.tokens.length).fill(a.Zero)}_calcBptOutGivenExactTokensIn(t){return a.Zero}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){try{const a=[e.balanceIn,e.balanceOut,e.balanceTertiary],r=nn(a,[e.decimalsIn,e.decimalsOut,e.decimalsTertiary]),o=We(pn(r,this.root3Alpha),this.root3Alpha),i=y(n.toString(),18),s=an(i,e.swapFee),u=gn(r,i,Tn(r[0],r[1],s,o),o,e.swapFee);return c(t.formatFixed(u,18))}catch(t){return c(0)}}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){try{const a=y(n.toString(),18),r=[e.balanceIn,e.balanceOut,e.balanceTertiary],o=nn(r,[e.decimalsIn,e.decimalsOut,e.decimalsTertiary]),i=We(pn(o,this.root3Alpha),this.root3Alpha),s=xn(o[0],o[1],a,i),u=gn(o,rn(s,e.swapFee),a,i,e.swapFee);return c(t.formatFixed(u,18))}catch(t){return c(0)}}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,n){try{const a=[e.balanceIn,e.balanceOut,e.balanceTertiary],r=nn(a,[e.decimalsIn,e.decimalsOut,e.decimalsTertiary]),o=We(pn(r,this.root3Alpha),this.root3Alpha),i=an(y(n.toString(),18),e.swapFee),s=wn(r,Tn(r[0],r[1],i,o),o);return c(t.formatFixed(s,18))}catch(t){return c(0)}}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,n){try{const a=y(n.toString(),18),r=[e.balanceIn,e.balanceOut,e.balanceTertiary],o=nn(r,[e.decimalsIn,e.decimalsOut,e.decimalsTertiary]),i=We(pn(o,this.root3Alpha),this.root3Alpha),s=xn(o[0],o[1],a,i),u=yn(o,rn(s,e.swapFee),a,i,e.swapFee);return c(t.formatFixed(u,18))}catch(t){return c(0)}}}const En=t.BigNumber.from(10).pow(34),Sn=t.BigNumber.from(10).pow(37).mul(3);function Fn(t,e){const n=We(t,e);return t.sub(n)}function On(t,e){return Ue(t,a.WeiPerEther.sub(e))}function Bn(e,n){const r=n.map((e=>t.parseFixed("1",e)));return e.map(((t,e)=>t.mul(a.WeiPerEther).div(r[e])))}function vn(t,e,n){return n?[t,e]:[e,t]}function Pn(e,n,a,r){let o=function(t,e,n,a){let r=Ge(Ge(Ge(t,t),n.c),n.c).add(Ge(Ge(Ge(e,e),n.s),n.s));r=r.sub(Re(Re(Re(t,e),n.c.mul(2)),n.s));const o=Le(a.u,a.u).add(Ce(Le(a.u.mul(2),a.v),n.lambda)).add(Ce(Ce(Le(a.v,a.v),n.lambda),n.lambda));let i=Ze(r.mul(-1),o);return i=i.add(Ze(Ce(Ce(r.sub(9),n.lambda),n.lambda),Me(Pe,a.dSq))),i}(e,n,a,r).add(function(t,e,n,a){let r=Re(Re(Re(t,t).sub(Ge(e,e)),n.c.mul(2)),n.s);const o=Re(e,t.mul(2));r=r.add(Re(Re(o,n.c),n.c)).sub(Re(Re(o,n.s),n.s));let i=Le(a.z,a.u).add(Ce(Ce(Le(a.w,a.v),n.lambda),n.lambda));i=i.add(Ce(Le(a.w,a.u).add(Le(a.z,a.v)),n.lambda)),i=Me(i,Le(Le(Le(a.dSq,a.dSq),a.dSq),a.dSq));const s=Ze(r,i);return s}(e,n,a,r));o=o.add(function(t,e,n,a){let r=Ge(Ge(Ge(t,t),n.s),n.s).add(Ge(Ge(Ge(e,e),n.c),n.c));r=r.add(Ge(Ge(Ge(t,e),n.s.mul(2)),n.c));let o=Le(a.z,a.z).add(Ce(Ce(Le(a.w,a.w),n.lambda),n.lambda));o=o.add(Ce(Le(a.z.mul(2),a.w),n.lambda)),o=Me(o,Le(Le(Le(a.dSq,a.dSq),a.dSq),a.dSq));let i=Ze(r.mul(-1),o);return i=i.add(Ze(r.sub(9),Me(Pe,a.dSq))),i}(e,n,a,r));const i=Ge(e,e).add(Ge(n,n)).div(Pe);return o=o.gt(0)?Xe(o,t.BigNumber.from(5)):t.BigNumber.from(0),[o,i]}function _n(e,n,a,r,o){if(0===o){const o=function(e,n,a){const r=Me(n.tauBeta.x.sub(n.tauAlpha.x),n.dSq),o=Me(n.tauBeta.y.sub(n.tauAlpha.y),n.dSq);let i=Ze(Re(Re(a.y,e.lambda),e.c),r);return i=i.add(o.gt(t.BigNumber.from(0))?Re(a.y,e.s):Ze(Ge(a.x,e.s),o)),i}(e,n,a);if(r.gt(En)||r.gt(o))throw new Error("ASSET BOUNDS EXCEEDED")}else{const o=function(e,n,a){const r=Me(n.tauBeta.x.sub(n.tauAlpha.x),n.dSq),o=Me(n.tauBeta.y.sub(n.tauAlpha.y),n.dSq);let i=Ze(Re(Re(a.y,e.lambda),e.s),r);return i=i.add(o.gt(t.BigNumber.from(0))?Re(a.y,e.c):Ze(Ge(a.x,e.c),o)),i}(e,n,a);if(r.gt(En)||r.gt(o))throw new Error("ASSET BOUNDS EXCEEDED")}}function An(t,e,n,a){const r={x:Dn(e,n,a),y:Wn(e,n,a)};return Un(e.lambda,t,e.s,e.c,a,r,n.tauBeta,n.dSq)}function Nn(t,e,n,a){const r={x:Wn(e,n,a),y:Dn(e,n,a)};return Un(e.lambda,t,e.c,e.s,a,r,{x:n.tauAlpha.x.mul(-1),y:n.tauAlpha.y},n.dSq)}function Dn(e,n,a,r){const o=r?n.tauAlpha:n.tauBeta,i=Me(o.x,n.dSq);let s=o.x.gt(t.BigNumber.from(0))?qe(Ge(Ge(a.x,e.lambda),e.c),i):qe(Re(Re(a.y,e.lambda),e.c),i);return s=s.add(qe(Ge(a.x,e.s),Me(o.y,n.dSq))),s}function Wn(e,n,a,r){const o=r?n.tauBeta:n.tauAlpha,i=Me(o.x,n.dSq);let s=o.x.lt(t.BigNumber.from(0))?qe(Ge(Ge(a.x,e.lambda),e.s),i.mul(-1)):qe(Re(Re(a.y.mul(-1),e.lambda),e.s),i);return s=s.add(qe(Ge(a.x,e.c),Me(o.y,n.dSq))),s}function Un(e,n,a,r,o,i,s,u){const l={x:Pe.sub(Ce(Ce(Pe,e),e)),y:Pe.sub(He(He(Pe,e),e))},d={a:t.BigNumber.from(0),b:t.BigNumber.from(0),c:t.BigNumber.from(0)},p=n.sub(i.x);p.gt(t.BigNumber.from(0))?d.b=qe(Re(Re(p.mul(-1),a),r),Me(l.y,u)):d.b=qe(Ge(Ge(p.mul(-1),a),r),Me(l.x,u).add(1));const c={x:Me(Re(Re(l.y,a),a),u),y:Me(Ge(Ge(l.x,a),a),u.add(1)).add(1)};return c.x=Pe.sub(c.x),c.y=Pe.sub(c.y),d.c=Ln(n,o,e,a,r,s,u).mul(-1),d.c=d.c.add(Ze(Re(o.y,o.y),c.y)),d.c=d.c.gt(t.BigNumber.from(0))?Xe(d.c,t.BigNumber.from(5)):t.BigNumber.from(0),d.b.sub(d.c).gt(t.BigNumber.from(0))?d.a=qe(d.b.sub(d.c),Me(Pe,c.y).add(1)):d.a=qe(d.b.sub(d.c),Me(Pe,c.x)),d.a.add(i.y)}function Ln(e,n,a,r,o,i,s){const u={x:Le(s,s),y:Ge(n.x,n.x)},l={a:t.BigNumber.from(0),b:t.BigNumber.from(0),c:t.BigNumber.from(0)};let d=Me(Le(i.x,i.y),u.x);d.gt(t.BigNumber.from(0))?(l.a=Ge(u.y,r.mul(2)),l.a=qe(Ge(l.a,o),d.add(7))):(l.a=Re(Re(n.y,n.y),r.mul(2)),l.a=qe(Re(l.a,o),d)),i.x.lt(t.BigNumber.from(0))?l.b=qe(Ge(Ge(n.x,e),o.mul(2)),Me(i.x,s).mul(-1).add(3)):l.b=qe(Re(Re(n.y.mul(-1),e),o.mul(2)),Me(i.x,s)),l.a=l.a.add(l.b),d=Me(Le(i.y,i.y),u.x).add(7),l.b=Ge(u.y,r),l.b=qe(Ge(l.b,r),d),l.c=qe(Re(Re(n.y.mul(-1),e),r.mul(2)),Me(i.y,s)),l.b=l.b.add(l.c).add(Ge(e,e)),l.b=l.b.gt(t.BigNumber.from(0))?He(l.b,a):Ce(l.b,a),l.a=l.a.add(l.b),l.a=l.a.gt(t.BigNumber.from(0))?He(l.a,a):Ce(l.a,a),d=Me(Le(i.x,i.x),u.x).add(7);return qe(Ge(Ge(u.y,o),o),d).add(l.a)}function Mn(t,e,n,a){const r={x:Dn(e,n,a),y:Wn(e,n,a)};return Cn(e.lambda,t,e.s,e.c,a,r,n.tauBeta,n.dSq)}function Rn(t,e,n,a){const r={x:Wn(e,n,a),y:Dn(e,n,a)};return Cn(e.lambda,t,e.c,e.s,a,r,{x:n.tauAlpha.x.mul(-1),y:n.tauAlpha.y},n.dSq)}function Cn(e,n,a,r,o,i,s,u){const l={x:Pe.sub(Ce(Ce(Pe,e),e)),y:Pe.sub(He(He(Pe,e),e))},d={a:t.BigNumber.from(0),b:t.BigNumber.from(0),c:t.BigNumber.from(0)},p=n.sub(i.x);d.b=qe(Re(a,r),Me(l.y,u));const c={x:Me(Re(Re(l.y,a),a),u),y:Me(Ge(Ge(l.x,a),a),u.add(1)).add(1)};return c.x=Pe.sub(c.x),c.y=Pe.sub(c.y),d.c=Ln(n,o,e,a,r,s,u).mul(-1),d.c=d.c.add(Ze(Re(o.y,o.y),c.y)),d.c=d.c.gt(t.BigNumber.from(0))?Xe(d.c,t.BigNumber.from(5)):t.BigNumber.from(0),d.c=We(We(d.c,e),e),d.c=Ue(p,d.c),d.b.sub(d.c).gt(t.BigNumber.from(0))?d.a=qe(d.b.sub(d.c),Me(Pe,c.y).add(1)):d.a=qe(d.b.sub(d.c),Me(Pe,c.x)),d.a}function Gn(e,n,r,o,i,s){const u=i.y,{c:l,s:d,lambda:p}=n,[c,m]=e,h=Dn(n,r,i),I=Wn(n,r,i),f=a.WeiPerEther.sub(Ue(a.WeiPerEther,We(p,p))),T=a.WeiPerEther.sub(o);let x;return x=Xe(0===s?We(We(u,u),a.WeiPerEther.sub(We(f,We(d,d)))).sub(Ue(We(c.sub(h),c.sub(h)),We(p,p))):We(We(u,u),a.WeiPerEther.sub(We(f,We(l,l)))).sub(Ue(We(m.sub(I),m.sub(I)),We(p,p))),t.BigNumber.from(5)),{x0:c,y0:m,c:l,s:d,lambda:p,a:h,b:I,ls:f,f:T,r:u,R:x}}function Hn(e,n,a){const[r,o]=e;if(r.add(o).gt(En))throw new Error("MAX ASSETS EXCEEDED");const i=function(t,e,n,a){const r=Le(a.dSq,a.dSq),o=Me(Ce(Ce(a.w,n.lambda).add(a.z),n.lambda),r);let i=Ze(Re(t,n.c).sub(Re(e,n.s)),o),s=Re(Re(t,n.lambda),n.s).add(Re(Re(e,n.lambda),n.c));return i=i.add(Ze(s,Me(a.u,r))),s=Re(t,n.s).add(Re(e,n.c)),i=i.add(Ze(s,Me(a.v,r))),i}(r,o,n,a),s=Pn(r,o,n,a),u=s[0];let l=s[1];l=u.gt(0)?He(l.add(1),u.mul(2)):l.gt(0)?Xe(l,t.BigNumber.from(5)):t.BigNumber.from(10).pow(9),l=Ge(n.lambda,r.add(o)).div(Pe).add(l).add(1).mul(20);const d=Me(Pe,function(t,e){const n=Le(Le(e.dSq,e.dSq),e.dSq);let a=Ge(t.lambda,Me(Le(e.u.mul(2),e.v),n));a=a.add(Ge(Ge(Me(Le(e.u.add(1),e.u.add(1)),n),t.lambda),t.lambda)),a=a.add(Me(Le(e.v,e.v),n));const r=He(e.w,t.lambda).add(e.z);return a=a.add(Me(Le(r,r),n)),a}(n,a).sub(Pe)),p=Ze(i.add(u).sub(l),d);if(l=qe(l,d),l=l.add(qe(p,d).mul(n.lambda.mul(n.lambda).div(t.BigNumber.from(10).pow(36))).mul(40).div(Pe)).add(1),p.add(l).gt(Sn))throw new Error("MAX INVARIANT EXCEEDED");return[p,l]}function qn(e,n,a,r,o,i){if(n.lt(_e))return t.BigNumber.from(0);const s=Number(!a),u=Number(a),l=a?An:Nn,d=e[s].add(n);_n(r,o,i,d,s);const p=l(d,r,o,i),c=e[u].sub(p);if(c.lt(0))throw new Error("ASSET BOUNDS EXCEEDED 1");return c}function Zn(e,n,a,r,o,i){if(n.lt(_e))return t.BigNumber.from(0);const s=Number(!a),u=Number(a),l=a?Nn:An;if(n.gt(e[u]))throw new Error("ASSET BOUNDS EXCEEDED 2");const d=l(e[u].sub(n),r,o,i);_n(r,o,i,d,s);const p=d.sub(e[s]);if(p.lt(0))throw new Error("ASSET BOUNDS EXCEEDED 3");return p}function Xn(t,e,n,r,o,i,s){const u=Number(!n),l=a.WeiPerEther.sub(s),d=(n?Mn:Rn)(t[u].add(e),r,o,i);return Ue(a.WeiPerEther,We(d,l))}function $n(t,e,n,r,o,i,s){const u=Number(n),l=a.WeiPerEther.sub(s);return Ue((n?Rn:Mn)(t[u].sub(e),r,o,i),l)}function jn(t,e,n,r,o,i){const s=Number(!e)?function(t,e,n,r,o){const{y0:i,c:s,s:u,lambda:l,b:d,ls:p,R:c}=Gn(t,e,n,r,o,1);return Ue(We(a.WeiPerEther.sub(We(p,We(s,s))),Ue(a.WeiPerEther,We(We(l,l),c)).add(Ue(We(i.sub(d),i.sub(d)),We(We(We(l,l),We(l,l)),We(c,We(c,c)))))),We(We(We(p,u),s).sub(Ue(i.sub(d),We(We(l,l),c))),We(We(p,u),s).sub(Ue(i.sub(d),We(We(l,l),c)))))}(t,n,r,i,o):function(t,e,n,r,o){const{x0:i,c:s,s:u,lambda:l,a:d,ls:p,R:c}=Gn(t,e,n,r,o,0);return Ue(We(a.WeiPerEther.sub(We(p,We(u,u))),Ue(a.WeiPerEther,We(We(l,l),c)).add(Ue(We(i.sub(d),i.sub(d)),We(We(We(l,l),We(l,l)),We(c,We(c,c)))))),We(We(We(p,u),s).sub(Ue(i.sub(d),We(We(l,l),c))),We(We(p,u),s).sub(Ue(i.sub(d),We(We(l,l),c)))))}(t,n,r,i,o);return s}function zn(t,e,n,r,o,i){const s=Number(!e)?function(t,e,n,r,o){const{x0:i,s:s,lambda:u,a:l,ls:d,R:p,f:c}=Gn(t,e,n,r,o,0);return We(Ue(a.WeiPerEther,We(c,a.WeiPerEther.sub(We(d,We(s,s))))),Ue(a.WeiPerEther,We(We(u,u),p)).add(Ue(We(i.sub(l),i.sub(l)),We(We(We(u,u),We(u,u)),We(We(p,p),p)))))}(t,n,r,i,o):function(t,e,n,r,o){const{y0:i,c:s,lambda:u,b:l,ls:d,R:p,f:c}=Gn(t,e,n,r,o,1);return We(Ue(a.WeiPerEther,We(c,a.WeiPerEther.sub(We(d,We(s,s))))),Ue(a.WeiPerEther,We(We(u,u),p)).add(Ue(We(i.sub(l),i.sub(l)),We(We(We(u,u),We(u,u)),We(We(p,p),p)))))}(t,n,r,i,o);return s}var Vn=Object.freeze({__proto__:null,calcDerivativePriceAfterSwapOutGivenIn:jn,calcDerivativeSpotPriceAfterSwapInGivenOut:zn,calcInGivenOut:Zn,calcOutGivenIn:qn,calcSpotPriceAfterSwapInGivenOut:$n,calcSpotPriceAfterSwapOutGivenIn:Xn,calculateInvariantWithError:Hn,calculateNormalizedLiquidity:function(t,e,n,r,o,i){return i?function(t,e,n,r,o){const{x0:i,c:s,s:u,lambda:l,a:d,ls:p,R:c}=Gn(t,e,n,r,o,0);return Ue(We(Ue(a.WeiPerEther,a.WeiPerEther.sub(We(p,We(u,u)))),We(c,We(We(We(We(We(p,u),s),We(l,l)),c).sub(i.sub(d)),We(We(We(We(p,u),s),We(l,l)),c).sub(i.sub(d))))),We(We(l,l),We(c,c)).add(We(i.sub(d),i.sub(d))))}(t,e,n,o,r):function(t,e,n,r,o){const{y0:i,c:s,s:u,lambda:l,b:d,ls:p,R:c}=Gn(t,e,n,r,o,1);return Ue(We(Ue(a.WeiPerEther,a.WeiPerEther.sub(We(p,We(s,s)))),We(c,We(We(We(We(We(p,u),s),We(l,l)),c).sub(i.sub(d)),We(We(We(We(p,u),s),We(l,l)),c).sub(i.sub(d))))),We(We(l,l),We(c,c)).add(We(i.sub(d),i.sub(d))))}(t,e,n,o,r)}});class Yn{static fromPool(t){const{alpha:e,beta:n,c:a,s:r,lambda:o,tauAlphaX:i,tauAlphaY:s,tauBetaX:u,tauBetaY:l,u:d,v:p,w:c,z:m,dSq:h}=t,I={alpha:e,beta:n,c:a,s:r,lambda:o},f={tauAlphaX:i,tauAlphaY:s,tauBetaX:u,tauBetaY:l,u:d,v:p,w:c,z:m,dSq:h};if(!Object.values(I).every((t=>t))||!Object.values(f).every((t=>t)))throw new Error("Pool missing GyroE params and/or GyroE derived params");return new Yn(t.id,t.address,t.swapFee,t.totalShares,t.tokens,t.tokensList,I,f)}constructor(t,e,n,a,r,o,i,s){this.poolType=exports.PoolTypes.GyroE,this.id=t,this.address=e,this.swapFee=y(n,18),this.totalShares=y(a,18),this.tokens=r,this.tokensList=o,this.gyroEParams={alpha:y(i.alpha,18),beta:y(i.beta,18),c:y(i.c,18),s:y(i.s,18),lambda:y(i.lambda,18)},this.derivedGyroEParams={tauAlpha:{x:y(s.tauAlphaX,38),y:y(s.tauAlphaY,38)},tauBeta:{x:y(s.tauBetaX,38),y:y(s.tauBetaY,38)},u:y(s.u,38),v:y(s.v,38),w:y(s.w,38),z:y(s.z,38),dSq:y(s.dSq,38)}}parsePoolPairData(t,e){const a=this.tokens.findIndex((e=>n.getAddress(e.address)===n.getAddress(t)));if(a<0)throw"Pool does not contain tokenIn";const r=this.tokens[a],o=r.balance,i=r.decimals,s=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(s<0)throw"Pool does not contain tokenOut";const u=this.tokens[s],l=u.balance,d=u.decimals,p=0===a;return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:t,tokenOut:e,decimalsIn:Number(i),decimalsOut:Number(d),balanceIn:y(o,i),balanceOut:y(l,d),swapFee:this.swapFee,tokenInIsToken0:p}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){if(n===exports.SwapTypes.SwapExactIn){const n=Bn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=vn(n[0],n[1],e.tokenInIsToken0),[o,i]=Hn(r,this.gyroEParams,this.derivedGyroEParams),s={x:o.add(i.mul(2)),y:o},u=e.tokenInIsToken0?Dn:Wn,l=Ue(u(this.gyroEParams,this.derivedGyroEParams,s).sub(u(this.gyroEParams,this.derivedGyroEParams,s,!0)).sub(n[0]),a.WeiPerEther.sub(e.swapFee));return c(t.formatFixed(We(l,Ae),18))}return c(t.formatFixed(We(e.balanceOut,Ae),e.decimalsOut))}updateTokenBalanceForPool(e,n){if(w(this.address,e))this.updateTotalShares(n);else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){const a=Bn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=vn(a[0],a[1],e.tokenInIsToken0),[o,i]=Hn(r,this.gyroEParams,this.derivedGyroEParams),s={x:o.add(i.mul(2)),y:o},u=qn(r,Fn(y(n.toString(),18),e.swapFee),e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,s);return c(t.formatFixed(u,18))}_tokenInForExactTokenOut(e,n){const a=Bn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=vn(a[0],a[1],e.tokenInIsToken0),[o,i]=Hn(r,this.gyroEParams,this.derivedGyroEParams),s={x:o.add(i.mul(2)),y:o},u=On(Zn(r,y(n.toString(),18),e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,s),e.swapFee);return c(t.formatFixed(u,18))}_calcTokensOutGivenExactBptIn(t){return new Array(this.tokens.length).fill(a.Zero)}_calcBptOutGivenExactTokensIn(t){return a.Zero}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){const a=Bn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=vn(a[0],a[1],e.tokenInIsToken0),[o,i]=Hn(r,this.gyroEParams,this.derivedGyroEParams),s={x:o.add(i.mul(2)),y:o},u=Xn(r,Fn(y(n.toString(),18),e.swapFee),e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,s,e.swapFee);return c(t.formatFixed(u,18))}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){const a=Bn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=vn(a[0],a[1],e.tokenInIsToken0),[o,i]=Hn(r,this.gyroEParams,this.derivedGyroEParams),s={x:o.add(i.mul(2)),y:o},u=$n(r,y(n.toString(),18),e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,s,e.swapFee);return c(t.formatFixed(u,18))}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,n){const a=y(n.toString(),18),r=Bn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),o=vn(r[0],r[1],e.tokenInIsToken0),[i,s]=Hn(o,this.gyroEParams,this.derivedGyroEParams),u={x:i.add(s.mul(2)),y:i},l=jn([o[0].add(Fn(a,e.swapFee)),o[1]],e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,u,e.swapFee);return c(t.formatFixed(l,18))}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,n){const a=Bn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut]),r=vn(a[0],a[1],e.tokenInIsToken0),[o,i]=Hn(r,this.gyroEParams,this.derivedGyroEParams),s={x:o.add(i.mul(2)),y:o},u=y(n.toString(),18),l=zn([r[0],r[1].sub(u)],e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,s,e.swapFee);return c(t.formatFixed(l,18))}}function Kn(e,n,r){const o=n.map((e=>t.parseFixed("1",e)));return e.map(((t,e)=>We(t.mul(a.WeiPerEther).div(o[e]),r[e])))}const Jn=vn;class Qn{static fromPool(t){const{alpha:e,beta:n,c:a,s:r,lambda:o,tauAlphaX:i,tauAlphaY:s,tauBetaX:u,tauBetaY:l,u:d,v:p,w:c,z:m,dSq:h,tokenRates:I}=t,f={alpha:e,beta:n,c:a,s:r,lambda:o},T={tauAlphaX:i,tauAlphaY:s,tauBetaX:u,tauBetaY:l,u:d,v:p,w:c,z:m,dSq:h};if(!Object.values(f).every((t=>t))||!Object.values(T).every((t=>t)))throw new Error("Pool missing GyroE params and/or GyroE derived params");if(!I)throw new Error("GyroEV2 Pool missing tokenRates");return new Qn(t.id,t.address,t.swapFee,t.totalShares,t.tokens,t.tokensList,f,T,I)}constructor(t,e,n,a,r,o,i,s,u){this.poolType=exports.PoolTypes.GyroE,this.id=t,this.address=e,this.swapFee=y(n,18),this.totalShares=y(a,18),this.tokens=r,this.tokensList=o,this.tokenRates=[y(u[0],18),y(u[1],18)],this.gyroEParams={alpha:y(i.alpha,18),beta:y(i.beta,18),c:y(i.c,18),s:y(i.s,18),lambda:y(i.lambda,18)},this.derivedGyroEParams={tauAlpha:{x:y(s.tauAlphaX,38),y:y(s.tauAlphaY,38)},tauBeta:{x:y(s.tauBetaX,38),y:y(s.tauBetaY,38)},u:y(s.u,38),v:y(s.v,38),w:y(s.w,38),z:y(s.z,38),dSq:y(s.dSq,38)}}parsePoolPairData(t,e){const a=this.tokens.findIndex((e=>n.getAddress(e.address)===n.getAddress(t)));if(a<0)throw"Pool does not contain tokenIn";const r=this.tokens[a],o=r.balance,i=r.decimals,s=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(s<0)throw"Pool does not contain tokenOut";const u=this.tokens[s],l=u.balance,d=u.decimals,p=0===a;return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:t,tokenOut:e,decimalsIn:Number(i),decimalsOut:Number(d),balanceIn:y(o,i),balanceOut:y(l,d),swapFee:this.swapFee,tokenInIsToken0:p}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){if(n===exports.SwapTypes.SwapExactIn){const n=Jn(this.tokenRates[0],this.tokenRates[1],e.tokenInIsToken0),r=Kn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut],n),o=vn(r[0],r[1],e.tokenInIsToken0),[i,s]=Hn(o,this.gyroEParams,this.derivedGyroEParams),u={x:i.add(s.mul(2)),y:i},l=e.tokenInIsToken0?Dn:Wn,d=Ue(l(this.gyroEParams,this.derivedGyroEParams,u).sub(l(this.gyroEParams,this.derivedGyroEParams,u,!0)).sub(r[0]),n[0]),p=Ue(d,a.WeiPerEther.sub(e.swapFee));return c(t.formatFixed(We(p,Ae),18))}return c(t.formatFixed(We(e.balanceOut,Ae),e.decimalsOut))}updateTokenBalanceForPool(e,n){if(w(this.address,e))this.updateTotalShares(n);else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}updateTotalShares(t){this.totalShares=t}_exactTokenInForTokenOut(e,n){try{const a=Jn(this.tokenRates[0],this.tokenRates[1],e.tokenInIsToken0),r=Kn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut],a),o=vn(r[0],r[1],e.tokenInIsToken0),[i,s]=Hn(o,this.gyroEParams,this.derivedGyroEParams),u={x:i.add(s.mul(2)),y:i},l=y(n.toString(),18),d=We(Fn(l,e.swapFee),a[0]),p=Ue(qn(o,d,e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,u),a[1]);return c(t.formatFixed(p,18))}catch(t){return u}}_tokenInForExactTokenOut(e,n){try{const a=Jn(this.tokenRates[0],this.tokenRates[1],e.tokenInIsToken0),r=Kn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut],a),o=vn(r[0],r[1],e.tokenInIsToken0),[i,s]=Hn(o,this.gyroEParams,this.derivedGyroEParams),u={x:i.add(s.mul(2)),y:i},l=y(n.toString(),18),d=Zn(o,We(l,a[1]),e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,u),p=On(Ue(d,a[0]),e.swapFee);return c(t.formatFixed(p,18))}catch(t){return u}}_calcTokensOutGivenExactBptIn(t){return new Array(this.tokens.length).fill(a.Zero)}_calcBptOutGivenExactTokensIn(t){return a.Zero}_spotPriceAfterSwapExactTokenInForTokenOut(e,n){try{const a=Jn(this.tokenRates[0],this.tokenRates[1],e.tokenInIsToken0),r=Kn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut],a),o=vn(r[0],r[1],e.tokenInIsToken0),[i,s]=Hn(o,this.gyroEParams,this.derivedGyroEParams),u={x:i.add(s.mul(2)),y:i},l=y(n.toString(),18),d=We(Fn(l,e.swapFee),a[0]),p=Ue(We(Xn(o,d,e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,u,e.swapFee),a[1]),a[0]);return c(t.formatFixed(p,18))}catch(t){return u}}_spotPriceAfterSwapTokenInForExactTokenOut(e,n){try{const a=Jn(this.tokenRates[0],this.tokenRates[1],e.tokenInIsToken0),r=Kn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut],a),o=vn(r[0],r[1],e.tokenInIsToken0),[i,s]=Hn(o,this.gyroEParams,this.derivedGyroEParams),u={x:i.add(s.mul(2)),y:i},l=We(y(n.toString(),18),a[1]),d=Ue(We($n(o,l,e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,u,e.swapFee),a[1]),a[0]);return c(t.formatFixed(d,18))}catch(t){return u}}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,n){try{const a=y(n.toString(),18),r=Jn(this.tokenRates[0],this.tokenRates[1],e.tokenInIsToken0),o=Kn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut],r),i=vn(o[0],o[1],e.tokenInIsToken0),[s,u]=Hn(i,this.gyroEParams,this.derivedGyroEParams),l={x:s.add(u.mul(2)),y:s},d=jn([i[0].add(Fn(We(a,r[0]),e.swapFee)),i[1]],e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,l,e.swapFee),p=We(d,r[1]);return c(t.formatFixed(p,18))}catch(t){return u}}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,n){try{const a=Jn(this.tokenRates[0],this.tokenRates[1],e.tokenInIsToken0),r=Kn([e.balanceIn,e.balanceOut],[e.decimalsIn,e.decimalsOut],a),o=vn(r[0],r[1],e.tokenInIsToken0),[i,s]=Hn(o,this.gyroEParams,this.derivedGyroEParams),u={x:i.add(s.mul(2)),y:i},l=y(n.toString(),18),d=zn([o[0],o[1].sub(We(l,a[1]))],e.tokenInIsToken0,this.gyroEParams,this.derivedGyroEParams,u,e.swapFee),p=Ue(We(a[1],a[1]),a[0]),m=We(d,p);return c(t.formatFixed(m,18))}catch(t){return u}}}c("-1"),c("1");BigInt("100");BigInt("100000000");const ta=1e6;BigInt("1000000");const ea=1e13;BigInt("10000000000000");const na=p(c("1"),18),aa=.25;var ra;!function(t){t.LowerHalt="CurveMath/lower-halt",t.UpperHalt="CurveMath/upper-halt",t.SwapInvariantViolation="CurveMath/swap-invariant-violation",t.SwapConvergenceFailed="CurveMath/swap-convergence-failed",t.CannotSwap="CannotSwap"}(ra||(ra={}));const oa=t=>"0x2791bca1f2de4661ed88a30c99a7a9449aa84174"==t||"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"==t,ia=(t,e)=>"string"==typeof e?Number(c(t).div(c(na))):t/e,sa=(e,n,a)=>{const r=oa(n.tokenIn)?ia(da(Number(n.balanceOut),n.tokenOutLatestFXPrice.toNumber()),ua(n.decimalsOut)):ia(da(Number(n.balanceIn),n.tokenInLatestFXPrice.toNumber()),ua(n.decimalsIn)),o=oa(n.tokenIn)?ia(da(Number(n.balanceIn),n.tokenInLatestFXPrice.toNumber()),ua(n.decimalsIn)):ia(da(Number(n.balanceOut),n.tokenOutLatestFXPrice.toNumber()),ua(n.decimalsOut)),i=oa(n.tokenIn)?n.tokenOutLatestFXPrice.toNumber():n.tokenInLatestFXPrice.toNumber(),s=((t,e,n)=>{let a;return a=da(n,t?e.tokenInLatestFXPrice.toNumber():e.tokenOutLatestFXPrice.toNumber()),a})(a,n,Number(e.toString()));return{alpha:Number(t.formatFixed(n.alpha,18)),beta:Number(t.formatFixed(n.beta,18)),delta:Number(t.formatFixed(n.delta,18)),epsilon:Number(t.formatFixed(n.epsilon,18)),lambda:Number(t.formatFixed(n.lambda,18)),baseTokenRate:i,_oGLiq:r+o,_nGLiq:r+o,_oBals:[o,r],_nBals:oa(n.tokenIn)?[o+s,r-s]:[o-s,r+s],givenAmountInNumeraire:s}},ua=t=>{switch(t){case 6:return ta;case 2:return 100;default:return na.toString()}},la=(t,e)=>c(t/e),da=(t,e)=>t*e,pa=(t,e,n,a)=>{let r,o,i=0;return t<e?(r=e*(1-n),t<r?(o=r-t,i=o/e,i*=a,i>aa&&(i=aa),i*=o):i=0):(r=e*(1+n),t>r?(o=t-r,i=o/e,i*=a,i>aa&&(i=aa),i*=o):i=0),i},ca=(t,e,n,a,r)=>{const o=e.length;let i=0;for(let s=0;s<o;s++){const o=t*r[s];i+=pa(e[s],o,n,a)}return i},ma=(t,e,n,a,r,o,i)=>{let s;const u=[.5,.5],l=i.alpha,d=i.beta,p=i.delta,c=i.lambda;s=-r;const m=ca(t,n,d,p,u);let h;for(let i=0;i<32;i++){h=ca(e,a,d,p,u);const i=s;if(s=m<h?-(r+(m-h)):-(r+c*(m-h)),s/ea==i/ea)return e=t+r+s,a[o]=n[o]+s,Ia(t,m,e,h),ha(t,e,n,a,u,l),[s,e];e=t+r+s,a[o]=n[o]+s}throw new Error(ra.SwapConvergenceFailed)},ha=(t,e,n,a,r,o)=>{const i=a.length,s=o;for(let o=0;o<i;o++){const i=e*r[o];if(a[o]>i){const e=1+s,u=i*e;if(a[o]>u){const i=t*r[o]*e;if(n[o]<i)throw new Error(ra.UpperHalt);if(a[o]-u>n[o]-i)throw new Error(ra.UpperHalt)}}else{const e=1-s,u=i*e;if(a[o]<u){let i=t*r[o];if(i*=e,n[o]>i)throw new Error(ra.LowerHalt);if(u-a[o]>i-n[o])throw new Error(ra.LowerHalt)}}}return!0},Ia=(t,e,n,a)=>{const r=n-a-(t-e);if(0<r||r>=-1000000000000024e-21)return!0;throw new Error(ra.SwapInvariantViolation)};const fa=(t,e)=>{const n=sa(t,e,!0),a=n._oGLiq,r=n._nGLiq,o=n._oBals,i=n._nBals,s=ma(a,r,o,i,1,0,n);return c(Math.abs(s[0])*(1-n.epsilon)/Math.abs(1)*n.baseTokenRate)},Ta=(t,e)=>{const n=sa(e,t,!0),a=n.givenAmountInNumeraire,r=n._oGLiq,o=n._nBals,i=n.baseTokenRate,s=n.beta,u=n.epsilon,l=n._nGLiq,d=n._oBals,p=ma(r,l,d,o,a,oa(t.tokenIn)?1:0,n)[0],m=.5*(1+s)*r,h=.5*(1-s)*r;if(oa(t.tokenIn)){const n=o[0];return o[1]<h&&n>m?e.isZero()?fa(e,t):c(Math.abs(p*(1-u))/Math.abs(a)*i):c(i*(1-u))}{const n=o[1];if(o[0]<h&&n>m){if(e.isZero())return fa(e,t);return c(Math.abs(p*(1-u))/Math.abs(a)*i)}return c(i*(1-u))}},xa=(t,e)=>{const n=sa(e,t,!1),a=-n.givenAmountInNumeraire,r=n._oGLiq,o=n._nBals,i=n.baseTokenRate,s=n.beta,u=n.epsilon,l=n._nGLiq,d=n._oBals,p=ma(r,l,d,o,a,oa(t.tokenIn)?0:1,n)[0],m=.5*(1+s)*r,h=.5*(1-s)*r;if(oa(t.tokenIn)){const t=o[0];return c(o[1]<h&&t>m?Math.abs(a)/Math.abs(p*(1+u))*i:i*(1-u))}{const t=o[0],e=o[1];return c(t<h&&e>m?Math.abs(a)/Math.abs(p*(1+u))*i:i*(1-u))}};class ga{static fromPool(t){if(!(t.alpha&&t.beta&&t.lambda&&t.delta&&t.epsilon))throw new Error("FX Pool Missing Subgraph Field");return new ga(t.id,t.address,t.swapFee,t.totalShares,t.tokens,t.tokensList,t.alpha,t.beta,t.lambda,t.delta,t.epsilon)}constructor(e,n,a,r,o,i,s,u,l,d,p){this.poolType=exports.PoolTypes.Fx,this.id=e,this.address=n,this.swapFee=t.parseFixed(a,18),this.totalShares=t.parseFixed(r,18),this.tokens=o,this.tokensList=i,this.alpha=t.parseFixed(s,18),this.beta=t.parseFixed(u,18),this.lambda=t.parseFixed(l,18),this.delta=t.parseFixed(d,18),this.epsilon=t.parseFixed(p,18)}_calcTokensOutGivenExactBptIn(t){return new Array(this.tokens.length).fill(a.Zero)}_calcBptOutGivenExactTokensIn(t){return a.Zero}parsePoolPairData(e,a){var r,o;const i=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(e)));if(i<0)throw"Pool does not contain tokenIn";const s=this.tokens[i],u=s.balance,l=s.decimals,d=this.tokens.findIndex((t=>n.getAddress(t.address)===n.getAddress(a)));if(d<0)throw"Pool does not contain tokenOut";const p=this.tokens[d],m=p.balance,h=p.decimals;if(!(null===(r=p.token)||void 0===r?void 0:r.latestFXPrice)||!(null===(o=s.token)||void 0===o?void 0:o.latestFXPrice))throw"FX Pool Missing LatestFxPrice";return{id:this.id,address:this.address,poolType:this.poolType,tokenIn:e,tokenOut:a,decimalsIn:Number(l),decimalsOut:Number(h),balanceIn:t.parseFixed(u,l),balanceOut:t.parseFixed(m,h),swapFee:this.swapFee,alpha:this.alpha,beta:this.beta,lambda:this.lambda,delta:this.delta,epsilon:this.epsilon,tokenInLatestFXPrice:c(s.token.latestFXPrice),tokenOutLatestFXPrice:c(p.token.latestFXPrice)}}getNormalizedLiquidity(t){return z(this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,u))}getLimitAmountSwap(e,n){try{const a=(t=>{let e,n;return oa(t.tokenIn)?(e=ia(da(Number(t.balanceIn),t.tokenInLatestFXPrice.toNumber()),ua(t.decimalsIn)),n=ia(da(Number(t.balanceOut),t.tokenOutLatestFXPrice.toNumber()),ua(t.decimalsOut))):(e=ia(da(Number(t.balanceOut),t.tokenOutLatestFXPrice.toNumber()),ua(t.decimalsOut)),n=ia(da(Number(t.balanceIn),t.tokenInLatestFXPrice.toNumber()),ua(t.decimalsIn))),{tokenInReservesInNumeraire:e,tokenOutReservesInNumeraire:n,_oGLiq:e+n}})(e),r=(1+Number(t.formatFixed(e.alpha,18)))*a._oGLiq*.5;if(n===exports.SwapTypes.SwapExactIn){const t=r-a.tokenInReservesInNumeraire;return c(la(t,e.tokenInLatestFXPrice.toNumber()).toString())}{const t=r-a.tokenOutReservesInNumeraire;return c(la(t,e.tokenOutLatestFXPrice.toNumber()).toString())}}catch(t){return u}}updateTokenBalanceForPool(e,n){if(this.address==e)this.totalShares=n;else{const a=this.tokens.find((t=>w(t.address,e)));if(!a)throw Error("Pool does not contain this token");a.balance=t.formatFixed(n,a.decimals)}}_exactTokenInForTokenOut(t,e){try{return function(t,e){const n=sa(t,e,!0),a=n.givenAmountInNumeraire;if(e.tokenIn===e.tokenOut)return la(a,e.tokenInLatestFXPrice.toNumber());const r=n._oGLiq,o=n._nGLiq,i=n._oBals,s=n._nBals,u=ma(r,o,i,s,a,oa(e.tokenIn)?1:0,n);if(void 0===u)throw new Error(ra.CannotSwap);{const t=n.epsilon,a=u[0]*(1-t);return la(Math.abs(a),e.tokenOutLatestFXPrice.toNumber())}}(e,t)}catch(t){return u}}_tokenInForExactTokenOut(e,n){try{return function(e,n){const a=sa(e,n,!1),r=-a.givenAmountInNumeraire;n.tokenIn===n.tokenOut&&la(r,n.tokenOutLatestFXPrice.toNumber());const o=a._oGLiq,i=a._nGLiq,s=a._oBals,u=a._nBals,l=ma(o,i,s,u,r,oa(n.tokenIn)?0:1,a);if(void 0===l)throw new Error(ra.CannotSwap);{const e=Number(t.formatFixed(n.epsilon,18)),a=l[0]*(1+e);return la(Math.abs(a),n.tokenInLatestFXPrice.toNumber())}}(n,e)}catch(t){return u}}_spotPriceAfterSwapExactTokenInForTokenOut(t,e){try{return Ta(t,e)}catch(t){return u}}_spotPriceAfterSwapTokenInForExactTokenOut(t,e){try{return xa(t,e)}catch(t){return u}}_derivativeSpotPriceAfterSwapExactTokenInForTokenOut(t,e){try{return((t,e)=>{const n=fa(c("1"),e),a=Ta(e,t).minus(n).div(n);return a.isZero()?c(1e-19):a.abs()})(e,t)}catch(t){return u}}_derivativeSpotPriceAfterSwapTokenInForExactTokenOut(t,e){try{return((t,e)=>{const n=fa(c("1"),e);return xa(e,t).minus(n).div(n).abs()})(e,t)}catch(t){return u}}}function wa(t,e=0){if(!t.swapEnabled)return;let n;try{const a=t.poolType.toString().includes("Linear");if(!a&&!(t.poolType in exports.PoolFilter))return void console.error(`Unsupported pool type: ${t.poolType} ${t.id}`);if("Weighted"===t.poolType||"Investment"===t.poolType)n=V.fromPool(t,!1);else if("LiquidityBootstrapping"===t.poolType)n=V.fromPool(t,!0);else if("Stable"===t.poolType)n=wt.fromPool(t);else if("MetaStable"===t.poolType)n=yt.fromPool(t);else if("Element"===t.poolType)n=re.fromPool(t),n.setCurrentBlockTimestamp(e);else if(a)n=ne.fromPool(t);else if("StablePhantom"===t.poolType)n=ge.fromPool(t);else if("ComposableStable"===t.poolType)n=we.fromPool(t);else if("Gyro2"===t.poolType)n=on.fromPool(t);else if("Gyro3"===t.poolType)n=bn.fromPool(t);else if("GyroE"===t.poolType)n=2===t.poolTypeVersion?Qn.fromPool(t):Yn.fromPool(t);else{if("FX"!==t.poolType)return void console.error(`Unknown pool type or type field missing: ${t.poolType} ${t.id}`);n=ga.fromPool(t)}}catch(t){return void console.error(`parseNewPool: ${t.message}`)}return n}function ya(t,e,n,a){return n===exports.SwapTypes.SwapExactIn?e.poolType!==exports.PoolTypes.Linear&&e.balanceIn.isZero()?u:t._exactTokenInForTokenOut(e,a):e.balanceOut.isZero()?u:p(a,e.decimalsOut).gte(e.balanceOut.toString())?d:t._tokenInForExactTokenOut(e,a)}let ka="0.00001";try{ka=process.env.PRICE_ERROR_TOLERANCE||"0.00001"}catch(t){console&&console.log(t)}const ba=new e.BigNumber(ka),Ea=new e.BigNumber("0.01"),Sa=c("0.000000000000000001");function Fa(e,n,a,r){if(a.gt(c(t.formatFixed(e.limitAmount,r))))return n===exports.SwapTypes.SwapExactIn?u:d;const o=Oa(e,n,a);return n===exports.SwapTypes.SwapExactIn?o[o.length-1]:o[0]}function Oa(t,e,n){const a=t.pools,r=t.poolPairData,o=[n];if(e===exports.SwapTypes.SwapExactIn)for(let t=0;t<a.length;t++)o.push(ya(a[t],r[t],e,o[o.length-1]));else{const t=a.length;for(let n=0;n<a.length;n++)o.unshift(ya(a[t-1-n],r[t-1-n],e,o[0]))}return o}function Ba(t,e,n){const a=t.pools,r=t.poolPairData,o=[c(1)],i=a.length;let s=0;e===exports.SwapTypes.SwapExactOut&&(s=1);for(let t=0;t<a.length;t++)o.unshift(Pa(a[i-1-t],r[i-1-t],e,n[i-1-t+s]).times(o[0]));return o}function va(t,e,n){return Ba(t,e,Oa(t,e,n))[0]}function Pa(t,e,n,a){if(n===exports.SwapTypes.SwapExactIn){if(e.balanceIn.isZero())return u}else{if(e.balanceOut.isZero())return u;if(p(a,e.decimalsOut).gte(e.balanceOut.toString()))return d}return n===exports.SwapTypes.SwapExactIn?t._spotPriceAfterSwapExactTokenInForTokenOut(e,a):t._spotPriceAfterSwapTokenInForExactTokenOut(e,a)}function _a(t,e,n){const a=t.poolPairData,r=t.pools,o=r.length,i=Oa(t,e,n),s=Ba(t,e,i);let u=c(0);if(e===exports.SwapTypes.SwapExactIn)for(let t=0;t<o;t++){const n=Aa(r[t],a[t],e,i[t]).times(s[t+1]);u=u.plus(n)}else{const n=function(t,e,n){if(e!==exports.SwapTypes.SwapExactOut)return[c(0)];const a=t.pools,r=t.poolPairData,o=[c(1)];for(let t=0;t<a.length;t++)o.push(Pa(a[t],r[t],e,n[t+1]).times(o[o.length-1]));return o}(t,e,i);for(let t=0;t<o;t++){let o=Aa(r[t],a[t],e,i[t+1]).times(s[t+1]);o=o.times(s[t+1]).times(n[t]),u=u.plus(o)}}return u.eq(c(0))&&(u=Sa),u}function Aa(t,e,n,a){if(n===exports.SwapTypes.SwapExactIn){if(e.balanceIn.isZero())return u}else{if(e.balanceOut.isZero())return u;if(p(a,e.decimalsOut).gte(e.balanceOut.toString()))return d}return n===exports.SwapTypes.SwapExactIn?t._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(e,a):t._derivativeSpotPriceAfterSwapTokenInForExactTokenOut(e,a)}function Na(e,n,a,r){n=e.parsePoolPairData(n.tokenIn,n.tokenOut);const{balanceIn:o,balanceOut:i,tokenIn:s,tokenOut:l}=n;let c;if(a===exports.SwapTypes.SwapExactIn){if(n.poolType!==exports.PoolTypes.Linear&&n.balanceIn.isZero())return u}else{if(n.balanceOut.isZero())return u;if(p(r,n.decimalsOut).gte(n.balanceOut.toString()))return d}if(a===exports.SwapTypes.SwapExactIn)if(e.poolType===exports.PoolTypes.Element)c=ya(e,n,a,r);else{if(!(e.poolType in exports.PoolTypes))throw Error("Unsupported swap");c=e._exactTokenInForTokenOut(n,r)}else if(e.poolType===exports.PoolTypes.Element)c=ya(e,n,a,r);else{if(!(e.poolType in exports.PoolTypes))throw Error("Unsupported swap");c=e._tokenInForExactTokenOut(n,r)}const m=a===exports.SwapTypes.SwapExactIn?r:c,h=a===exports.SwapTypes.SwapExactIn?c:r;return e.updateTokenBalanceForPool(s,o.add(t.parseFixed(m.dp(n.decimalsIn).toString(),n.decimalsIn))),e.updateTokenBalanceForPool(l,i.sub(t.parseFixed(h.dp(n.decimalsOut).toString(),n.decimalsOut))),c}const Da=(e,n,a,r,o,i,s)=>{let[u,l]=Wa(e,n,r,o,i,s),d=r;if(1===r.length)return{swapAmounts:d,paths:u};const p=c(t.formatFixed(a,o));let m=u;const h=[];let I=JSON.stringify(m.map((({id:t})=>t)).sort());for(;!h.includes(I)&&(h.push(I),u=m,[d,l]=Ua(u,n,p,d,l),[m,l]=Wa(e,n,d,o,i,s),0!==m.length);){const t=m.map((({id:t})=>t)).sort();I=JSON.stringify(t)}return{swapAmounts:d,paths:u}};function Wa(e,n,a,r,o,i){const l=[],p=[],m=s(e);return[...a].sort(((t,e)=>e.minus(t).toNumber())).forEach((e=>{let a=-1,s=d;if(m.forEach(((u,l)=>{if(c(t.formatFixed(u.limitAmount,r)).gte(e)){let p;p=c(t.formatFixed(u.limitAmount,r)).eq(e)?d:function(e,n,a,r,o,i){if(a.lt(Ea))return va(e,n,a);let s=Fa(e,n,a,r);const u=c(t.formatFixed(i,o)).times(e.pools.length);return n===exports.SwapTypes.SwapExactIn?(s=s.minus(u),a.div(s)):(a=a.plus(u),s.div(a))}(u,n,e,r,o,i),p.lte(s)&&(s=p,a=l)}})),-1===a)return l.push({id:"",swaps:[],poolPairData:[],limitAmount:t.BigNumber.from("0"),pools:[]}),void p.push(u);l.push(m[a]),p.push(e.minus(c(t.formatFixed(m[a].limitAmount,r)))),m.splice(a,1)})),[l,p]}function Ua(t,n,a,r,o){let i=l,s=[],u=0;for(;i.isGreaterThan(ba);){[s,r,o]=La(t,n,a,r,o,u);const l=e.BigNumber.max.apply(null,s),d=e.BigNumber.min.apply(null,s);if(i=l.minus(d).div(d),u++,u>100)break}return[r,o]}function La(t,n,a,r,o,i){let s=u,d=u;const p=[],m=[];r.forEach(((e,a)=>{if(0==i&&e.gte(u)&&o[a].lte(u)||0!=i&&e.gt(u)&&o[a].lt(u)){const r=t[a],o=va(r,n,e);p.push(o);const i=_a(r,n,e);m.push(i),s=s.plus(l.div(i)),d=d.plus(o.div(i))}else m.push(c("NaN")),p.push(c("NaN"))}));const h=c(d.toNumber()/s.toNumber());for(r.forEach(((t,e)=>{if(0==i&&t.gte(u)&&o[e].lte(u)||0!=i&&t.gt(u)&&o[e].lt(u)){const t=h.minus(p[e]).div(m[e]);r[e]=r[e].plus(t),o[e]=o[e].plus(t)}}));e.BigNumber.min.apply(null,r).lt(u)||e.BigNumber.max.apply(null,o).gt(u);)[r,o]=Ma(r,o,m);const I=[];let f=u;r.forEach(((e,a)=>{f=f.plus(e),(0==i&&e.gte(u)&&o[a].lte(u)||0!=i&&e.gt(u)&&o[a].lt(u))&&I.push(va(t[a],n,e))}));const T=a.minus(f);for(let t=0;t<r.length;++t)if(r[t].gt(u)&&o[t].lt(u)&&r[t].plus(T).gt(u)&&o[t].plus(T).lt(u)){r[t]=r[t].plus(T),o[t]=o[t].plus(T);break}return[I,r,o]}function Ma(t,e,n){let a=u,r=u,o=u,i=u;return t.forEach(((t,s)=>{t.lte(u)?(i=i.plus(t),r=r.plus(l.div(n[s]))):e[s].gte(u)?(i=i.plus(e[s]),o=o.plus(l.div(n[s]))):a=a.plus(l.div(n[s]))})),t.forEach(((r,o)=>{if(r.lte(u))t[o]=u,e[o]=e[o].minus(r);else if(e[o].gte(u))t[o]=t[o].minus(e[o]),e[o]=u;else{const r=i.times(l.div(n[o])).div(a);t[o]=t[o].plus(r),e[o]=e[o].plus(r)}})),a.isZero()&&(i.lt(u)?t.forEach(((a,r)=>{if(e[r].isZero()){const a=i.times(l.div(n[r])).div(o);t[r]=t[r].plus(a),e[r]=e[r].plus(a)}})):t.forEach(((a,o)=>{if(t[o].isZero()){const a=i.times(l.div(n[o])).div(r);t[o]=t[o].plus(a),e[o]=e[o].plus(a)}}))),[t,e]}const Ra=(t,n,a,r)=>{let o=new e.BigNumber(0);return t.forEach(((t,e)=>{o=o.plus(Fa(t,n,a[e],r))})),o},Ca=(n,r,o,i,s,p,m)=>{if(0==n.length||o.isZero())return[[],u,u,u];const h=function(t,e){if(0===t.length)return[];const n=[];for(let a=0;a<e;a++)if(a<t.length){const e=t[a].limitAmount;n.push(e)}return n}(n,p),I=h.reduce(((t,e)=>(t.push(e.add(t[t.length-1]||a.Zero)),t)),[]);if(o.gt(I[I.length-1]))return[[],u,u,u];const f=I.findIndex((t=>o.lte(t)))+1,T=h.slice(0,f),x=I[f-1].sub(o);T[T.length-1]=T[T.length-1].sub(x);const[g,w,y]=((n,a,r,o,i,s,p,m,h,I)=>{let f=a===exports.SwapTypes.SwapExactIn?d.times(-1):d,T=[],x=[],g=o.map((e=>c(t.formatFixed(e,s))));for(let o=m;o<=n.length;o++){if(o!=m){const n=t.formatFixed(r,s),a=e.BigNumber.min.apply(null,[c(n).times(c(1/o)),t.formatFixed(i[o-1],s)]);g.forEach(((t,e)=>{g[e]=t.times(l.minus(a.div(n)))})),a.isZero()||g.push(a)}const{paths:d,swapAmounts:w}=Da(n,a,r,g,s,p,I);g=w;const y=Ra(d,a,g,s),k=d.reduce(((t,e)=>t+e.swaps.length),0),b=t.formatFixed(I,p);let E=!1,S=u;const F=c(k).times(b);if(a===exports.SwapTypes.SwapExactIn?(S=y.minus(F),E=S.isGreaterThan(f)):(S=y.plus(F),E=S.isLessThan(f)),!E)break;if(T=[...g],x=[...d],f=S,k>=h)break}return x=x.filter(((t,e)=>!T[e].isZero())),T=T.filter((t=>!t.isZero())),[x,T,f]})(n,r,o,T,h,i,s,f,p,m),[k,b,E]=((t,e,n,a)=>{const r=[];let o=a[0],i=t[0],s=u;if(t.forEach(((t,n)=>{const u=a[n];u.gt(o)&&(o=u,i=t);const l=t.poolPairData,d=[],p=[];let c;const m=l.length;if(p.push(u),e===exports.SwapTypes.SwapExactIn){for(let e=0;e<m;e++){p.push(Na(t.pools[e],l[e],exports.SwapTypes.SwapExactIn,p[p.length-1]));const n={pool:t.swaps[e].pool,tokenIn:t.swaps[e].tokenIn,tokenOut:t.swaps[e].tokenOut,swapAmount:p[e].toString(),tokenInDecimals:t.poolPairData[e].decimalsIn,tokenOutDecimals:t.poolPairData[e].decimalsOut,returnAmount:p[p.length-1].toString()};d.push(n)}c=p[m]}else{for(let e=0;e<m;e++){p.unshift(Na(t.pools[m-1-e],l[m-1-e],exports.SwapTypes.SwapExactOut,p[0]));const n={pool:t.swaps[m-1-e].pool,tokenIn:t.swaps[m-1-e].tokenIn,tokenOut:t.swaps[m-1-e].tokenOut,swapAmount:p[1].toString(),tokenInDecimals:t.poolPairData[m-1-e].decimalsIn,tokenOutDecimals:t.poolPairData[m-1-e].decimalsOut,returnAmount:p[0].toString()};d.unshift(n)}c=p[0]}r.push(d),s=s.plus(c)})),r.length>0){const o=a.reduce(((t,e)=>t.plus(e)),u),i=n.minus(o);if(e===exports.SwapTypes.SwapExactIn)r[0][0].swapAmount=c(r[0][0].swapAmount).plus(i).toString();else{const e=t[0].swaps.length-1;r[0][e].swapAmount=c(r[0][e].swapAmount).plus(i).toString()}}if(s.eq(0))return[[],u,u];const l=va(i,e,u);return[r,s,l]})(g,r,c(t.formatFixed(o,i)),w);return b.eq(0)?[[],u,u,u]:[k,b,E,y]};var Ga=[{inputs:[{internalType:"contract IAuthorizer",name:"authorizer",type:"address"},{internalType:"contract IWETH",name:"weth",type:"address"},{internalType:"uint256",name:"pauseWindowDuration",type:"uint256"},{internalType:"uint256",name:"bufferPeriodDuration",type:"uint256"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,internalType:"contract IAuthorizer",name:"newAuthorizer",type:"address"}],name:"AuthorizerChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"contract IERC20",name:"token",type:"address"},{indexed:!0,internalType:"address",name:"sender",type:"address"},{indexed:!1,internalType:"address",name:"recipient",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"ExternalBalanceTransfer",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"contract IFlashLoanRecipient",name:"recipient",type:"address"},{indexed:!0,internalType:"contract IERC20",name:"token",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"feeAmount",type:"uint256"}],name:"FlashLoan",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"user",type:"address"},{indexed:!0,internalType:"contract IERC20",name:"token",type:"address"},{indexed:!1,internalType:"int256",name:"delta",type:"int256"}],name:"InternalBalanceChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"bool",name:"paused",type:"bool"}],name:"PausedStateChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"poolId",type:"bytes32"},{indexed:!0,internalType:"address",name:"liquidityProvider",type:"address"},{indexed:!1,internalType:"contract IERC20[]",name:"tokens",type:"address[]"},{indexed:!1,internalType:"int256[]",name:"deltas",type:"int256[]"},{indexed:!1,internalType:"uint256[]",name:"protocolFeeAmounts",type:"uint256[]"}],name:"PoolBalanceChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"poolId",type:"bytes32"},{indexed:!0,internalType:"address",name:"assetManager",type:"address"},{indexed:!0,internalType:"contract IERC20",name:"token",type:"address"},{indexed:!1,internalType:"int256",name:"cashDelta",type:"int256"},{indexed:!1,internalType:"int256",name:"managedDelta",type:"int256"}],name:"PoolBalanceManaged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"poolId",type:"bytes32"},{indexed:!0,internalType:"address",name:"poolAddress",type:"address"},{indexed:!1,internalType:"enum IVault.PoolSpecialization",name:"specialization",type:"uint8"}],name:"PoolRegistered",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"relayer",type:"address"},{indexed:!0,internalType:"address",name:"sender",type:"address"},{indexed:!1,internalType:"bool",name:"approved",type:"bool"}],name:"RelayerApprovalChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"poolId",type:"bytes32"},{indexed:!0,internalType:"contract IERC20",name:"tokenIn",type:"address"},{indexed:!0,internalType:"contract IERC20",name:"tokenOut",type:"address"},{indexed:!1,internalType:"uint256",name:"amountIn",type:"uint256"},{indexed:!1,internalType:"uint256",name:"amountOut",type:"uint256"}],name:"Swap",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"poolId",type:"bytes32"},{indexed:!1,internalType:"contract IERC20[]",name:"tokens",type:"address[]"}],name:"TokensDeregistered",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"poolId",type:"bytes32"},{indexed:!1,internalType:"contract IERC20[]",name:"tokens",type:"address[]"},{indexed:!1,internalType:"address[]",name:"assetManagers",type:"address[]"}],name:"TokensRegistered",type:"event"},{inputs:[],name:"WETH",outputs:[{internalType:"contract IWETH",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"enum IVault.SwapKind",name:"kind",type:"uint8"},{components:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"uint256",name:"assetInIndex",type:"uint256"},{internalType:"uint256",name:"assetOutIndex",type:"uint256"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bytes",name:"userData",type:"bytes"}],internalType:"struct IVault.BatchSwapStep[]",name:"swaps",type:"tuple[]"},{internalType:"contract IAsset[]",name:"assets",type:"address[]"},{components:[{internalType:"address",name:"sender",type:"address"},{internalType:"bool",name:"fromInternalBalance",type:"bool"},{internalType:"address payable",name:"recipient",type:"address"},{internalType:"bool",name:"toInternalBalance",type:"bool"}],internalType:"struct IVault.FundManagement",name:"funds",type:"tuple"},{internalType:"int256[]",name:"limits",type:"int256[]"},{internalType:"uint256",name:"deadline",type:"uint256"}],name:"batchSwap",outputs:[{internalType:"int256[]",name:"assetDeltas",type:"int256[]"}],stateMutability:"payable",type:"function"},{inputs:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"contract IERC20[]",name:"tokens",type:"address[]"}],name:"deregisterTokens",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"address",name:"sender",type:"address"},{internalType:"address payable",name:"recipient",type:"address"},{components:[{internalType:"contract IAsset[]",name:"assets",type:"address[]"},{internalType:"uint256[]",name:"minAmountsOut",type:"uint256[]"},{internalType:"bytes",name:"userData",type:"bytes"},{internalType:"bool",name:"toInternalBalance",type:"bool"}],internalType:"struct IVault.ExitPoolRequest",name:"request",type:"tuple"}],name:"exitPool",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"contract IFlashLoanRecipient",name:"recipient",type:"address"},{internalType:"contract IERC20[]",name:"tokens",type:"address[]"},{internalType:"uint256[]",name:"amounts",type:"uint256[]"},{internalType:"bytes",name:"userData",type:"bytes"}],name:"flashLoan",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes4",name:"selector",type:"bytes4"}],name:"getActionId",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAuthorizer",outputs:[{internalType:"contract IAuthorizer",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getDomainSeparator",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"user",type:"address"},{internalType:"contract IERC20[]",name:"tokens",type:"address[]"}],name:"getInternalBalance",outputs:[{internalType:"uint256[]",name:"balances",type:"uint256[]"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"user",type:"address"}],name:"getNextNonce",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getPausedState",outputs:[{internalType:"bool",name:"paused",type:"bool"},{internalType:"uint256",name:"pauseWindowEndTime",type:"uint256"},{internalType:"uint256",name:"bufferPeriodEndTime",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"poolId",type:"bytes32"}],name:"getPool",outputs:[{internalType:"address",name:"",type:"address"},{internalType:"enum IVault.PoolSpecialization",name:"",type:"uint8"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"contract IERC20",name:"token",type:"address"}],name:"getPoolTokenInfo",outputs:[{internalType:"uint256",name:"cash",type:"uint256"},{internalType:"uint256",name:"managed",type:"uint256"},{internalType:"uint256",name:"lastChangeBlock",type:"uint256"},{internalType:"address",name:"assetManager",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"poolId",type:"bytes32"}],name:"getPoolTokens",outputs:[{internalType:"contract IERC20[]",name:"tokens",type:"address[]"},{internalType:"uint256[]",name:"balances",type:"uint256[]"},{internalType:"uint256",name:"lastChangeBlock",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getProtocolFeesCollector",outputs:[{internalType:"contract ProtocolFeesCollector",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"user",type:"address"},{internalType:"address",name:"relayer",type:"address"}],name:"hasApprovedRelayer",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"address",name:"sender",type:"address"},{internalType:"address",name:"recipient",type:"address"},{components:[{internalType:"contract IAsset[]",name:"assets",type:"address[]"},{internalType:"uint256[]",name:"maxAmountsIn",type:"uint256[]"},{internalType:"bytes",name:"userData",type:"bytes"},{internalType:"bool",name:"fromInternalBalance",type:"bool"}],internalType:"struct IVault.JoinPoolRequest",name:"request",type:"tuple"}],name:"joinPool",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{components:[{internalType:"enum IVault.PoolBalanceOpKind",name:"kind",type:"uint8"},{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"contract IERC20",name:"token",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],internalType:"struct IVault.PoolBalanceOp[]",name:"ops",type:"tuple[]"}],name:"managePoolBalance",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{components:[{internalType:"enum IVault.UserBalanceOpKind",name:"kind",type:"uint8"},{internalType:"contract IAsset",name:"asset",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"address",name:"sender",type:"address"},{internalType:"address payable",name:"recipient",type:"address"}],internalType:"struct IVault.UserBalanceOp[]",name:"ops",type:"tuple[]"}],name:"manageUserBalance",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"enum IVault.SwapKind",name:"kind",type:"uint8"},{components:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"uint256",name:"assetInIndex",type:"uint256"},{internalType:"uint256",name:"assetOutIndex",type:"uint256"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bytes",name:"userData",type:"bytes"}],internalType:"struct IVault.BatchSwapStep[]",name:"swaps",type:"tuple[]"},{internalType:"contract IAsset[]",name:"assets",type:"address[]"},{components:[{internalType:"address",name:"sender",type:"address"},{internalType:"bool",name:"fromInternalBalance",type:"bool"},{internalType:"address payable",name:"recipient",type:"address"},{internalType:"bool",name:"toInternalBalance",type:"bool"}],internalType:"struct IVault.FundManagement",name:"funds",type:"tuple"}],name:"queryBatchSwap",outputs:[{internalType:"int256[]",name:"",type:"int256[]"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"enum IVault.PoolSpecialization",name:"specialization",type:"uint8"}],name:"registerPool",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"contract IERC20[]",name:"tokens",type:"address[]"},{internalType:"address[]",name:"assetManagers",type:"address[]"}],name:"registerTokens",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"contract IAuthorizer",name:"newAuthorizer",type:"address"}],name:"setAuthorizer",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bool",name:"paused",type:"bool"}],name:"setPaused",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"sender",type:"address"},{internalType:"address",name:"relayer",type:"address"},{internalType:"bool",name:"approved",type:"bool"}],name:"setRelayerApproval",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{components:[{internalType:"bytes32",name:"poolId",type:"bytes32"},{internalType:"enum IVault.SwapKind",name:"kind",type:"uint8"},{internalType:"contract IAsset",name:"assetIn",type:"address"},{internalType:"contract IAsset",name:"assetOut",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bytes",name:"userData",type:"bytes"}],internalType:"struct IVault.SingleSwap",name:"singleSwap",type:"tuple"},{components:[{internalType:"address",name:"sender",type:"address"},{internalType:"bool",name:"fromInternalBalance",type:"bool"},{internalType:"address payable",name:"recipient",type:"address"},{internalType:"bool",name:"toInternalBalance",type:"bool"}],internalType:"struct IVault.FundManagement",name:"funds",type:"tuple"},{internalType:"uint256",name:"limit",type:"uint256"},{internalType:"uint256",name:"deadline",type:"uint256"}],name:"swap",outputs:[{internalType:"uint256",name:"amountCalculated",type:"uint256"}],stateMutability:"payable",type:"function"},{stateMutability:"payable",type:"receive"}];const Ha={tokenAddresses:[],swaps:[],swapAmount:a.Zero,swapAmountForSwaps:a.Zero,tokenIn:"",tokenInForSwaps:"",tokenOut:"",tokenOutFromSwaps:"",returnAmount:a.Zero,returnAmountConsideringFees:a.Zero,returnAmountFromSwaps:a.Zero,marketSp:a.Zero.toString()},qa={Networks:[1,42],stETH:{1:"0xae7ab96520de3a18e5e111b5eaab095312d7fe84",42:"0x4803bb90d18a1cb7a2187344fe4feb0e07878d05"},wstETH:{1:"0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0",42:"0xa387b91e393cfb9356a460370842bc8dbb2f29af"},WETH:{1:"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",42:"0xdfcea9088c8a88a76ff74892c1457c17dfeef9c1"},DAI:{1:"0x6b175474e89094c44da98b954eedeac495271d0f",42:"0x04df6e4121c27713ed22341e7c7df330f56f289b"},USDC:{1:"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",42:"0xc2569dd7d0fd715b054fbf16e75b001e5c0c1115"},USDT:{1:"0xdac17f958d2ee523a2206206994597c13d831ec7",42:"0xcc08220af469192c53295fdd34cfb8df29aa17ab"},StaticPools:{staBal:{1:"0x06df3b2bbb68adc8b0e302443692037ed9f91b42000000000000000000000063",42:"0x45f78862bd3aa5205e63141fa7f2d35f38eb87c30000000000000000000000fd"},wethDai:{1:"0x0b09dea16768f0799065c475be02919503cb2a3500020000000000000000001a",42:"0x3a19030ed746bd1c3f2b0f996ff9479af04c5f0a000200000000000000000004"},wstEthWeth:{1:"0x32296969ef14eb0c6d29669c550d4a0449130230000200000000000000000080",42:"0xe08590bde837eb9b2d42aa1196469d6e08fe96ec000200000000000000000101"}}},Za={1:{},42:{}};function Xa(t,e){return o(this,void 0,void 0,(function*(){const n=new r.Contract(qa.wstETH[e],["function tokensPerStEth() external view returns (uint256)"],t);return yield n.tokensPerStEth()}))}function $a(t,e,n,i,l,d,p){return o(this,void 0,void 0,(function*(){let m,h=!1;n===qa.stETH[e]&&(n=qa.wstETH[e],m=!0),i===qa.stETH[e]&&(i=qa.wstETH[e],h=!0);const I=s(Ha),f=Za[e][`${n}${i}${l}`];return f?(I.tokenAddresses=f.tokenAddresses,I.swaps=f.swaps,I.swapAmount=d,I.swaps[0].amount=I.swapAmount.toString(),I.tokenIn=m?qa.stETH[e]:n,I.tokenOut=h?qa.stETH[e]:i,I.marketSp=function(t,e,n,a){const r=[];for(let o=0;o<e.length;o++){const i=e[o],s=a.filter((t=>t.id===i.poolId));if(1!==s.length)return c(0);const l=wa(s[0]);if(!l)return c(0);const d=l.parsePoolPairData(n[i.assetInIndex],n[i.assetOutIndex]);let p;p=t===exports.SwapTypes.SwapExactIn?l._spotPriceAfterSwapExactTokenInForTokenOut(d,u):l._spotPriceAfterSwapTokenInForExactTokenOut(d,u),r.push(p)}return r.reduce(((t,e)=>t.times(e)))}(l,I.swaps,I.tokenAddresses,t).toString(),I.returnAmount=yield function(t,e,n,i){return o(this,void 0,void 0,(function*(){const o=new r.Contract("0xBA12222222228d8Ba445958a75a0704d566BF2C8",Ga,i),s={sender:a.AddressZero,recipient:a.AddressZero,fromInternalBalance:!1,toInternalBalance:!1};try{const a=yield o.callStatic.queryBatchSwap(t,e,n,s);return t===exports.SwapTypes.SwapExactIn?a[n.length-1].mul(-1):a[0]}catch(t){return console.error("SOR - Lido Static Route QueryBatchSwap Error. No swaps."),a.Zero}}))}(l,I.swaps,I.tokenAddresses,p),I.returnAmount.isZero()?s(Ha):(I.returnAmountConsideringFees=I.returnAmount,I)):I}))}Za[1][`${qa.DAI[1]}${qa.wstETH[1]}0`]={name:"DAI/wstETH-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.DAI[1],qa.WETH[1],qa.wstETH[1]],swaps:[{poolId:qa.StaticPools.wethDai[1],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"}]},Za[1][`${qa.wstETH[1]}${qa.DAI[1]}0`]={name:"wstETH/DAI-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.wstETH[1],qa.WETH[1],qa.DAI[1]],swaps:[{poolId:qa.StaticPools.wstEthWeth[1],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"}]},Za[1][`${qa.DAI[1]}${qa.wstETH[1]}1`]={name:"DAI/wstETH-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.DAI[1],qa.WETH[1],qa.wstETH[1]],swaps:[{poolId:qa.StaticPools.wstEthWeth[1],amount:"",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[1][`${qa.wstETH[1]}${qa.DAI[1]}1`]={name:"wstETH/DAI-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.wstETH[1],qa.WETH[1],qa.DAI[1]],swaps:[{poolId:qa.StaticPools.wethDai[1],amount:"",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[1],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[1][`${qa.USDC[1]}${qa.wstETH[1]}0`]={name:"USDC/wstETH-SwapExactIn",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDC[1],qa.DAI[1],qa.WETH[1],qa.wstETH[1]],swaps:[{poolId:qa.StaticPools.staBal[1],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[1],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[1][`${qa.USDC[1]}${qa.wstETH[1]}1`]={name:"USDC/wstETH-SwapExactOut",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDC[1],qa.DAI[1],qa.WETH[1],qa.wstETH[1]],swaps:[{poolId:qa.StaticPools.wstEthWeth[1],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[1],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[1][`${qa.wstETH[1]}${qa.USDC[1]}0`]={name:"wstETH/USDC-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[1],qa.WETH[1],qa.DAI[1],qa.USDC[1]],swaps:[{poolId:qa.StaticPools.wstEthWeth[1],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[1],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[1][`${qa.wstETH[1]}${qa.USDC[1]}1`]={name:"wstETH/USDC-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[1],qa.WETH[1],qa.DAI[1],qa.USDC[1]],swaps:[{poolId:qa.StaticPools.staBal[1],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[1],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[1][`${qa.USDT[1]}${qa.wstETH[1]}0`]={name:"USDT/wstETH-SwapExactIn",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDT[1],qa.DAI[1],qa.WETH[1],qa.wstETH[1]],swaps:[{poolId:qa.StaticPools.staBal[1],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[1],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[1][`${qa.USDT[1]}${qa.wstETH[1]}1`]={name:"USDT/wstETH-SwapExactOut",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDT[1],qa.DAI[1],qa.WETH[1],qa.wstETH[1]],swaps:[{poolId:qa.StaticPools.wstEthWeth[1],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[1],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[1][`${qa.wstETH[1]}${qa.USDT[1]}0`]={name:"wstETH/USDT-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[1],qa.WETH[1],qa.DAI[1],qa.USDT[1]],swaps:[{poolId:qa.StaticPools.wstEthWeth[1],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[1],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[1][`${qa.wstETH[1]}${qa.USDT[1]}1`]={name:"wstETH/USDT-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[1],qa.WETH[1],qa.DAI[1],qa.USDT[1]],swaps:[{poolId:qa.StaticPools.staBal[1],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[1],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[1],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[42][`${qa.USDC[42]}${qa.wstETH[42]}0`]={name:"USDC/wstETH-SwapExactIn",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDC[42],qa.WETH[42],qa.wstETH[42]],swaps:[{poolId:qa.StaticPools.wethDai[42],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"}]},Za[42][`${qa.wstETH[42]}${qa.USDC[42]}0`]={name:"wstETH/USDC-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[42],qa.WETH[42],qa.USDC[42]],swaps:[{poolId:qa.StaticPools.wstEthWeth[42],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"}]},Za[42][`${qa.USDC[42]}${qa.wstETH[42]}1`]={name:"USDC/wstETH-SwapExactOut",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDC[42],qa.WETH[42],qa.wstETH[42]],swaps:[{poolId:qa.StaticPools.wstEthWeth[42],amount:"",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[42][`${qa.wstETH[42]}${qa.USDC[42]}1`]={name:"wstETH/USDC-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[42],qa.WETH[42],qa.USDC[42]],swaps:[{poolId:qa.StaticPools.wethDai[42],amount:"",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[42],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[42][`${qa.DAI[42]}${qa.wstETH[42]}0`]={name:"DAI/wstETH-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.DAI[42],qa.USDC[42],qa.WETH[42],qa.wstETH[42]],swaps:[{poolId:qa.StaticPools.staBal[42],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[42],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[42][`${qa.DAI[42]}${qa.wstETH[42]}1`]={name:"DAI/wstETH-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.DAI[42],qa.USDC[42],qa.WETH[42],qa.wstETH[42]],swaps:[{poolId:qa.StaticPools.wstEthWeth[42],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[42],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[42][`${qa.wstETH[42]}${qa.DAI[42]}0`]={name:"wstETH/DAI-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.wstETH[42],qa.WETH[42],qa.USDC[42],qa.DAI[42]],swaps:[{poolId:qa.StaticPools.wstEthWeth[42],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[42],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[42][`${qa.wstETH[42]}${qa.DAI[42]}1`]={name:"wstETH/DAI-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:18,tokenAddresses:[qa.wstETH[42],qa.WETH[42],qa.USDC[42],qa.DAI[42]],swaps:[{poolId:qa.StaticPools.staBal[42],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[42],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[42][`${qa.USDT[42]}${qa.wstETH[42]}0`]={name:"USDT/wstETH-SwapExactIn",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDT[42],qa.USDC[42],qa.WETH[42],qa.wstETH[42]],swaps:[{poolId:qa.StaticPools.staBal[42],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[42],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[42][`${qa.USDT[42]}${qa.wstETH[42]}1`]={name:"USDT/wstETH-SwapExactOut",tokenInDecimals:6,tokenOutDecimals:18,tokenAddresses:[qa.USDT[42],qa.USDC[42],qa.WETH[42],qa.wstETH[42]],swaps:[{poolId:qa.StaticPools.wstEthWeth[42],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[42],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]},Za[42][`${qa.wstETH[42]}${qa.USDT[42]}0`]={name:"wstETH/USDT-SwapExactIn",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[42],qa.WETH[42],qa.USDC[42],qa.USDT[42]],swaps:[{poolId:qa.StaticPools.wstEthWeth[42],amount:"",assetInIndex:0,assetOutIndex:1,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.staBal[42],amount:"0",assetInIndex:2,assetOutIndex:3,userData:"0x"}]},Za[42][`${qa.wstETH[42]}${qa.USDT[42]}1`]={name:"wstETH/USDT-SwapExactOut",tokenInDecimals:18,tokenOutDecimals:6,tokenAddresses:[qa.wstETH[42],qa.WETH[42],qa.USDC[42],qa.USDT[42]],swaps:[{poolId:qa.StaticPools.staBal[42],amount:"",assetInIndex:2,assetOutIndex:3,userData:"0x"},{poolId:qa.StaticPools.wethDai[42],amount:"0",assetInIndex:1,assetOutIndex:2,userData:"0x"},{poolId:qa.StaticPools.wstEthWeth[42],amount:"0",assetInIndex:0,assetOutIndex:1,userData:"0x"}]};const ja={Networks:[1],1:{"0xd46ba6d942050d489dbd938a2c909a5d5039a161":"0xedb171c18ce90b633db442f2a6f72874093b49ef","0x1e6bb68acec8fefbd87d192be09bb274170a0548":"0xF03387d8d0FF326ab586A58E0ab4121d106147DF"}};function za(t,e){return o(this,void 0,void 0,(function*(){return new r.Contract(e,["function underlyingToWrapper(uint256 amount) external view returns (uint256)"],t).underlyingToWrapper(a.WeiPerEther)}))}var Va;!function(t){t[t.None=0]="None",t[t.ETH=1]="ETH",t[t.stETH=2]="stETH",t[t.Unbutton=3]="Unbutton"}(Va||(Va={}));const Ya=t=>[...new Set(t.flatMap((t=>t.flatMap((t=>[t.tokenIn,t.tokenOut])))))],Ka=t=>t.reduce(((t,{amount:e})=>t.add(e)),a.Zero),Ja=(t,e,n)=>(t===exports.SwapTypes.SwapExactOut&&(e=e.reverse()),e.map(((e,a)=>{var r;let o="0";if(0===a){const n=t===exports.SwapTypes.SwapExactIn?e.tokenInDecimals:e.tokenOutDecimals;o=p(c(e.swapAmount),n).decimalPlaces(0,1).toString()}const i=t===exports.SwapTypes.SwapExactIn?e.tokenOutDecimals:e.tokenInDecimals,s=p(c(null!==(r=e.returnAmount)&&void 0!==r?r:"0"),i).decimalPlaces(0,1).toString(),u=n.indexOf(e.tokenIn),l=n.indexOf(e.tokenOut);return{poolId:e.pool,assetInIndex:u,assetOutIndex:l,amount:o,userData:"0x",returnAmount:s}})));class Qa{constructor(t){this.poolDataService=t,this.pools=[],this._finishedFetching=!1}get finishedFetching(){return this._finishedFetching}getPools(t){const e=s(this.pools);if(t)for(const t of e)if("Weighted"===t.poolType||"Investment"===t.poolType){const e={address:t.address,balance:t.totalShares,decimals:18,priceRate:"1",weight:"0"};t.tokens.push(e),t.tokensList.push(t.address)}return e}fetchPools(t){return o(this,void 0,void 0,(function*(){try{return this.pools=yield this.poolDataService.getPools(t),this._finishedFetching=!0,!0}catch(t){return this._finishedFetching=!1,this.pools=[],console.error(`Error: fetchPools(): ${t}`),!1}}))}}const tr=7;function er(t,e,n,a){const r={},o={},i={};return Object.keys(t).forEach((s=>{const u=t[s],l=new Set(u.tokensList),d=l.has(e.toLowerCase()),p=l.has(n.toLowerCase());if(d&&p)r[u.id]=u;else if(a>1)if(d&&!p)for(const t of l)o[t]||(o[t]=new Set([])),o[t].add(u.id);else if(!d&&p)for(const t of[...l])i[t]||(i[t]=new Set([])),i[t].add(u.id)})),[r,o,i]}function nr(t,e,n,a,r,o){const i=[];for(const a in n){const n=or([t,e],[o[a]]);i.push(n)}for(const n in a)if(r[n]){let s,l,d=u,p=u;for(const e of[...a[n]]){const a=o[e],r=a.parsePoolPairData(t,n),i=a.getNormalizedLiquidity(r);i.isGreaterThanOrEqualTo(d)&&(d=i,s=a.id)}for(const t of[...r[n]]){const a=o[t],r=a.parsePoolPairData(n,e),i=a.getNormalizedLiquidity(r);i.isGreaterThanOrEqualTo(p)&&(p=i,l=a.id)}if(s&&l){const a=or([t,n,e],[o[s],o[l]]);i.push(a)}}return i}function ar(t,e,n,a){const r=function(t,e,n,a){const r=new Set,o=[],i=[],s=a.connectingTokens?a.connectingTokens.map((t=>t.address)):[];for(const u in n){const l=n[u];if(l.poolType==exports.PoolTypes.Linear)o.push(l.address),r.add(l);else{const o=l.tokensList.map((t=>t.toLowerCase()));(o.includes(l.address)||l.poolType===exports.PoolTypes.Weighted)&&i.push(l),a.lbpRaisingTokens&&l.isLBP&&dr(r,a.lbpRaisingTokens,l,t,e,s,n)}}if(0==o.length)return{};for(const a of s)pr(t,a,n,r),pr(a,e,n,r);const u=new Set;for(const t of i)t.tokensList.some((t=>o.includes(t)))&&(r.add(t),u.add(t.address));for(const t in n){const e=n[t];e.tokensList.some((t=>u.has(t)))&&r.add(e)}return a.wETHwstETH&&n[a.wETHwstETH.id]&&r.add(n[a.wETHwstETH.id]),function(t){const e={};for(const n of t){const t=n.tokensList.length;for(let a=0;a<t;a++){e[n.tokensList[a]]||(e[n.tokensList[a]]=[]);for(let r=0;r<t;r++){if(a==r)continue;const t=[n.id,n.tokensList[a],n.tokensList[r]];e[n.tokensList[a]].push(t)}}}return e}([...r])}(t,e,n,a),o=[],i=[[{edge:["","",t],parentIndices:[-1,-1],visitedNodes:[]}]];let s=!0;for(;s;){const t=i.length,n=[];for(let a=0;a<i[t-1].length;a++){const s=i[t-1][a],u=r[s.edge[2]];if(u)for(const r of u){if(s.visitedNodes.includes(r[2])||s.edge[0]==r[0])continue;r[2]==e&&o.push(rr(r,s,i));const u={edge:r,parentIndices:[t-1,a],visitedNodes:s.visitedNodes.concat(r[1])};n.push(u)}}0==n.length?s=!1:i.push(n),t==tr&&(s=!1)}return function(t,e){const n=[];for(const a of t){const t=a[1].map((t=>e[t]));t.length>2&&n.push(or(a[0],t))}return n}(o,n)}function rr(t,e,n){const a=[t];a.unshift(e.edge);let r=e.parentIndices;for(;-1!==r[0];)a.unshift(n[r[0]][r[1]].edge),r=n[r[0]][r[1]].parentIndices;const o=a.map((t=>t[0]));o.splice(0,1);return[a.map((t=>t[2])),o]}function or(t,e){let n,r;const o=[],i=[];let s="";for(let a=0;a<e.length;a++){n=t[a],r=t[a+1];const u=e[a].parsePoolPairData(n,r);i.push(u),s+=u.id;const l={pool:e[a].id,tokenIn:n,tokenOut:r,tokenInDecimals:u.decimalsIn,tokenOutDecimals:u.decimalsOut};o.push(l)}return{id:s,swaps:o,limitAmount:a.Zero,poolPairData:i,pools:e}}function ir(t,e,n){let a=u,r=null;for(const o in n){const i=n[o],s=new Set(i.tokensList);if(!s.has(t.toLowerCase())||!s.has(e.toLowerCase()))continue;const u=i.parsePoolPairData(t,e),l=i.getNormalizedLiquidity(u);l.isGreaterThanOrEqualTo(a)&&(a=l,r=o)}return r}function sr(t){let e="",n=[],r=[],o=[];for(const a of t)e+=a.id,n=n.concat(a.swaps),r=r.concat(a.poolPairData),o=o.concat(a.pools);return{id:e,swaps:n,poolPairData:r,limitAmount:a.Zero,pools:o}}function ur(t,e){return Object.fromEntries(s(t).filter((t=>t.tokensList.length>0&&"0"!==t.tokens[0].balance)).map((t=>[t.id,wa(t,e)])).filter((([,t])=>void 0!==t)))}function lr(t,e,n){let a;const r=t.tokensList;if(r.includes(n)&&!e.includes(n))for(let t=0;t<2;t++)r[t]==n&&(a=r[1-t]);return a}function dr(t,e,n,a,r,o,i){const s=e.map((t=>t.toLowerCase()));if(0===s.length)return;const u=lr(n,s,a),l=lr(n,s,r);if(u||l){t.add(n);for(const e of o)u&&u!==e&&pr(u,e,i,t),l&&l!==e&&pr(e,l,i,t)}}function pr(t,e,n,a){const r=ir(t,e,n);r&&a.add(n[r])}function cr(n,r){let o=a.Zero;n.forEach((n=>{n.limitAmount=function(n,r){const o=n.poolPairData;let i;if(r===exports.SwapTypes.SwapExactIn){i=n.pools[o.length-1].getLimitAmountSwap(o[o.length-1],exports.SwapTypes.SwapExactIn);for(let t=o.length-2;t>=0;t--){const a=n.pools[t].getLimitAmountSwap(o[t],exports.SwapTypes.SwapExactIn);if(n.pools[t].getLimitAmountSwap(o[t],exports.SwapTypes.SwapExactOut).lte(i))i=a;else{const r=ya(n.pools[t],n.poolPairData[t],exports.SwapTypes.SwapExactOut,i);i=e.BigNumber.min(r,a)}}if(i.isZero())return a.Zero;return t.parseFixed(i.dp(o[0].decimalsIn).toString(),o[0].decimalsIn)}i=n.pools[0].getLimitAmountSwap(o[0],exports.SwapTypes.SwapExactOut);for(let t=1;t<o.length;t++){const a=n.pools[t].getLimitAmountSwap(o[t],exports.SwapTypes.SwapExactIn),r=n.pools[t].getLimitAmountSwap(o[t],exports.SwapTypes.SwapExactOut);if(a.lte(i))i=r;else{const a=ya(n.pools[t],n.poolPairData[t],exports.SwapTypes.SwapExactIn,i);i=e.BigNumber.min(a,r)}}return i.isZero()?a.Zero:t.parseFixed(i.dp(o[o.length-1].decimalsOut).toString(),o[o.length-1].decimalsOut)}(n,r),o=o.add(n.limitAmount)}));return[n.sort(((t,e)=>e.limitAmount.gt(t.limitAmount)?1:-1)),o]}class mr{constructor(t){this.config=t,this.cache={}}getCandidatePaths(t,e,n,a,r){if(t=t.toLowerCase(),e=e.toLowerCase(),0===a.length)return[];const o=this.cache[`${t}${e}${n}${r.timestamp}`];if(!r.forceRefresh&&o)return o.paths;const i=ur(a,r.timestamp),[s,u,l]=er(i,t,e,r.maxPools),d=nr(t,e,s,u,l,i),p=ar(t,e,i,this.config),c=function(t,e,n,a,r){var o;const i=r.usdcConnectingPool;if(!i)return[];const s=n[i.id],u=null===(o=r.staBal3Pool)||void 0===o?void 0:o.address;if(!s||!u)return[];const l=ir(t,u,a),d=ir(u,e,a);if(l&&!d){const n=a[l],r=or([t,u,i.usdc],[n,s]),o=ir(i.usdc,e,a);if(null===o)return[];const d=a[o];return[sr([r,or([i.usdc,e],[d])])]}if(!l&&d){const n=ir(t,i.usdc,a);if(null===n)return[];const r=a[d],o=a[n],l=or([i.usdc,u,e],[s,r]);return[sr([or([t,i.usdc],[o]),l])]}return[]}(t,e,i,i,this.config),m=d.concat(...p).concat(...c),[h]=cr(m,n);return this.cache[`${t}${e}${n}${r.timestamp}`]={paths:h},h}getCandidatePathsFromDict(t,e,n,a,r){if(t=t.toLowerCase(),e=e.toLowerCase(),0===Object.keys(a).length)return[];const[o,i,s]=er(a,t,e,r),u=nr(t,e,o,i,s,a),l=ar(t,e,a,this.config),d=u.concat(...l),[p]=cr(d,n);return p}}class hr{constructor(t,e){this.tokenPriceService=e,this.tokenPriceCache={AddressZero:"1",[t.weth.toLowerCase()]:"1"}}convertGasCostToToken(e,n,r,i=t.BigNumber.from("85000")){return o(this,void 0,void 0,(function*(){if(r.isZero()||i.isZero())return a.Zero;const o=yield this.getNativeAssetPriceInToken(e),s=t.BigNumber.from(p(c(o),n).dp(0).toString());return r.mul(i).mul(s).div(a.WeiPerEther)}))}setNativeAssetPriceInToken(t,e){this.tokenPriceCache[t.toLowerCase()]=e}getNativeAssetPriceInToken(t){return o(this,void 0,void 0,(function*(){const e=this.tokenPriceCache[t.toLowerCase()];if(e)return e;try{const e=yield this.tokenPriceService.getNativeAssetPriceInToken(t);return this.setNativeAssetPriceInToken(t,e),e}catch(t){return console.log("Error Getting Token Price. Defaulting to 0."),console.log(t),"0"}}))}}Object.defineProperty(exports,"OldBigNumber",{enumerable:!0,get:function(){return e.BigNumber}}),exports.ComposableStablePool=we,exports.Gyro2Maths=en,exports.Gyro3Maths=kn,exports.GyroEMaths=Vn,exports.ISOLATED_CONST="isolated",exports.LinearMaths=ee,exports.LinearPool=ne,exports.MetaStablePool=yt,exports.PhantomStablePool=ge,exports.RouteProposer=mr,exports.SOR=class{constructor(e,n,a,r){this.provider=e,this.config=n,this.defaultSwapOptions={gasPrice:t.parseFixed("50",9),swapGas:t.BigNumber.from("85000"),poolTypeFilter:exports.PoolFilter.All,maxPools:4,timestamp:Math.floor(Date.now()/1e3),forceRefresh:!1},this.poolCacher=new Qa(a),this.routeProposer=new mr(n),this.swapCostCalculator=new hr(n,r)}getPools(t){return this.poolCacher.getPools(t)}fetchPools(){return o(this,void 0,void 0,(function*(){return this.poolCacher.fetchPools()}))}getSwaps(e,n,r,i,u,l=!1){return o(this,void 0,void 0,(function*(){if(!this.poolCacher.finishedFetching)return s(Ha);const d=Object.assign(Object.assign({},this.defaultSwapOptions),u);this.useBpt!==l&&(d.forceRefresh=!0,this.useBpt=l);const p=((t,e)=>e===exports.PoolFilter.All?t:t.filter((t=>t.poolType===e)))(this.poolCacher.getPools(l),d.poolTypeFilter),c=yield function(t,e,n,r,i,s){return o(this,void 0,void 0,(function*(){n=n.toLowerCase(),r=r.toLowerCase();let o=s,u=n,l=Va.None,d=r,p=Va.None,c=a.WeiPerEther,m=a.WeiPerEther;if(n===a.AddressZero&&(u=i.weth.toLowerCase(),l=Va.ETH),r===a.AddressZero&&(d=i.weth.toLowerCase(),p=Va.ETH),n===qa.stETH[i.chainId]){u=qa.wstETH[i.chainId],l=Va.stETH;const n=yield Xa(t,i.chainId);c=n,e===exports.SwapTypes.SwapExactIn&&(o=s.mul(n).div(a.WeiPerEther))}if(r===qa.stETH[i.chainId]){d=qa.wstETH[i.chainId],p=Va.stETH;const n=yield Xa(t,i.chainId);m=n,e===exports.SwapTypes.SwapExactOut&&(o=s.mul(n).div(a.WeiPerEther))}const h=ja[i.chainId]||{};return h[n]&&(u=h[n],l=Va.Unbutton,c=yield za(t,u),e===exports.SwapTypes.SwapExactIn&&(o=s.mul(c).div(a.WeiPerEther))),h[r]&&(d=h[r],p=Va.Unbutton,m=yield za(t,d),e===exports.SwapTypes.SwapExactOut&&(o=s.mul(m).div(a.WeiPerEther))),{swapAmountOriginal:s,swapAmountForSwaps:o,tokenIn:{addressOriginal:n,addressForSwaps:u,wrapType:l,rate:c},tokenOut:{addressOriginal:r,addressForSwaps:d,wrapType:p,rate:m}}}))}(this.provider,r,e,n,this.config,t.BigNumber.from(i));let m;return m=function(t,e,n){return!!qa.Networks.includes(t)&&(e=e.toLowerCase(),n=n.toLowerCase(),e===qa.wstETH[t]&&n===qa.DAI[t]||e===qa.wstETH[t]&&n===qa.USDC[t]||e===qa.wstETH[t]&&n===qa.USDT[t]||e===qa.DAI[t]&&n===qa.wstETH[t]||e===qa.USDC[t]&&n===qa.wstETH[t]||e===qa.USDT[t]&&n===qa.wstETH[t]||e===qa.stETH[t]&&n===qa.DAI[t]||e===qa.stETH[t]&&n===qa.USDC[t]||e===qa.stETH[t]&&n===qa.USDT[t]||e===qa.DAI[t]&&n===qa.stETH[t]||e===qa.USDC[t]&&n===qa.stETH[t]||e===qa.USDT[t]&&n===qa.stETH[t])}(this.config.chainId,e,n)?yield $a(p,this.config.chainId,c.tokenIn.addressForSwaps,c.tokenOut.addressForSwaps,r,c.swapAmountForSwaps,this.provider):yield this.processSwaps(c.tokenIn.addressForSwaps,c.tokenOut.addressForSwaps,r,c.swapAmountForSwaps,p,d),m.returnAmount.isZero()||(m=function(t,e,n,r){if(0===t.swaps.length)return t;if(t.tokenIn=n.tokenIn.addressOriginal,t.tokenOut=n.tokenOut.addressOriginal,t.swapAmountForSwaps=t.swapAmount,t.returnAmountFromSwaps=t.returnAmount,t.tokenInForSwaps=n.tokenIn.addressForSwaps,t.tokenOutFromSwaps=n.tokenOut.addressForSwaps,n.tokenIn.wrapType===Va.None&&n.tokenOut.wrapType===Va.None)return t;n.tokenIn.wrapType!==Va.ETH&&n.tokenOut.wrapType!==Va.ETH||(t.tokenAddresses=t.tokenAddresses.map((t=>w(t,r.weth)?a.AddressZero:t)));const o=t=>t===Va.stETH||t===Va.Unbutton;return(o(n.tokenIn.wrapType)&&e===exports.SwapTypes.SwapExactIn||o(n.tokenOut.wrapType)&&e===exports.SwapTypes.SwapExactOut)&&(t.swapAmount=n.swapAmountOriginal,t.swapAmountForSwaps=n.swapAmountForSwaps),e===exports.SwapTypes.SwapExactIn&&o(n.tokenOut.wrapType)&&(t.returnAmount=t.returnAmount.mul(a.WeiPerEther).div(n.tokenOut.rate),t.returnAmountConsideringFees=t.returnAmountConsideringFees.mul(a.WeiPerEther).div(n.tokenOut.rate)),e===exports.SwapTypes.SwapExactOut&&o(n.tokenIn.wrapType)&&(t.returnAmount=t.returnAmount.mul(a.WeiPerEther).div(n.tokenIn.rate),t.returnAmountConsideringFees=t.returnAmountConsideringFees.mul(a.WeiPerEther).div(n.tokenIn.rate)),t}(m,r,c,this.config)),m}))}getCostOfSwapInToken(t,e,n,r){return o(this,void 0,void 0,(function*(){return n.isZero()?a.Zero:this.swapCostCalculator.convertGasCostToToken(t,e,n,r)}))}processSwaps(e,n,a,r,i,u){return o(this,void 0,void 0,(function*(){if(0===i.length)return s(Ha);const o=this.routeProposer.getCandidatePaths(e,n,a,i,u);if(0==o.length)return s(Ha);let l,d;o[0].swaps.forEach((t=>{w(t.tokenIn,e)&&(l=t.tokenInDecimals),w(t.tokenOut,n)&&(d=t.tokenOutDecimals)}));const p=yield this.getCostOfSwapInToken(a===exports.SwapTypes.SwapExactIn?n:e,a===exports.SwapTypes.SwapExactIn?d:l,u.gasPrice,u.swapGas),[c,m,h,I]=this.getBestPaths(o,r,a,l,d,p,u.maxPools),f=function(e,n,a,r,o,i,u,l){if(0===e.length)return s(Ha);const d=s(e),p=Ya(d),c=d.flatMap((t=>Ja(n,t,p))),m=a.sub(Ka(c));return m.gt(0)&&(c[0].amount=t.BigNumber.from(c[0].amount).add(m).toString()),{swapAmount:a,swapAmountForSwaps:a,returnAmount:i,returnAmountFromSwaps:i,returnAmountConsideringFees:u,swaps:c,tokenAddresses:p,tokenIn:r,tokenOut:o,marketSp:l}}(c,a,r,e,n,m,I,h);return f}))}getBestPaths(n,a,r,o,i,s,u){const[l,d]=r===exports.SwapTypes.SwapExactIn?[o,i]:[i,o],[p,c,m,h]=Ca(n,r,a,l,d,u,s);return[p,t.parseFixed(c.dp(d,e.BigNumber.ROUND_FLOOR).toString(),d),m.toString(),t.parseFixed(h.dp(d,e.BigNumber.ROUND_FLOOR).toString(),d)]}},exports.StableMathBigInt=gt,exports.StableMaths=it,exports.StablePool=wt,exports.WeightedMaths=j,exports.WeightedPool=V,exports.ZERO=u,exports.balancesFromTokenInOut=vn,exports.bnum=c,exports.formatSequence=Ja,exports.getSpotPriceAfterSwapForPath=va,exports.getTokenAddressesForSwap=t=>[...new Set(t.flatMap((t=>[t.tokenIn,t.tokenOut])))],exports.parseToPoolsDict=ur,exports.stableBPTForTokensZeroPriceImpact=function(e,n,r,o,i){if(e.length!=r.length)throw"allBalances and amounts have to have same length";const s=e.map(((e,a)=>c(t.formatFixed(e,n[a])))),l=r.reduce(((e,r,l)=>{const d={amp:t.BigNumber.from(i),allBalances:s,tokenIndexIn:l,balanceOut:o,decimalsOut:18,swapFee:a.Zero},p=ot(u,d),m=c(t.formatFixed(r,n[l])).div(p).toString();return t.BigNumber.from(e).add(t.parseFixed(m,18))}),a.Zero);return t.BigNumber.from(l)},exports.weightedBPTForTokensZeroPriceImpact=function(e,n,r,o,i){const s=o.reduce(((o,s,l)=>{const d={balanceIn:e[l],decimalsIn:n[l],balanceOut:i,weightIn:r[l],swapFee:a.Zero},p=G(u,d),m=c(t.formatFixed(s,n[l])).div(p).toString();return t.BigNumber.from(o).add(t.parseFixed(m,18))}),a.Zero);return t.BigNumber.from(s)};
//# sourceMappingURL=index.js.map
