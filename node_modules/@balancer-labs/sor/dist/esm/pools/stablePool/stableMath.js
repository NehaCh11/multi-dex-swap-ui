import{formatFixed as t}from"@ethersproject/bignumber";import{WeiPerEther as e}from"@ethersproject/constants";import{ZERO as i,bnum as s,ONE as n}from"../../utils/bignumber.js";function m(e,n){let m=i;const l=n.length;for(let t=0;t<l;t++)m=m.plus(n[t]);if(m.isZero())return i;let u=i,o=m;const r=s(t(e,3)).times(l**l);for(let t=0;t<255;t++){let t=s(l).times(n[0]);for(let e=1;e<l;e++)t=t.times(n[e]).times(l).div(o);if(u=o,o=s(l).times(o).times(o).plus(r.times(m).times(t)).div(s(l+1).times(o).plus(r.minus(1).times(t))),o.gt(u)){if(o.minus(u).lt(s(1e-18)))break}else if(u.minus(o).lt(s(1e-18)))break}return o}function l(t,l){if(t.isZero())return t;const{amp:u,allBalances:r,tokenIndexIn:d,tokenIndexOut:p,swapFee:c}=l,v=[...r],a=v.length,f=u.div(a**(a-1));let g=t;g=g.times(e.sub(c).toString()).div(e.toString());const I=m(f,v);let S=I,h=i;const k=s(v.length);let x=n,b=i;for(let t=0;t<v.length;t++){if(x=x.times(k),t==d)b=v[t].plus(g);else{if(t==p)continue;b=v[t]}h=h.plus(b),S=S.times(I).div(b)}const w=o(h,I,f,x,S);return v[p].minus(w)}function u(t,l){if(t.isZero())return t;const{amp:u,allBalances:r,tokenIndexIn:d,tokenIndexOut:p,swapFee:c}=l,v=[...r],a=v.length,f=u.div(a**(a-1)),g=t,I=m(f,v);let S=I,h=i;const k=s(v.length);let x=n,b=i;for(let t=0;t<v.length;t++){if(x=x.times(k),t==p)b=v[t].minus(g);else{if(t==d)continue;b=v[t]}h=h.plus(b),S=S.times(I).div(b)}return o(h,I,f,x,S).minus(v[d]).multipliedBy(e.toString()).div(e.sub(c).toString())}function o(e,i,n,m,l){const u=s(t(n,3));l=l.times(i).div(u.times(m).times(m));const o=e.plus(i.div(u.times(m)));return i.minus(o).plus(i.minus(o).times(i.minus(o)).plus(l.times(4)).sqrt()).div(2)}function r(e,n,l,u,o,r){const d=n.length,p=m(e,n);let c=i;for(let t=0;t<d;t++)t!=l&&t!=u&&(c=c.plus(n[t]));const v=n[l],a=n[u],f=s(t(e,3)).times(d**d),g=c.minus(p).times(f).plus(p),I=s(2).times(f).times(v).times(a),S=I.plus(f.times(a).times(a)).plus(g.times(a)),h=I.plus(f.times(v).times(v)).plus(g.times(v));let k;if(o)k=S.div(h);else{const t=s(2).times(f).times(a),e=s(2).times(f).times(v),i=t.plus(e).plus(g),n=s(2).times(S).times(h).times(i).minus(t.times(h.pow(2))).minus(e.times(S.pow(2))),m=S.pow(2).times(h);k=n.div(m),r&&(k=k.times(h).div(S))}return k}function d(t,i){const{amp:s,allBalances:m,tokenIndexIn:u,tokenIndexOut:o,swapFee:d}=i,p=[...m],c=p.length,v=s.div(c**(c-1));p[u]=p[u].plus(t.times(e.sub(d).toString()).div(e.toString())),p[o]=p[o].minus(l(t,i));let a=r(v,p,u,o,!0,!1);return a=n.div(a.times(e.sub(d).toString()).div(e.toString())),a}function p(t,i){const{amp:s,allBalances:m,tokenIndexIn:l,tokenIndexOut:o,swapFee:d}=i,p=[...m],c=p.length,v=s.div(c**(c-1)),a=u(t,i).times(e.sub(d).toString()).div(e.toString());p[l]=p[l].plus(a),p[o]=p[o].minus(t);let f=r(v,p,l,o,!0,!0);return f=n.div(f.times(e.sub(d).toString()).div(e.toString())),f}function c(t,i){const{amp:s,allBalances:n,tokenIndexIn:m,tokenIndexOut:u,swapFee:o}=i,d=[...n],p=d.length,c=s.div(p**(p-1));return d[m]=d[m].plus(t.times(e.sub(o).toString()).div(e.toString())),d[u]=d[u].minus(l(t,i)),r(c,d,m,u,!1,!1)}function v(t,i){const{amp:s,allBalances:n,tokenIndexIn:m,tokenIndexOut:l,swapFee:o}=i,d=[...n],p=d.length,c=s.div(p**(p-1)),v=u(t,i).times(e.sub(o).toString()).div(e.toString());d[m]=d[m].plus(v),d[l]=d[l].minus(t);const a=e.div(o).toString();return r(c,d,m,l,!1,!0).div(a)}function a(l,u){const{amp:r,allBalances:d,balanceOut:p,tokenIndexIn:c,decimalsOut:v,swapFee:a}=u,f=[...d],g=f.length,I=r.div(g**(g-1)),S=function(t,s){if(t.isZero())return t;const{amp:l,allBalances:u,tokenIndexIn:r,tokenIndexOut:d,swapFee:p}=s,c=[...u],v=c.length,a=l.div(v**(v-1)),f=t,g=m(a,c),I=u[d].plus(f).div(u[d]).times(g);let S=i;for(let t=0;t<c.length;t++)S=S.plus(c[t]);const h=function(t,e,s,m){let l=s,u=i;const r=e.length;let d=n,p=i;for(let t=0;t<r;t++)d=d.times(r),t!=m&&(p=e[t],u=u.plus(p),l=l.times(s).div(p));return o(u,s,t,d,l)}(a,c,I,r),k=h.minus(c[r]),x=c[r].div(S),b=n.minus(x);return k.div(n.minus(b.times(p.toString()).div(e.toString())))}(l,u),h=function(t,s,m){let l=i;for(let e=0;e<t.length;e++)l=l.plus(t[e]);const u=t[s].div(l),o=n.minus(u);return n.minus(o.times(m.toString()).div(e.toString()))}(f,c,a);f[c]=f[c].plus(S.times(h));let k=function(e,l,u,o,r,d,p){const c=l.length,v=m(e,l);let a=i,f=v.div(c);for(let t=0;t<c;t++)t!=o&&(a=a.plus(l[t]),f=f.times(v).div(l[t].times(c)));const g=l[o],I=s(t(e,3)),S=I.times(c**c),h=S.times(a),k=n.minus(S),x=s(2).times(S).times(g).plus(h).plus(k.times(v)),b=f.times(c+1).minus(k.times(g)),w=i.minus(b);let B;if(r)B=x.div(b).times(u).div(v);else{const t=s(2).times(S),e=k,n=c*(c+1),m=i.minus(f.times(n).div(v));if(d){const n=t.times(w).div(x.pow(2)),l=s(2).times(e).div(x),o=m.div(w);if(B=n.minus(l).plus(o).times(v).div(u),p){const t=i.minus(x.div(w));B=B.div(t).times(v).div(u)}}else B=s(2).times(e).div(w).minus(m.times(x).div(w.pow(2))).minus(t.div(x)),p&&(B=B.times(x).div(b).times(u).div(v))}return B}(I,f,s(t(p,v)).plus(l),c,!0,!0,!0);return k=n.div(k.times(h)),k}export{c as _derivativeSpotPriceAfterSwapExactTokenInForTokenOut,v as _derivativeSpotPriceAfterSwapTokenInForExactTokenOut,l as _exactTokenInForTokenOut,m as _invariant,o as _solveAnalyticalBalance,d as _spotPriceAfterSwapExactTokenInForTokenOut,a as _spotPriceAfterSwapTokenInForExactBPTOut,p as _spotPriceAfterSwapTokenInForExactTokenOut,u as _tokenInForExactTokenOut};
//# sourceMappingURL=stableMath.js.map
