import{bnum as e,scale as t}from"../../utils/bignumber.js";import{formatFixed as n}from"@ethersproject/bignumber";const r=-1000000000000024e-21;e("-1"),e("1");const o=100;BigInt("100");const a=1e8;BigInt("100000000");const s=1e6;BigInt("1000000");const i=1e13;BigInt("10000000000000");const u=t(e("1"),18),c=1e-19,b=.25;var l;!function(e){e.LowerHalt="CurveMath/lower-halt",e.UpperHalt="CurveMath/upper-halt",e.SwapInvariantViolation="CurveMath/swap-invariant-violation",e.SwapConvergenceFailed="CurveMath/swap-convergence-failed",e.CannotSwap="CannotSwap"}(l||(l={}));const m=e=>"0x2791bca1f2de4661ed88a30c99a7a9449aa84174"==e||"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"==e,I=(t,n)=>"string"==typeof n?Number(e(t).div(e(u))):t/n,N=e=>{let t,n;return m(e.tokenIn)?(t=I(L(Number(e.balanceIn),e.tokenInLatestFXPrice.toNumber()),h(e.decimalsIn)),n=I(L(Number(e.balanceOut),e.tokenOutLatestFXPrice.toNumber()),h(e.decimalsOut))):(t=I(L(Number(e.balanceOut),e.tokenOutLatestFXPrice.toNumber()),h(e.decimalsOut)),n=I(L(Number(e.balanceIn),e.tokenInLatestFXPrice.toNumber()),h(e.decimalsIn))),{tokenInReservesInNumeraire:t,tokenOutReservesInNumeraire:n,_oGLiq:t+n}},k=(e,t,r)=>{const o=m(t.tokenIn)?I(L(Number(t.balanceOut),t.tokenOutLatestFXPrice.toNumber()),h(t.decimalsOut)):I(L(Number(t.balanceIn),t.tokenInLatestFXPrice.toNumber()),h(t.decimalsIn)),a=m(t.tokenIn)?I(L(Number(t.balanceIn),t.tokenInLatestFXPrice.toNumber()),h(t.decimalsIn)):I(L(Number(t.balanceOut),t.tokenOutLatestFXPrice.toNumber()),h(t.decimalsOut)),s=m(t.tokenIn)?t.tokenOutLatestFXPrice.toNumber():t.tokenInLatestFXPrice.toNumber(),i=((e,t,n)=>{let r;return r=L(n,e?t.tokenInLatestFXPrice.toNumber():t.tokenOutLatestFXPrice.toNumber()),r})(r,t,Number(e.toString()));return{alpha:Number(n(t.alpha,18)),beta:Number(n(t.beta,18)),delta:Number(n(t.delta,18)),epsilon:Number(n(t.epsilon,18)),lambda:Number(n(t.lambda,18)),baseTokenRate:s,_oGLiq:o+a,_nGLiq:o+a,_oBals:[a,o],_nBals:m(t.tokenIn)?[a+i,o-i]:[a-i,o+i],givenAmountInNumeraire:i}},h=e=>{switch(e){case 6:return s;case 2:return 100;default:return u.toString()}},p=(t,n)=>e(t/n),L=(e,t)=>e*t,w=(e,t,n,r)=>{let o,a,s=0;return e<t?(o=t*(1-n),e<o?(a=o-e,s=a/t,s*=r,s>b&&(s=b),s*=a):s=0):(o=t*(1+n),e>o?(a=e-o,s=a/t,s*=r,s>b&&(s=b),s*=a):s=0),s},f=(e,t,n,r,o)=>{const a=t.length;let s=0;for(let i=0;i<a;i++){const a=e*o[i];s+=w(t[i],a,n,r)}return s},d=(e,t,n,r,o,a,s)=>{let u;const c=[.5,.5],b=s.alpha,m=s.beta,I=s.delta,N=s.lambda;u=-o;const k=f(e,n,m,I,c);let h;for(let s=0;s<32;s++){h=f(t,r,m,I,c);const s=u;if(u=k<h?-(o+(k-h)):-(o+N*(k-h)),u/i==s/i)return t=e+o+u,r[a]=n[a]+u,v(e,k,t,h),_(e,t,n,r,c,b),[u,t];t=e+o+u,r[a]=n[a]+u}throw new Error(l.SwapConvergenceFailed)},_=(e,t,n,r,o,a)=>{const s=r.length,i=a;for(let a=0;a<s;a++){const s=t*o[a];if(r[a]>s){const t=1+i,u=s*t;if(r[a]>u){const s=e*o[a]*t;if(n[a]<s)throw new Error(l.UpperHalt);if(r[a]-u>n[a]-s)throw new Error(l.UpperHalt)}}else{const t=1-i,u=s*t;if(r[a]<u){let s=e*o[a];if(s*=t,n[a]>s)throw new Error(l.LowerHalt);if(u-r[a]>s-n[a])throw new Error(l.LowerHalt)}}}return!0},v=(e,t,n,o)=>{const a=n-o-(e-t);if(0<a||a>=r)return!0;throw new Error(l.SwapInvariantViolation)};function g(e,t){const n=k(e,t,!0),r=n.givenAmountInNumeraire;if(t.tokenIn===t.tokenOut)return p(r,t.tokenInLatestFXPrice.toNumber());const o=n._oGLiq,a=n._nGLiq,s=n._oBals,i=n._nBals,u=d(o,a,s,i,r,m(t.tokenIn)?1:0,n);if(void 0===u)throw new Error(l.CannotSwap);{const e=n.epsilon,r=u[0]*(1-e);return p(Math.abs(r),t.tokenOutLatestFXPrice.toNumber())}}function O(e,t){const r=k(e,t,!1),o=-r.givenAmountInNumeraire;t.tokenIn===t.tokenOut&&p(o,t.tokenOutLatestFXPrice.toNumber());const a=r._oGLiq,s=r._nGLiq,i=r._oBals,u=r._nBals,c=d(a,s,i,u,o,m(t.tokenIn)?0:1,r);if(void 0===c)throw new Error(l.CannotSwap);{const e=Number(n(t.epsilon,18)),r=c[0]*(1+e);return p(Math.abs(r),t.tokenInLatestFXPrice.toNumber())}}const F=(t,n)=>{const r=k(t,n,!0),o=r._oGLiq,a=r._nGLiq,s=r._oBals,i=r._nBals,u=d(o,a,s,i,1,0,r);return e(Math.abs(u[0])*(1-r.epsilon)/Math.abs(1)*r.baseTokenRate)},B=(t,n)=>{const r=k(n,t,!0),o=r.givenAmountInNumeraire,a=r._oGLiq,s=r._nBals,i=r.baseTokenRate,u=r.beta,c=r.epsilon,b=r._nGLiq,l=r._oBals,I=d(a,b,l,s,o,m(t.tokenIn)?1:0,r)[0],N=.5*(1+u)*a,h=.5*(1-u)*a;if(m(t.tokenIn)){const r=s[0];return s[1]<h&&r>N?n.isZero()?F(n,t):e(Math.abs(I*(1-c))/Math.abs(o)*i):e(i*(1-c))}{const r=s[1];if(s[0]<h&&r>N){if(n.isZero())return F(n,t);const r=Math.abs(I*(1-c))/Math.abs(o);return e(r*i)}return e(i*(1-c))}},M=(t,n)=>{const r=k(n,t,!1),o=-r.givenAmountInNumeraire,a=r._oGLiq,s=r._nBals,i=r.baseTokenRate,u=r.beta,c=r.epsilon,b=r._nGLiq,l=r._oBals,I=d(a,b,l,s,o,m(t.tokenIn)?0:1,r)[0],N=.5*(1+u)*a,h=.5*(1-u)*a;if(m(t.tokenIn)){const t=s[0],n=s[1];return e(n<h&&t>N?Math.abs(o)/Math.abs(I*(1+c))*i:i*(1-c))}{const t=s[0],n=s[1];return e(t<h&&n>N?Math.abs(o)/Math.abs(I*(1+c))*i:i*(1-c))}},P=(t,n)=>{const r=F(e("1"),n),o=B(n,t).minus(r).div(r);return o.isZero()?e(1e-19):o.abs()},X=(t,n)=>{const r=F(e("1"),n);return M(n,t).minus(r).div(r).abs()};export{c as ALMOST_ZERO,r as CURVEMATH_MAX_DIFF,l as CurveMathRevert,u as ONE_ETHER,a as ONE_TO_THE_EIGHT_NUM,o as ONE_TO_THE_SECOND_NUM,s as ONE_TO_THE_SIX_NUM,i as ONE_TO_THE_THIRTEEN_NUM,P as _derivativeSpotPriceAfterSwapExactTokenInForTokenOut,X as _derivativeSpotPriceAfterSwapTokenInForExactTokenOut,g as _exactTokenInForTokenOut,B as _spotPriceAfterSwapExactTokenInForTokenOut,M as _spotPriceAfterSwapTokenInForExactTokenOut,O as _tokenInForExactTokenOut,I as convertToNumber,h as getBaseDecimals,N as poolBalancesToNumeraire,F as spotPriceBeforeSwap,p as viewRawAmount};
//# sourceMappingURL=fxPoolMath.js.map
