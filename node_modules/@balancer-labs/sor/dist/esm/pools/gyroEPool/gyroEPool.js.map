{"version":3,"file":"gyroEPool.js","sources":["../../../../../../src/pools/gyroEPool/gyroEPool.ts"],"sourcesContent":["import { getAddress } from '@ethersproject/address';\nimport { WeiPerEther as ONE, Zero } from '@ethersproject/constants';\nimport { formatFixed, BigNumber } from '@ethersproject/bignumber';\nimport { BigNumber as OldBigNumber, bnum, ZERO } from '../../utils/bignumber';\n\nimport {\n    PoolBase,\n    PoolPairBase,\n    PoolTypes,\n    SubgraphToken,\n    SwapTypes,\n    SubgraphPoolBase,\n} from '../../types';\nimport {\n    GyroEParams,\n    DerivedGyroEParams,\n    Vector2,\n    normalizeBalances,\n    balancesFromTokenInOut,\n    reduceFee,\n    addFee,\n    virtualOffset0,\n    virtualOffset1,\n} from './gyroEMath/gyroEMathHelpers';\nimport { isSameAddress, safeParseFixed } from '../../utils';\nimport { mulDown, divDown } from '../gyroHelpers/gyroSignedFixedPoint';\nimport {\n    calculateInvariantWithError,\n    calcOutGivenIn,\n    calcInGivenOut,\n    calcSpotPriceAfterSwapOutGivenIn,\n    calcSpotPriceAfterSwapInGivenOut,\n    calcDerivativePriceAfterSwapOutGivenIn,\n    calcDerivativeSpotPriceAfterSwapInGivenOut,\n} from './gyroEMath/gyroEMath';\nimport { SWAP_LIMIT_FACTOR } from '../gyroHelpers/constants';\nimport { universalNormalizedLiquidity } from '../liquidity';\n\nexport type GyroEPoolPairData = PoolPairBase & {\n    tokenInIsToken0: boolean;\n};\n\nexport type GyroEPoolToken = Pick<\n    SubgraphToken,\n    'address' | 'balance' | 'decimals'\n>;\n\ntype GyroEParamsFromSubgraph = {\n    alpha: string;\n    beta: string;\n    c: string;\n    s: string;\n    lambda: string;\n};\ntype DerivedGyroEParamsFromSubgraph = {\n    tauAlphaX: string;\n    tauAlphaY: string;\n    tauBetaX: string;\n    tauBetaY: string;\n    u: string;\n    v: string;\n    w: string;\n    z: string;\n    dSq: string;\n};\n\nexport class GyroEPool implements PoolBase<GyroEPoolPairData> {\n    poolType: PoolTypes = PoolTypes.GyroE;\n    id: string;\n    address: string;\n    tokensList: string[];\n    tokens: GyroEPoolToken[];\n    swapFee: BigNumber;\n    totalShares: BigNumber;\n    gyroEParams: GyroEParams;\n    derivedGyroEParams: DerivedGyroEParams;\n\n    static fromPool(pool: SubgraphPoolBase): GyroEPool {\n        const {\n            alpha,\n            beta,\n            c,\n            s,\n            lambda,\n            tauAlphaX,\n            tauAlphaY,\n            tauBetaX,\n            tauBetaY,\n            u,\n            v,\n            w,\n            z,\n            dSq,\n        } = pool;\n\n        const gyroEParams = {\n            alpha,\n            beta,\n            c,\n            s,\n            lambda,\n        };\n\n        const derivedGyroEParams = {\n            tauAlphaX,\n            tauAlphaY,\n            tauBetaX,\n            tauBetaY,\n            u,\n            v,\n            w,\n            z,\n            dSq,\n        };\n\n        if (\n            !Object.values(gyroEParams).every((el) => el) ||\n            !Object.values(derivedGyroEParams).every((el) => el)\n        )\n            throw new Error(\n                'Pool missing GyroE params and/or GyroE derived params'\n            );\n\n        return new GyroEPool(\n            pool.id,\n            pool.address,\n            pool.swapFee,\n            pool.totalShares,\n            pool.tokens as GyroEPoolToken[],\n            pool.tokensList,\n            gyroEParams as GyroEParamsFromSubgraph,\n            derivedGyroEParams as DerivedGyroEParamsFromSubgraph\n        );\n    }\n\n    constructor(\n        id: string,\n        address: string,\n        swapFee: string,\n        totalShares: string,\n        tokens: GyroEPoolToken[],\n        tokensList: string[],\n        gyroEParams: GyroEParamsFromSubgraph,\n        derivedGyroEParams: DerivedGyroEParamsFromSubgraph\n    ) {\n        this.id = id;\n        this.address = address;\n        this.swapFee = safeParseFixed(swapFee, 18);\n        this.totalShares = safeParseFixed(totalShares, 18);\n        this.tokens = tokens;\n        this.tokensList = tokensList;\n\n        this.gyroEParams = {\n            alpha: safeParseFixed(gyroEParams.alpha, 18),\n            beta: safeParseFixed(gyroEParams.beta, 18),\n            c: safeParseFixed(gyroEParams.c, 18),\n            s: safeParseFixed(gyroEParams.s, 18),\n            lambda: safeParseFixed(gyroEParams.lambda, 18),\n        };\n\n        this.derivedGyroEParams = {\n            tauAlpha: {\n                x: safeParseFixed(derivedGyroEParams.tauAlphaX, 38),\n                y: safeParseFixed(derivedGyroEParams.tauAlphaY, 38),\n            },\n            tauBeta: {\n                x: safeParseFixed(derivedGyroEParams.tauBetaX, 38),\n                y: safeParseFixed(derivedGyroEParams.tauBetaY, 38),\n            },\n            u: safeParseFixed(derivedGyroEParams.u, 38),\n            v: safeParseFixed(derivedGyroEParams.v, 38),\n            w: safeParseFixed(derivedGyroEParams.w, 38),\n            z: safeParseFixed(derivedGyroEParams.z, 38),\n            dSq: safeParseFixed(derivedGyroEParams.dSq, 38),\n        };\n    }\n\n    parsePoolPairData(tokenIn: string, tokenOut: string): GyroEPoolPairData {\n        const tokenInIndex = this.tokens.findIndex(\n            (t) => getAddress(t.address) === getAddress(tokenIn)\n        );\n        if (tokenInIndex < 0) throw 'Pool does not contain tokenIn';\n        const tI = this.tokens[tokenInIndex];\n        const balanceIn = tI.balance;\n        const decimalsIn = tI.decimals;\n\n        const tokenOutIndex = this.tokens.findIndex(\n            (t) => getAddress(t.address) === getAddress(tokenOut)\n        );\n        if (tokenOutIndex < 0) throw 'Pool does not contain tokenOut';\n        const tO = this.tokens[tokenOutIndex];\n        const balanceOut = tO.balance;\n        const decimalsOut = tO.decimals;\n\n        const tokenInIsToken0 = tokenInIndex === 0;\n\n        const poolPairData: GyroEPoolPairData = {\n            id: this.id,\n            address: this.address,\n            poolType: this.poolType,\n            tokenIn: tokenIn,\n            tokenOut: tokenOut,\n            decimalsIn: Number(decimalsIn),\n            decimalsOut: Number(decimalsOut),\n            balanceIn: safeParseFixed(balanceIn, decimalsIn),\n            balanceOut: safeParseFixed(balanceOut, decimalsOut),\n            swapFee: this.swapFee,\n            tokenInIsToken0,\n        };\n\n        return poolPairData;\n    }\n\n    getNormalizedLiquidity(poolPairData: GyroEPoolPairData): OldBigNumber {\n        return universalNormalizedLiquidity(\n            this._derivativeSpotPriceAfterSwapExactTokenInForTokenOut(\n                poolPairData,\n                ZERO\n            )\n        );\n    }\n\n    getLimitAmountSwap(\n        poolPairData: GyroEPoolPairData,\n        swapType: SwapTypes\n    ): OldBigNumber {\n        if (swapType === SwapTypes.SwapExactIn) {\n            const normalizedBalances = normalizeBalances(\n                [poolPairData.balanceIn, poolPairData.balanceOut],\n                [poolPairData.decimalsIn, poolPairData.decimalsOut]\n            );\n            const orderedNormalizedBalances = balancesFromTokenInOut(\n                normalizedBalances[0],\n                normalizedBalances[1],\n                poolPairData.tokenInIsToken0\n            );\n            const [currentInvariant, invErr] = calculateInvariantWithError(\n                orderedNormalizedBalances,\n                this.gyroEParams,\n                this.derivedGyroEParams\n            );\n            const invariant: Vector2 = {\n                x: currentInvariant.add(invErr.mul(2)),\n                y: currentInvariant,\n            };\n            const virtualOffsetFunc = poolPairData.tokenInIsToken0\n                ? virtualOffset0\n                : virtualOffset1;\n            const maxAmountInAssetInPool = virtualOffsetFunc(\n                this.gyroEParams,\n                this.derivedGyroEParams,\n                invariant\n            ).sub(\n                virtualOffsetFunc(\n                    this.gyroEParams,\n                    this.derivedGyroEParams,\n                    invariant,\n                    true\n                )\n            );\n            const limitAmountIn = maxAmountInAssetInPool.sub(\n                normalizedBalances[0]\n            );\n            const limitAmountInPlusSwapFee = divDown(\n                limitAmountIn,\n                ONE.sub(poolPairData.swapFee)\n            );\n            return bnum(\n                formatFixed(\n                    mulDown(limitAmountInPlusSwapFee, SWAP_LIMIT_FACTOR),\n                    18\n                )\n            );\n        } else {\n            return bnum(\n                formatFixed(\n                    mulDown(poolPairData.balanceOut, SWAP_LIMIT_FACTOR),\n                    poolPairData.decimalsOut\n                )\n            );\n        }\n    }\n\n    // Updates the balance of a given token for the pool\n    updateTokenBalanceForPool(token: string, newBalance: BigNumber): void {\n        // token is BPT\n        if (isSameAddress(this.address, token)) {\n            this.updateTotalShares(newBalance);\n        } else {\n            // token is underlying in the pool\n            const T = this.tokens.find((t) => isSameAddress(t.address, token));\n            if (!T) throw Error('Pool does not contain this token');\n            T.balance = formatFixed(newBalance, T.decimals);\n        }\n    }\n\n    updateTotalShares(newTotalShares: BigNumber): void {\n        this.totalShares = newTotalShares;\n    }\n\n    _exactTokenInForTokenOut(\n        poolPairData: GyroEPoolPairData,\n        amount: OldBigNumber\n    ): OldBigNumber {\n        const normalizedBalances = normalizeBalances(\n            [poolPairData.balanceIn, poolPairData.balanceOut],\n            [poolPairData.decimalsIn, poolPairData.decimalsOut]\n        );\n        const orderedNormalizedBalances = balancesFromTokenInOut(\n            normalizedBalances[0],\n            normalizedBalances[1],\n            poolPairData.tokenInIsToken0\n        );\n        const [currentInvariant, invErr] = calculateInvariantWithError(\n            orderedNormalizedBalances,\n            this.gyroEParams,\n            this.derivedGyroEParams\n        );\n\n        const invariant: Vector2 = {\n            x: currentInvariant.add(invErr.mul(2)),\n            y: currentInvariant,\n        };\n        const inAmount = safeParseFixed(amount.toString(), 18);\n        const inAmountLessFee = reduceFee(inAmount, poolPairData.swapFee);\n        const outAmount = calcOutGivenIn(\n            orderedNormalizedBalances,\n            inAmountLessFee,\n            poolPairData.tokenInIsToken0,\n            this.gyroEParams,\n            this.derivedGyroEParams,\n            invariant\n        );\n        return bnum(formatFixed(outAmount, 18));\n    }\n\n    _tokenInForExactTokenOut(\n        poolPairData: GyroEPoolPairData,\n        amount: OldBigNumber\n    ): OldBigNumber {\n        const normalizedBalances = normalizeBalances(\n            [poolPairData.balanceIn, poolPairData.balanceOut],\n            [poolPairData.decimalsIn, poolPairData.decimalsOut]\n        );\n        const orderedNormalizedBalances = balancesFromTokenInOut(\n            normalizedBalances[0],\n            normalizedBalances[1],\n            poolPairData.tokenInIsToken0\n        );\n        const [currentInvariant, invErr] = calculateInvariantWithError(\n            orderedNormalizedBalances,\n            this.gyroEParams,\n            this.derivedGyroEParams\n        );\n        const invariant: Vector2 = {\n            x: currentInvariant.add(invErr.mul(2)),\n            y: currentInvariant,\n        };\n        const outAmount = safeParseFixed(amount.toString(), 18);\n\n        const inAmountLessFee = calcInGivenOut(\n            orderedNormalizedBalances,\n            outAmount,\n            poolPairData.tokenInIsToken0,\n            this.gyroEParams,\n            this.derivedGyroEParams,\n            invariant\n        );\n        const inAmount = addFee(inAmountLessFee, poolPairData.swapFee);\n        return bnum(formatFixed(inAmount, 18));\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _calcTokensOutGivenExactBptIn(bptAmountIn: BigNumber): BigNumber[] {\n        // Missing maths for this\n        return new Array(this.tokens.length).fill(Zero);\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _calcBptOutGivenExactTokensIn(amountsIn: BigNumber[]): BigNumber {\n        // Missing maths for this\n        return Zero;\n    }\n\n    _spotPriceAfterSwapExactTokenInForTokenOut(\n        poolPairData: GyroEPoolPairData,\n        amount: OldBigNumber\n    ): OldBigNumber {\n        const normalizedBalances = normalizeBalances(\n            [poolPairData.balanceIn, poolPairData.balanceOut],\n            [poolPairData.decimalsIn, poolPairData.decimalsOut]\n        );\n        const orderedNormalizedBalances = balancesFromTokenInOut(\n            normalizedBalances[0],\n            normalizedBalances[1],\n            poolPairData.tokenInIsToken0\n        );\n        const [currentInvariant, invErr] = calculateInvariantWithError(\n            orderedNormalizedBalances,\n            this.gyroEParams,\n            this.derivedGyroEParams\n        );\n        const invariant: Vector2 = {\n            x: currentInvariant.add(invErr.mul(2)),\n            y: currentInvariant,\n        };\n        const inAmount = safeParseFixed(amount.toString(), 18);\n        const inAmountLessFee = reduceFee(inAmount, poolPairData.swapFee);\n        const newSpotPrice = calcSpotPriceAfterSwapOutGivenIn(\n            orderedNormalizedBalances,\n            inAmountLessFee,\n            poolPairData.tokenInIsToken0,\n            this.gyroEParams,\n            this.derivedGyroEParams,\n            invariant,\n            poolPairData.swapFee\n        );\n        return bnum(formatFixed(newSpotPrice, 18));\n    }\n\n    _spotPriceAfterSwapTokenInForExactTokenOut(\n        poolPairData: GyroEPoolPairData,\n        amount: OldBigNumber\n    ): OldBigNumber {\n        const normalizedBalances = normalizeBalances(\n            [poolPairData.balanceIn, poolPairData.balanceOut],\n            [poolPairData.decimalsIn, poolPairData.decimalsOut]\n        );\n        const orderedNormalizedBalances = balancesFromTokenInOut(\n            normalizedBalances[0],\n            normalizedBalances[1],\n            poolPairData.tokenInIsToken0\n        );\n        const [currentInvariant, invErr] = calculateInvariantWithError(\n            orderedNormalizedBalances,\n            this.gyroEParams,\n            this.derivedGyroEParams\n        );\n        const invariant: Vector2 = {\n            x: currentInvariant.add(invErr.mul(2)),\n            y: currentInvariant,\n        };\n        const outAmount = safeParseFixed(amount.toString(), 18);\n        const newSpotPrice = calcSpotPriceAfterSwapInGivenOut(\n            orderedNormalizedBalances,\n            outAmount,\n            poolPairData.tokenInIsToken0,\n            this.gyroEParams,\n            this.derivedGyroEParams,\n            invariant,\n            poolPairData.swapFee\n        );\n        return bnum(formatFixed(newSpotPrice, 18));\n    }\n\n    _derivativeSpotPriceAfterSwapExactTokenInForTokenOut(\n        poolPairData: GyroEPoolPairData,\n        amount: OldBigNumber\n    ): OldBigNumber {\n        const inAmount = safeParseFixed(amount.toString(), 18);\n        const normalizedBalances = normalizeBalances(\n            [poolPairData.balanceIn, poolPairData.balanceOut],\n            [poolPairData.decimalsIn, poolPairData.decimalsOut]\n        );\n        const orderedNormalizedBalances = balancesFromTokenInOut(\n            normalizedBalances[0],\n            normalizedBalances[1],\n            poolPairData.tokenInIsToken0\n        );\n        const [currentInvariant, invErr] = calculateInvariantWithError(\n            orderedNormalizedBalances,\n            this.gyroEParams,\n            this.derivedGyroEParams\n        );\n        const invariant: Vector2 = {\n            x: currentInvariant.add(invErr.mul(2)),\n            y: currentInvariant,\n        };\n\n        const derivative = calcDerivativePriceAfterSwapOutGivenIn(\n            [\n                orderedNormalizedBalances[0].add(\n                    reduceFee(inAmount, poolPairData.swapFee)\n                ),\n                orderedNormalizedBalances[1],\n            ],\n            poolPairData.tokenInIsToken0,\n            this.gyroEParams,\n            this.derivedGyroEParams,\n            invariant,\n            poolPairData.swapFee\n        );\n        return bnum(formatFixed(derivative, 18));\n    }\n\n    _derivativeSpotPriceAfterSwapTokenInForExactTokenOut(\n        poolPairData: GyroEPoolPairData,\n        amount: OldBigNumber\n    ): OldBigNumber {\n        const normalizedBalances = normalizeBalances(\n            [poolPairData.balanceIn, poolPairData.balanceOut],\n            [poolPairData.decimalsIn, poolPairData.decimalsOut]\n        );\n        const orderedNormalizedBalances = balancesFromTokenInOut(\n            normalizedBalances[0],\n            normalizedBalances[1],\n            poolPairData.tokenInIsToken0\n        );\n        const [currentInvariant, invErr] = calculateInvariantWithError(\n            orderedNormalizedBalances,\n            this.gyroEParams,\n            this.derivedGyroEParams\n        );\n        const invariant: Vector2 = {\n            x: currentInvariant.add(invErr.mul(2)),\n            y: currentInvariant,\n        };\n        const outAmount = safeParseFixed(amount.toString(), 18);\n        const derivative = calcDerivativeSpotPriceAfterSwapInGivenOut(\n            [\n                orderedNormalizedBalances[0],\n                orderedNormalizedBalances[1].sub(outAmount),\n            ],\n            poolPairData.tokenInIsToken0,\n            this.gyroEParams,\n            this.derivedGyroEParams,\n            invariant,\n            poolPairData.swapFee\n        );\n        return bnum(formatFixed(derivative, 18));\n    }\n}\n"],"names":["GyroEPool","static","pool","alpha","beta","c","s","lambda","tauAlphaX","tauAlphaY","tauBetaX","tauBetaY","u","v","w","z","dSq","gyroEParams","derivedGyroEParams","Object","values","every","el","Error","id","address","swapFee","totalShares","tokens","tokensList","constructor","this","poolType","PoolTypes","GyroE","safeParseFixed","tauAlpha","x","y","tauBeta","parsePoolPairData","tokenIn","tokenOut","tokenInIndex","findIndex","t","getAddress","tI","balanceIn","balance","decimalsIn","decimals","tokenOutIndex","tO","balanceOut","decimalsOut","tokenInIsToken0","Number","getNormalizedLiquidity","poolPairData","universalNormalizedLiquidity","_derivativeSpotPriceAfterSwapExactTokenInForTokenOut","ZERO","getLimitAmountSwap","swapType","SwapTypes","SwapExactIn","normalizedBalances","normalizeBalances","orderedNormalizedBalances","balancesFromTokenInOut","currentInvariant","invErr","calculateInvariantWithError","invariant","add","mul","virtualOffsetFunc","virtualOffset0","virtualOffset1","limitAmountIn","sub","limitAmountInPlusSwapFee","divDown","ONE","bnum","formatFixed","mulDown","SWAP_LIMIT_FACTOR","updateTokenBalanceForPool","token","newBalance","isSameAddress","updateTotalShares","T","find","newTotalShares","_exactTokenInForTokenOut","amount","inAmount","toString","inAmountLessFee","reduceFee","outAmount","calcOutGivenIn","_tokenInForExactTokenOut","calcInGivenOut","addFee","_calcTokensOutGivenExactBptIn","bptAmountIn","Array","length","fill","Zero","_calcBptOutGivenExactTokensIn","amountsIn","_spotPriceAfterSwapExactTokenInForTokenOut","newSpotPrice","calcSpotPriceAfterSwapOutGivenIn","_spotPriceAfterSwapTokenInForExactTokenOut","calcSpotPriceAfterSwapInGivenOut","derivative","calcDerivativePriceAfterSwapOutGivenIn","_derivativeSpotPriceAfterSwapTokenInForExactTokenOut","calcDerivativeSpotPriceAfterSwapInGivenOut"],"mappings":"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"}