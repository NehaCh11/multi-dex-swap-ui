{"version":3,"file":"gyroEMathHelpers.js","sources":["../../../../../../../src/pools/gyroEPool/gyroEMath/gyroEMathHelpers.ts"],"sourcesContent":["import { BigNumber, parseFixed } from '@ethersproject/bignumber';\nimport { WeiPerEther as ONE } from '@ethersproject/constants';\nimport { ONE_XP } from '../../gyroHelpers/constants';\nimport {\n    mulDown,\n    divDown,\n    mulDownMagU,\n    divDownMagU,\n    mulUpMagU,\n    divUpMagU,\n    mulUpXpToNpU,\n    mulDownXpToNpU,\n    mulXpU,\n    divXpU,\n    sqrt,\n} from '../../gyroHelpers/gyroSignedFixedPoint';\nimport { MAX_BALANCES } from './constants';\n\n/////////\n/// TYPES\n/////////\n\nexport type GyroEParams = {\n    alpha: BigNumber;\n    beta: BigNumber;\n    c: BigNumber;\n    s: BigNumber;\n    lambda: BigNumber;\n};\n\n// terms in this struct are stored in extra precision (38 decimals) with final decimal rounded down\nexport type DerivedGyroEParams = {\n    tauAlpha: Vector2;\n    tauBeta: Vector2;\n    u: BigNumber;\n    v: BigNumber;\n    w: BigNumber;\n    z: BigNumber;\n    dSq: BigNumber;\n};\n\nexport type Vector2 = {\n    x: BigNumber;\n    y: BigNumber;\n};\n\nexport type QParams = {\n    a: BigNumber;\n    b: BigNumber;\n    c: BigNumber;\n};\n\n/////////\n/// FEE CALCULATION\n/////////\n\nexport function reduceFee(amountIn: BigNumber, swapFee: BigNumber): BigNumber {\n    const feeAmount = mulDown(amountIn, swapFee);\n    return amountIn.sub(feeAmount);\n}\n\nexport function addFee(amountIn: BigNumber, swapFee: BigNumber): BigNumber {\n    return divDown(amountIn, ONE.sub(swapFee));\n}\n\n////////\n/// BALANCE CALCULATION\n////////\nexport function normalizeBalances(\n    balances: BigNumber[],\n    decimals: number[]\n): BigNumber[] {\n    const scalingFactors = decimals.map((d) => parseFixed('1', d));\n\n    return balances.map((bal, index) =>\n        bal.mul(ONE).div(scalingFactors[index])\n    );\n}\n\nexport function balancesFromTokenInOut(\n    balanceTokenIn: BigNumber,\n    balanceTokenOut: BigNumber,\n    tokenInIsToken0: boolean\n): [BigNumber, BigNumber] {\n    return tokenInIsToken0\n        ? [balanceTokenIn, balanceTokenOut]\n        : [balanceTokenOut, balanceTokenIn];\n}\n\n/////////\n/// INVARIANT CALC\n/////////\n\nexport function calcAtAChi(\n    x: BigNumber,\n    y: BigNumber,\n    p: GyroEParams,\n    d: DerivedGyroEParams\n): BigNumber {\n    const dSq2 = mulXpU(d.dSq, d.dSq);\n\n    // (cx - sy) * (w/lambda + z) / lambda\n    //      account for 2 factors of dSq (4 s,c factors)\n    const termXp = divXpU(\n        divDownMagU(divDownMagU(d.w, p.lambda).add(d.z), p.lambda),\n        dSq2\n    );\n\n    let val = mulDownXpToNpU(\n        mulDownMagU(x, p.c).sub(mulDownMagU(y, p.s)),\n        termXp\n    );\n\n    // (x lambda s + y lambda c) * u, note u > 0\n    let termNp = mulDownMagU(mulDownMagU(x, p.lambda), p.s).add(\n        mulDownMagU(mulDownMagU(y, p.lambda), p.c)\n    );\n    val = val.add(mulDownXpToNpU(termNp, divXpU(d.u, dSq2)));\n\n    // (sx+cy) * v, note v > 0\n    termNp = mulDownMagU(x, p.s).add(mulDownMagU(y, p.c));\n    val = val.add(mulDownXpToNpU(termNp, divXpU(d.v, dSq2)));\n\n    return val;\n}\n\nexport function calcInvariantSqrt(\n    x: BigNumber,\n    y: BigNumber,\n    p: GyroEParams,\n    d: DerivedGyroEParams\n): [BigNumber, BigNumber] {\n    let val = calcMinAtxAChiySqPlusAtxSq(x, y, p, d).add(\n        calc2AtxAtyAChixAChiy(x, y, p, d)\n    );\n    val = val.add(calcMinAtyAChixSqPlusAtySq(x, y, p, d));\n    const err = mulUpMagU(x, x).add(mulUpMagU(y, y)).div(ONE_XP);\n    val = val.gt(0) ? sqrt(val, BigNumber.from(5)) : BigNumber.from(0);\n    return [val, err];\n}\n\nfunction calcMinAtxAChiySqPlusAtxSq(\n    x: BigNumber,\n    y: BigNumber,\n    p: GyroEParams,\n    d: DerivedGyroEParams\n) {\n    let termNp = mulUpMagU(mulUpMagU(mulUpMagU(x, x), p.c), p.c).add(\n        mulUpMagU(mulUpMagU(mulUpMagU(y, y), p.s), p.s)\n    );\n    termNp = termNp.sub(\n        mulDownMagU(mulDownMagU(mulDownMagU(x, y), p.c.mul(2)), p.s)\n    );\n    const termXp = mulXpU(d.u, d.u)\n        .add(divDownMagU(mulXpU(d.u.mul(2), d.v), p.lambda))\n        .add(divDownMagU(divDownMagU(mulXpU(d.v, d.v), p.lambda), p.lambda));\n\n    let val = mulDownXpToNpU(termNp.mul(-1), termXp);\n    val = val.add(\n        mulDownXpToNpU(\n            divDownMagU(divDownMagU(termNp.sub(9), p.lambda), p.lambda),\n            divXpU(ONE_XP, d.dSq)\n        )\n    );\n    return val;\n}\n\nfunction calc2AtxAtyAChixAChiy(\n    x: BigNumber,\n    y: BigNumber,\n    p: GyroEParams,\n    d: DerivedGyroEParams\n) {\n    let termNp = mulDownMagU(\n        mulDownMagU(mulDownMagU(x, x).sub(mulUpMagU(y, y)), p.c.mul(2)),\n        p.s\n    );\n\n    const xy = mulDownMagU(y, x.mul(2));\n    termNp = termNp\n        .add(mulDownMagU(mulDownMagU(xy, p.c), p.c))\n        .sub(mulDownMagU(mulDownMagU(xy, p.s), p.s));\n    let termXp = mulXpU(d.z, d.u).add(\n        divDownMagU(divDownMagU(mulXpU(d.w, d.v), p.lambda), p.lambda)\n    );\n    termXp = termXp.add(\n        divDownMagU(mulXpU(d.w, d.u).add(mulXpU(d.z, d.v)), p.lambda)\n    );\n    termXp = divXpU(termXp, mulXpU(mulXpU(mulXpU(d.dSq, d.dSq), d.dSq), d.dSq));\n    const val = mulDownXpToNpU(termNp, termXp);\n    return val;\n}\n\nfunction calcMinAtyAChixSqPlusAtySq(\n    x: BigNumber,\n    y: BigNumber,\n    p: GyroEParams,\n    d: DerivedGyroEParams\n) {\n    let termNp = mulUpMagU(mulUpMagU(mulUpMagU(x, x), p.s), p.s).add(\n        mulUpMagU(mulUpMagU(mulUpMagU(y, y), p.c), p.c)\n    );\n    termNp = termNp.add(mulUpMagU(mulUpMagU(mulUpMagU(x, y), p.s.mul(2)), p.c));\n    let termXp = mulXpU(d.z, d.z).add(\n        divDownMagU(divDownMagU(mulXpU(d.w, d.w), p.lambda), p.lambda)\n    );\n    termXp = termXp.add(divDownMagU(mulXpU(d.z.mul(2), d.w), p.lambda));\n    termXp = divXpU(termXp, mulXpU(mulXpU(mulXpU(d.dSq, d.dSq), d.dSq), d.dSq));\n    let val = mulDownXpToNpU(termNp.mul(-1), termXp);\n    val = val.add(mulDownXpToNpU(termNp.sub(9), divXpU(ONE_XP, d.dSq)));\n    return val;\n}\n\nexport function calcAChiAChiInXp(\n    p: GyroEParams,\n    d: DerivedGyroEParams\n): BigNumber {\n    const dSq3 = mulXpU(mulXpU(d.dSq, d.dSq), d.dSq);\n    let val = mulUpMagU(p.lambda, divXpU(mulXpU(d.u.mul(2), d.v), dSq3));\n    val = val.add(\n        mulUpMagU(\n            mulUpMagU(divXpU(mulXpU(d.u.add(1), d.u.add(1)), dSq3), p.lambda),\n            p.lambda\n        )\n    );\n    val = val.add(divXpU(mulXpU(d.v, d.v), dSq3));\n    const termXp = divUpMagU(d.w, p.lambda).add(d.z);\n    val = val.add(divXpU(mulXpU(termXp, termXp), dSq3));\n    return val;\n}\n\n/////////\n/// SWAP AMOUNT CALC\n/////////\n\nexport function checkAssetBounds(\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    invariant: Vector2,\n    newBal: BigNumber,\n    assetIndex: number\n): void {\n    if (assetIndex === 0) {\n        const xPlus = maxBalances0(params, derived, invariant);\n        if (newBal.gt(MAX_BALANCES) || newBal.gt(xPlus))\n            throw new Error('ASSET BOUNDS EXCEEDED');\n    } else {\n        const yPlus = maxBalances1(params, derived, invariant);\n        if (newBal.gt(MAX_BALANCES) || newBal.gt(yPlus))\n            throw new Error('ASSET BOUNDS EXCEEDED');\n    }\n}\n\nfunction maxBalances0(p: GyroEParams, d: DerivedGyroEParams, r: Vector2) {\n    const termXp1 = divXpU(d.tauBeta.x.sub(d.tauAlpha.x), d.dSq);\n    const termXp2 = divXpU(d.tauBeta.y.sub(d.tauAlpha.y), d.dSq);\n    let xp = mulDownXpToNpU(\n        mulDownMagU(mulDownMagU(r.y, p.lambda), p.c),\n        termXp1\n    );\n    xp = xp.add(\n        termXp2.gt(BigNumber.from(0))\n            ? mulDownMagU(r.y, p.s)\n            : mulDownXpToNpU(mulUpMagU(r.x, p.s), termXp2)\n    );\n    return xp;\n}\n\nfunction maxBalances1(p: GyroEParams, d: DerivedGyroEParams, r: Vector2) {\n    const termXp1 = divXpU(d.tauBeta.x.sub(d.tauAlpha.x), d.dSq);\n    const termXp2 = divXpU(d.tauBeta.y.sub(d.tauAlpha.y), d.dSq);\n    let yp = mulDownXpToNpU(\n        mulDownMagU(mulDownMagU(r.y, p.lambda), p.s),\n        termXp1\n    );\n    yp = yp.add(\n        termXp2.gt(BigNumber.from(0))\n            ? mulDownMagU(r.y, p.c)\n            : mulDownXpToNpU(mulUpMagU(r.x, p.c), termXp2)\n    );\n    return yp;\n}\n\nexport function calcYGivenX(\n    x: BigNumber,\n    params: GyroEParams,\n    d: DerivedGyroEParams,\n    r: Vector2\n): BigNumber {\n    const ab: Vector2 = {\n        x: virtualOffset0(params, d, r),\n        y: virtualOffset1(params, d, r),\n    };\n\n    const y = solveQuadraticSwap(\n        params.lambda,\n        x,\n        params.s,\n        params.c,\n        r,\n        ab,\n        d.tauBeta,\n        d.dSq\n    );\n    return y;\n}\n\nexport function calcXGivenY(\n    y: BigNumber,\n    params: GyroEParams,\n    d: DerivedGyroEParams,\n    r: Vector2\n): BigNumber {\n    const ba: Vector2 = {\n        x: virtualOffset1(params, d, r),\n        y: virtualOffset0(params, d, r),\n    };\n    const x = solveQuadraticSwap(\n        params.lambda,\n        y,\n        params.c,\n        params.s,\n        r,\n        ba,\n        {\n            x: d.tauAlpha.x.mul(-1),\n            y: d.tauAlpha.y,\n        },\n        d.dSq\n    );\n    return x;\n}\n\nexport function virtualOffset0(\n    p: GyroEParams,\n    d: DerivedGyroEParams,\n    r: Vector2,\n    switchTau?: boolean\n): BigNumber {\n    const tauValue = switchTau ? d.tauAlpha : d.tauBeta;\n    const termXp = divXpU(tauValue.x, d.dSq);\n\n    let a = tauValue.x.gt(BigNumber.from(0))\n        ? mulUpXpToNpU(mulUpMagU(mulUpMagU(r.x, p.lambda), p.c), termXp)\n        : mulUpXpToNpU(mulDownMagU(mulDownMagU(r.y, p.lambda), p.c), termXp);\n\n    a = a.add(mulUpXpToNpU(mulUpMagU(r.x, p.s), divXpU(tauValue.y, d.dSq)));\n\n    return a;\n}\n\nexport function virtualOffset1(\n    p: GyroEParams,\n    d: DerivedGyroEParams,\n    r: Vector2,\n    switchTau?: boolean\n): BigNumber {\n    const tauValue = switchTau ? d.tauBeta : d.tauAlpha;\n    const termXp = divXpU(tauValue.x, d.dSq);\n\n    let b = tauValue.x.lt(BigNumber.from(0))\n        ? mulUpXpToNpU(mulUpMagU(mulUpMagU(r.x, p.lambda), p.s), termXp.mul(-1))\n        : mulUpXpToNpU(\n              mulDownMagU(mulDownMagU(r.y.mul(-1), p.lambda), p.s),\n              termXp\n          );\n\n    b = b.add(mulUpXpToNpU(mulUpMagU(r.x, p.c), divXpU(tauValue.y, d.dSq)));\n    return b;\n}\n\nfunction solveQuadraticSwap(\n    lambda: BigNumber,\n    x: BigNumber,\n    s: BigNumber,\n    c: BigNumber,\n    r: Vector2,\n    ab: Vector2,\n    tauBeta: Vector2,\n    dSq: BigNumber\n): BigNumber {\n    const lamBar: Vector2 = {\n        x: ONE_XP.sub(divDownMagU(divDownMagU(ONE_XP, lambda), lambda)),\n        y: ONE_XP.sub(divUpMagU(divUpMagU(ONE_XP, lambda), lambda)),\n    };\n    const q: QParams = {\n        a: BigNumber.from(0),\n        b: BigNumber.from(0),\n        c: BigNumber.from(0),\n    };\n    const xp = x.sub(ab.x);\n    if (xp.gt(BigNumber.from(0))) {\n        q.b = mulUpXpToNpU(\n            mulDownMagU(mulDownMagU(xp.mul(-1), s), c),\n            divXpU(lamBar.y, dSq)\n        );\n    } else {\n        q.b = mulUpXpToNpU(\n            mulUpMagU(mulUpMagU(xp.mul(-1), s), c),\n            divXpU(lamBar.x, dSq).add(1)\n        );\n    }\n    const sTerm: Vector2 = {\n        x: divXpU(mulDownMagU(mulDownMagU(lamBar.y, s), s), dSq),\n        y: divXpU(mulUpMagU(mulUpMagU(lamBar.x, s), s), dSq.add(1)).add(1),\n    };\n    sTerm.x = ONE_XP.sub(sTerm.x);\n    sTerm.y = ONE_XP.sub(sTerm.y);\n\n    q.c = calcXpXpDivLambdaLambda(x, r, lambda, s, c, tauBeta, dSq).mul(-1);\n    q.c = q.c.add(mulDownXpToNpU(mulDownMagU(r.y, r.y), sTerm.y)); // r.y ===  currentInv + err\n    q.c = q.c.gt(BigNumber.from(0))\n        ? sqrt(q.c, BigNumber.from(5))\n        : BigNumber.from(0);\n    if (q.b.sub(q.c).gt(BigNumber.from(0))) {\n        q.a = mulUpXpToNpU(q.b.sub(q.c), divXpU(ONE_XP, sTerm.y).add(1));\n    } else {\n        q.a = mulUpXpToNpU(q.b.sub(q.c), divXpU(ONE_XP, sTerm.x));\n    }\n    return q.a.add(ab.y);\n}\n\nexport function calcXpXpDivLambdaLambda(\n    x: BigNumber,\n    r: Vector2,\n    lambda: BigNumber,\n    s: BigNumber,\n    c: BigNumber,\n    tauBeta: Vector2,\n    dSq: BigNumber\n): BigNumber {\n    const sqVars = {\n        x: mulXpU(dSq, dSq),\n        y: mulUpMagU(r.x, r.x),\n    };\n    const q: QParams = {\n        a: BigNumber.from(0),\n        b: BigNumber.from(0),\n        c: BigNumber.from(0),\n    };\n    let termXp = divXpU(mulXpU(tauBeta.x, tauBeta.y), sqVars.x);\n    if (termXp.gt(BigNumber.from(0))) {\n        q.a = mulUpMagU(sqVars.y, s.mul(2));\n        q.a = mulUpXpToNpU(mulUpMagU(q.a, c), termXp.add(7));\n    } else {\n        q.a = mulDownMagU(mulDownMagU(r.y, r.y), s.mul(2)); // r.y ===  currentInv + err\n        q.a = mulUpXpToNpU(mulDownMagU(q.a, c), termXp);\n    }\n\n    if (tauBeta.x.lt(BigNumber.from(0))) {\n        q.b = mulUpXpToNpU(\n            mulUpMagU(mulUpMagU(r.x, x), c.mul(2)),\n            divXpU(tauBeta.x, dSq).mul(-1).add(3)\n        );\n    } else {\n        q.b = mulUpXpToNpU(\n            mulDownMagU(mulDownMagU(r.y.mul(-1), x), c.mul(2)),\n            divXpU(tauBeta.x, dSq)\n        );\n    }\n    q.a = q.a.add(q.b);\n    termXp = divXpU(mulXpU(tauBeta.y, tauBeta.y), sqVars.x).add(7);\n    q.b = mulUpMagU(sqVars.y, s);\n    q.b = mulUpXpToNpU(mulUpMagU(q.b, s), termXp);\n\n    q.c = mulUpXpToNpU(\n        mulDownMagU(mulDownMagU(r.y.mul(-1), x), s.mul(2)),\n        divXpU(tauBeta.y, dSq)\n    );\n    q.b = q.b.add(q.c).add(mulUpMagU(x, x));\n    q.b = q.b.gt(BigNumber.from(0))\n        ? divUpMagU(q.b, lambda)\n        : divDownMagU(q.b, lambda);\n\n    q.a = q.a.add(q.b);\n    q.a = q.a.gt(BigNumber.from(0))\n        ? divUpMagU(q.a, lambda)\n        : divDownMagU(q.a, lambda);\n\n    termXp = divXpU(mulXpU(tauBeta.x, tauBeta.x), sqVars.x).add(7);\n    const val = mulUpMagU(mulUpMagU(sqVars.y, c), c);\n    return mulUpXpToNpU(val, termXp).add(q.a);\n}\n\n/////////\n/// LINEAR ALGEBRA OPERATIONS\n/////////\n\nexport function mulA(params: GyroEParams, tp: Vector2): Vector2 {\n    return {\n        x: divDownMagU(mulDownMagU(params.c, tp.x), params.lambda).sub(\n            divDownMagU(mulDownMagU(params.s, tp.y), params.lambda)\n        ),\n        y: mulDownMagU(params.s, tp.x).add(mulDownMagU(params.c, tp.y)),\n    };\n}\n\nexport function scalarProd(t1: Vector2, t2: Vector2): BigNumber {\n    const ret = mulDownMagU(t1.x, t2.x).add(mulDownMagU(t1.y, t2.y));\n    return ret;\n}\n"],"names":["reduceFee","amountIn","swapFee","feeAmount","mulDown","sub","addFee","divDown","ONE","normalizeBalances","balances","decimals","scalingFactors","map","d","parseFixed","bal","index","mul","div","balancesFromTokenInOut","balanceTokenIn","balanceTokenOut","tokenInIsToken0","calcAtAChi","x","y","p","dSq2","mulXpU","dSq","termXp","divXpU","divDownMagU","w","lambda","add","z","val","mulDownXpToNpU","mulDownMagU","c","s","termNp","u","v","calcInvariantSqrt","mulUpMagU","ONE_XP","calcMinAtxAChiySqPlusAtxSq","xy","calc2AtxAtyAChixAChiy","calcMinAtyAChixSqPlusAtySq","err","gt","sqrt","BigNumber","from","calcAChiAChiInXp","dSq3","divUpMagU","checkAssetBounds","params","derived","invariant","newBal","assetIndex","xPlus","r","termXp1","tauBeta","tauAlpha","termXp2","xp","maxBalances0","MAX_BALANCES","Error","yPlus","yp","maxBalances1","calcYGivenX","ab","virtualOffset0","virtualOffset1","solveQuadraticSwap","calcXGivenY","ba","switchTau","tauValue","a","mulUpXpToNpU","b","lt","lamBar","q","sTerm","calcXpXpDivLambdaLambda","sqVars"],"mappings":"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"}