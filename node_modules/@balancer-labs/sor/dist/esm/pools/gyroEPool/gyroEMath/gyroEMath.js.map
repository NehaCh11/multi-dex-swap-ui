{"version":3,"file":"gyroEMath.js","sources":["../../../../../../../src/pools/gyroEPool/gyroEMath/gyroEMath.ts"],"sourcesContent":["import { BigNumber } from '@ethersproject/bignumber';\nimport { WeiPerEther as ONE } from '@ethersproject/constants';\nimport { MAX_BALANCES, MAX_INVARIANT } from './constants';\nimport { ONE_XP, SMALL } from '../../gyroHelpers/constants';\nimport {\n    GyroEParams,\n    DerivedGyroEParams,\n    Vector2,\n    calcAtAChi,\n    calcInvariantSqrt,\n    calcAChiAChiInXp,\n    calcXGivenY,\n    calcYGivenX,\n    checkAssetBounds,\n} from './gyroEMathHelpers';\nimport {\n    mulDown,\n    divDown,\n    mulUpMagU,\n    divUpMagU,\n    mulUpXpToNpU,\n    mulDownXpToNpU,\n    divXpU,\n    sqrt,\n} from '../../gyroHelpers/gyroSignedFixedPoint';\nimport {\n    normalizedLiquidityXIn,\n    normalizedLiquidityYIn,\n    calcSpotPriceXGivenY,\n    calcSpotPriceYGivenX,\n    dPxDXOut,\n    dPxDYIn,\n    dPyDXIn,\n    dPyDYOut,\n} from './gyroEMathFunctions';\n\nexport function calculateNormalizedLiquidity(\n    balances: BigNumber[],\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    r: Vector2,\n    fee: BigNumber,\n    tokenInIsToken0: boolean\n): BigNumber {\n    if (tokenInIsToken0) {\n        return normalizedLiquidityXIn(balances, params, derived, fee, r);\n    } else {\n        return normalizedLiquidityYIn(balances, params, derived, fee, r);\n    }\n}\n\nexport function calculateInvariantWithError(\n    balances: BigNumber[],\n    params: GyroEParams,\n    derived: DerivedGyroEParams\n): [BigNumber, BigNumber] {\n    const [x, y] = balances;\n\n    if (x.add(y).gt(MAX_BALANCES)) throw new Error('MAX ASSETS EXCEEDED');\n    const AtAChi = calcAtAChi(x, y, params, derived);\n\n    const invariantResult = calcInvariantSqrt(x, y, params, derived);\n    const square_root = invariantResult[0];\n    let err = invariantResult[1];\n\n    if (square_root.gt(0)) {\n        err = divUpMagU(err.add(1), square_root.mul(2));\n    } else {\n        err = err.gt(0)\n            ? sqrt(err, BigNumber.from(5))\n            : BigNumber.from(10).pow(9);\n    }\n\n    err = mulUpMagU(params.lambda, x.add(y))\n        .div(ONE_XP)\n        .add(err)\n        .add(1)\n        .mul(20);\n\n    const mulDenominator = divXpU(\n        ONE_XP,\n        calcAChiAChiInXp(params, derived).sub(ONE_XP)\n    );\n    const invariant = mulDownXpToNpU(\n        AtAChi.add(square_root).sub(err),\n        mulDenominator\n    );\n    err = mulUpXpToNpU(err, mulDenominator);\n\n    err = err\n        .add(\n            mulUpXpToNpU(invariant, mulDenominator)\n                .mul(\n                    params.lambda\n                        .mul(params.lambda)\n                        .div(BigNumber.from(10).pow(36))\n                )\n                .mul(40)\n                .div(ONE_XP)\n        )\n        .add(1);\n\n    if (invariant.add(err).gt(MAX_INVARIANT))\n        throw new Error('MAX INVARIANT EXCEEDED');\n\n    return [invariant, err];\n}\n\nexport function calcOutGivenIn(\n    balances: BigNumber[],\n    amountIn: BigNumber,\n    tokenInIsToken0: boolean,\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    invariant: Vector2\n): BigNumber {\n    if (amountIn.lt(SMALL)) return BigNumber.from(0);\n\n    const ixIn = Number(!tokenInIsToken0);\n    const ixOut = Number(tokenInIsToken0);\n\n    const calcGiven = tokenInIsToken0 ? calcYGivenX : calcXGivenY;\n\n    const balInNew = balances[ixIn].add(amountIn);\n\n    checkAssetBounds(params, derived, invariant, balInNew, ixIn);\n    const balOutNew = calcGiven(balInNew, params, derived, invariant);\n    const amountOut = balances[ixOut].sub(balOutNew);\n    if (amountOut.lt(0)) {\n        // Should never happen; check anyways to catch a numerical bug.\n        throw new Error('ASSET BOUNDS EXCEEDED 1');\n    }\n\n    return amountOut;\n}\n\nexport function calcInGivenOut(\n    balances: BigNumber[],\n    amountOut: BigNumber,\n    tokenInIsToken0: boolean,\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    invariant: Vector2\n): BigNumber {\n    if (amountOut.lt(SMALL)) return BigNumber.from(0);\n\n    const ixIn = Number(!tokenInIsToken0);\n    const ixOut = Number(tokenInIsToken0);\n\n    const calcGiven = tokenInIsToken0 ? calcXGivenY : calcYGivenX;\n\n    if (amountOut.gt(balances[ixOut]))\n        throw new Error('ASSET BOUNDS EXCEEDED 2');\n    const balOutNew = balances[ixOut].sub(amountOut);\n\n    const balInNew = calcGiven(balOutNew, params, derived, invariant);\n    checkAssetBounds(params, derived, invariant, balInNew, ixIn);\n    const amountIn = balInNew.sub(balances[ixIn]);\n\n    if (amountIn.lt(0))\n        // Should never happen; check anyways to catch a numerical bug.\n        throw new Error('ASSET BOUNDS EXCEEDED 3');\n    return amountIn;\n}\n\nexport function calcSpotPriceAfterSwapOutGivenIn(\n    balances: BigNumber[],\n    amountIn: BigNumber,\n    tokenInIsToken0: boolean,\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    invariant: Vector2,\n    swapFee: BigNumber\n): BigNumber {\n    const ixIn = Number(!tokenInIsToken0);\n    const f = ONE.sub(swapFee);\n\n    const calcSpotPriceGiven = tokenInIsToken0\n        ? calcSpotPriceYGivenX\n        : calcSpotPriceXGivenY;\n\n    const balInNew = balances[ixIn].add(amountIn);\n    const newSpotPriceFactor = calcSpotPriceGiven(\n        balInNew,\n        params,\n        derived,\n        invariant\n    );\n    return divDown(ONE, mulDown(newSpotPriceFactor, f));\n}\n\nexport function calcSpotPriceAfterSwapInGivenOut(\n    balances: BigNumber[],\n    amountOut: BigNumber,\n    tokenInIsToken0: boolean,\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    invariant: Vector2,\n    swapFee: BigNumber\n): BigNumber {\n    const ixOut = Number(tokenInIsToken0);\n    const f = ONE.sub(swapFee);\n\n    const calcSpotPriceGiven = tokenInIsToken0\n        ? calcSpotPriceXGivenY\n        : calcSpotPriceYGivenX;\n\n    const balOutNew = balances[ixOut].sub(amountOut);\n    const newSpotPriceFactor = calcSpotPriceGiven(\n        balOutNew,\n        params,\n        derived,\n        invariant\n    );\n    return divDown(newSpotPriceFactor, f);\n}\n\nexport function calcDerivativePriceAfterSwapOutGivenIn(\n    balances: BigNumber[],\n    tokenInIsToken0: boolean,\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    invariant: Vector2,\n    swapFee: BigNumber\n): BigNumber {\n    const ixIn = Number(!tokenInIsToken0);\n\n    const newDerivativeSpotPriceFactor = ixIn\n        ? dPxDYIn(balances, params, derived, swapFee, invariant)\n        : dPyDXIn(balances, params, derived, swapFee, invariant);\n\n    return newDerivativeSpotPriceFactor;\n}\n\nexport function calcDerivativeSpotPriceAfterSwapInGivenOut(\n    balances: BigNumber[],\n    tokenInIsToken0: boolean,\n    params: GyroEParams,\n    derived: DerivedGyroEParams,\n    invariant: Vector2,\n    swapFee: BigNumber\n): BigNumber {\n    const ixIn = Number(!tokenInIsToken0);\n\n    const newDerivativeSpotPriceFactor = ixIn\n        ? dPxDXOut(balances, params, derived, swapFee, invariant)\n        : dPyDYOut(balances, params, derived, swapFee, invariant);\n\n    return newDerivativeSpotPriceFactor;\n}\n"],"names":["calculateNormalizedLiquidity","balances","params","derived","r","fee","tokenInIsToken0","normalizedLiquidityXIn","normalizedLiquidityYIn","calculateInvariantWithError","x","y","add","gt","MAX_BALANCES","Error","AtAChi","calcAtAChi","invariantResult","calcInvariantSqrt","square_root","err","divUpMagU","mul","sqrt","BigNumber","from","pow","mulUpMagU","lambda","div","ONE_XP","mulDenominator","divXpU","calcAChiAChiInXp","sub","invariant","mulDownXpToNpU","mulUpXpToNpU","MAX_INVARIANT","calcOutGivenIn","amountIn","lt","SMALL","ixIn","Number","ixOut","calcGiven","calcYGivenX","calcXGivenY","balInNew","checkAssetBounds","balOutNew","amountOut","calcInGivenOut","calcSpotPriceAfterSwapOutGivenIn","swapFee","f","ONE","newSpotPriceFactor","calcSpotPriceYGivenX","calcSpotPriceXGivenY","divDown","mulDown","calcSpotPriceAfterSwapInGivenOut","calcDerivativePriceAfterSwapOutGivenIn","dPxDYIn","dPyDXIn","calcDerivativeSpotPriceAfterSwapInGivenOut","dPxDXOut","dPyDYOut"],"mappings":"0vBAoCgB,SAAAA,EACZC,EACAC,EACAC,EACAC,EACAC,EACAC,GAEA,OAAIA,EACOC,EAAuBN,EAAUC,EAAQC,EAASE,EAAKD,GAEvDI,EAAuBP,EAAUC,EAAQC,EAASE,EAAKD,EAEtE,UAEgBK,EACZR,EACAC,EACAC,GAEA,MAAOO,EAAGC,GAAKV,EAEf,GAAIS,EAAEE,IAAID,GAAGE,GAAGC,GAAe,MAAM,IAAIC,MAAM,uBAC/C,MAAMC,EAASC,EAAWP,EAAGC,EAAGT,EAAQC,GAElCe,EAAkBC,EAAkBT,EAAGC,EAAGT,EAAQC,GAClDiB,EAAcF,EAAgB,GACpC,IAAIG,EAAMH,EAAgB,GAGtBG,EADAD,EAAYP,GAAG,GACTS,EAAUD,EAAIT,IAAI,GAAIQ,EAAYG,IAAI,IAEtCF,EAAIR,GAAG,GACPW,EAAKH,EAAKI,EAAUC,KAAK,IACzBD,EAAUC,KAAK,IAAIC,IAAI,GAGjCN,EAAMO,EAAU1B,EAAO2B,OAAQnB,EAAEE,IAAID,IAChCmB,IAAIC,GACJnB,IAAIS,GACJT,IAAI,GACJW,IAAI,IAET,MAAMS,EAAiBC,EACnBF,EACAG,EAAiBhC,EAAQC,GAASgC,IAAIJ,IAEpCK,EAAYC,EACdrB,EAAOJ,IAAIQ,GAAae,IAAId,GAC5BW,GAiBJ,GAfAX,EAAMiB,EAAajB,EAAKW,GAExBX,EAAMA,EACDT,IACG0B,EAAaF,EAAWJ,GACnBT,IACGrB,EAAO2B,OACFN,IAAIrB,EAAO2B,QACXC,IAAIL,EAAUC,KAAK,IAAIC,IAAI,MAEnCJ,IAAI,IACJO,IAAIC,IAEZnB,IAAI,GAELwB,EAAUxB,IAAIS,GAAKR,GAAG0B,GACtB,MAAM,IAAIxB,MAAM,0BAEpB,MAAO,CAACqB,EAAWf,EACvB,CAEgB,SAAAmB,EACZvC,EACAwC,EACAnC,EACAJ,EACAC,EACAiC,GAEA,GAAIK,EAASC,GAAGC,GAAQ,OAAOlB,EAAUC,KAAK,GAE9C,MAAMkB,EAAOC,QAAQvC,GACfwC,EAAQD,OAAOvC,GAEfyC,EAAYzC,EAAkB0C,EAAcC,EAE5CC,EAAWjD,EAAS2C,GAAMhC,IAAI6B,GAEpCU,EAAiBjD,EAAQC,EAASiC,EAAWc,EAAUN,GACvD,MAAMQ,EAAYL,EAAUG,EAAUhD,EAAQC,EAASiC,GACjDiB,EAAYpD,EAAS6C,GAAOX,IAAIiB,GACtC,GAAIC,EAAUX,GAAG,GAEb,MAAM,IAAI3B,MAAM,2BAGpB,OAAOsC,CACX,CAEgB,SAAAC,EACZrD,EACAoD,EACA/C,EACAJ,EACAC,EACAiC,GAEA,GAAIiB,EAAUX,GAAGC,GAAQ,OAAOlB,EAAUC,KAAK,GAE/C,MAAMkB,EAAOC,QAAQvC,GACfwC,EAAQD,OAAOvC,GAEfyC,EAAYzC,EAAkB2C,EAAcD,EAElD,GAAIK,EAAUxC,GAAGZ,EAAS6C,IACtB,MAAM,IAAI/B,MAAM,2BACpB,MAEMmC,EAAWH,EAFC9C,EAAS6C,GAAOX,IAAIkB,GAEAnD,EAAQC,EAASiC,GACvDe,EAAiBjD,EAAQC,EAASiC,EAAWc,EAAUN,GACvD,MAAMH,EAAWS,EAASf,IAAIlC,EAAS2C,IAEvC,GAAIH,EAASC,GAAG,GAEZ,MAAM,IAAI3B,MAAM,2BACpB,OAAO0B,CACX,CAEgB,SAAAc,EACZtD,EACAwC,EACAnC,EACAJ,EACAC,EACAiC,EACAoB,GAEA,MAAMZ,EAAOC,QAAQvC,GACfmD,EAAIC,EAAIvB,IAAIqB,GAOZG,GALqBrD,EACrBsD,EACAC,GAEW5D,EAAS2C,GAAMhC,IAAI6B,GAGhCvC,EACAC,EACAiC,GAEJ,OAAO0B,EAAQJ,EAAKK,EAAQJ,EAAoBF,GACpD,CAEgB,SAAAO,EACZ/D,EACAoD,EACA/C,EACAJ,EACAC,EACAiC,EACAoB,GAEA,MAAMV,EAAQD,OAAOvC,GACfmD,EAAIC,EAAIvB,IAAIqB,GAOZG,GALqBrD,EACrBuD,EACAD,GAEY3D,EAAS6C,GAAOX,IAAIkB,GAGlCnD,EACAC,EACAiC,GAEJ,OAAO0B,EAAQH,EAAoBF,EACvC,CAEgB,SAAAQ,EACZhE,EACAK,EACAJ,EACAC,EACAiC,EACAoB,GAQA,OANaX,QAAQvC,GAGf4D,EAAQjE,EAAUC,EAAQC,EAASqD,EAASpB,GAC5C+B,EAAQlE,EAAUC,EAAQC,EAASqD,EAASpB,EAGtD,CAEgB,SAAAgC,EACZnE,EACAK,EACAJ,EACAC,EACAiC,EACAoB,GAQA,OANaX,QAAQvC,GAGf+D,EAASpE,EAAUC,EAAQC,EAASqD,EAASpB,GAC7CkC,EAASrE,EAAUC,EAAQC,EAASqD,EAASpB,EAGvD"}